# バグ修正時の行動規範

このドキュメントは、バグ修正作業を行う際に必ず遵守すべき規範を定めたものである。
バグ修正を開始する前に、必ずこのドキュメントを読み込み、以下の規範に従って作業を行うこと。

## 1. 根本原因の特定を最優先する

### 禁止事項
- **場当たり的な修正の禁止**: 表面的な症状を解消するだけの修正を行ってはならない
- **推測に基づく修正の禁止**: 「おそらくこれが原因だろう」という推測だけで修正を行ってはならない
- **時間ベースの待機追加の禁止**: `setTimeout`、`sleep`、固定時間待機などを「安定させるため」という理由で追加してはならない

### 必須事項
- バグの再現条件を明確に特定する
- データフローを追跡し、どこで期待値と実際の値が乖離するかを特定する
- ログやデバッガを使用して、実際の実行パスと値を確認する
- 「なぜそうなるのか」を説明できるまで調査を続ける

## 2. フォールバックによる問題の隠蔽を禁止する

### 禁止事項
- **事前条件の不正をフォールバックで吸収することの禁止**: 事前条件が満たされていない場合、フォールバック値を返してテストを通すことは禁止
- **nullチェックの安易な追加禁止**: 「nullの場合は何もしない」というコードを、なぜnullになるかを調査せずに追加してはならない
- **try-catchによる例外の握りつぶし禁止**: 例外が発生する根本原因を調査せずに、catchで握りつぶしてはならない

### 必須事項
- 事前条件が満たされない場合は、**なぜ満たされないのか**を調査する
- フォールバックを追加する場合は、それが**設計上正当な理由**があることを説明できなければならない
- 予期しない状態の場合は、エラーを投げるか、明確なログを出力して問題を可視化する

## 3. 仮説の検証を徹底する

### 禁止事項
- **「テストが通った = 原因が正しかった」という短絡的結論の禁止**: テストが通っても、その修正が本当の原因を解決したとは限らない
- **副作用による解決の見落とし禁止**: 修正が意図しない副作用で問題を解決している可能性を常に考慮する
- **仮説を立てたらすぐに修正に着手することの禁止**: 仮説を立てたら、まずその仮説が正しいかを検証する方法を考える

### 必須事項

#### 仮説検証のプロセス
1. **仮説を明文化する**: 「〜が原因で〜が起きている」という形で仮説を明確に記述する
2. **仮説を検証する方法を考える**: 修正前に、その仮説が正しいことを確認するための検証方法を考える
3. **最小限の修正で検証する**: 仮説を検証するために、最小限の変更で効果を確認する
4. **修正後も仮説を疑う**: 修正後、以下の質問に答えられなければならない：
   - この修正がなぜ問題を解決するのか、論理的に説明できるか？
   - 他の原因が同時に解決されている可能性はないか？
   - この修正を元に戻したら、確実に問題が再発するか？

#### 検証の具体的手法
- 修正前後でログを比較し、期待通りのデータフローになっているか確認する
- 修正を一部だけ適用して、どの部分が効果的かを切り分ける
- 問題の再現テストを複数回実行し、統計的に有意な結果を得る

## 4. デバッグ用コードの管理を徹底する

### 禁止事項
- **デバッグ用コードの放置禁止**: 調査のために追加した関数、ログ出力、一時的な変数を放置してはならない
- **「後で消す」の禁止**: デバッグ用コードを「後で消す」つもりで残してはならない。調査が終わったら即座に削除する
- **検証用関数の本番コード混入禁止**: 検証のために一時的に追加した関数を、本番のロジックで使用してはならない

### 必須事項

#### デバッグコードの追跡
- デバッグ用コードを追加する際は、`[DEBUG]`プレフィックスや専用のコメントで明示的にマークする
- デバッグコードを追加したファイルと行番号を記録しておく
- 調査が完了したら、追加したデバッグコードを**全て**削除する

#### 検証用コードの扱い
- 検証用に追加した関数は、検証が終わったら即座に削除する
- 検証用関数が有用だと判断した場合は、正式な設計レビューを経て本番コードに組み込む
- 一時的な修正が効果的だった場合でも、それが正しい解決策かを再評価する

## 5. 修正方法の複数案検討を必須とする

### 禁止事項
- **原因特定後の即座のコーディング禁止**: 原因が分かった後に、修正方法を深く検討せずにすぐにコードを書き始めてはならない
- **最初に思いついた方法での修正禁止**: 最初に思いついた修正方法が最善とは限らない。必ず複数の選択肢を検討する
- **修正方法の比較検討なしの実装禁止**: 複数案のPros/Consを比較せずに修正を開始してはならない

### 必須事項

#### 修正方法検討のプロセス
1. **複数の修正案を列挙する**: 最低2つ以上の修正方法を考える
2. **各案のPros/Consを明確にする**: それぞれの修正方法の長所と短所を書き出す
3. **「あるべき姿」を基準に評価する**: 修正後のコードが設計として正しい状態になるかを評価する
4. **最善の方法を選択する**: Pros/Consを踏まえて、最も適切な修正方法を選択する

#### 検討すべき観点
- この修正は根本的な解決か、それとも対症療法か？
- 修正後のコードは、バグがなかったとしたら書いたであろうコードになっているか？
- 将来の拡張性や保守性に問題はないか？
- 同様のバグが他の箇所で発生する可能性はないか？その場合、より広範な修正が必要ではないか？

## 6. 修正範囲の大きさを恐れない

### 禁止事項
- **修正範囲を理由にした妥協の禁止**: 「影響範囲が大きくなるから」という理由で、中途半端な修正を選択してはならない
- **ユーザー確認なしの回避禁止**: 根本的な修正が必要だと分かっているのに、ユーザーに確認せずに小さな修正で済ませてはならない
- **編集範囲をマイナス要素として評価することの禁止**: 複数案を比較する際、編集範囲の大きさをマイナス要素として考えてはならない

### 必須事項

#### 修正範囲に関する原則
- バグの根本原因を修正し、コードを「あるべき姿」にすることが最優先
- 影響範囲が大きくなることは、正しい修正を行うための必要なコストである
- 全体設計を見直す必要がある場合は、それを避けずに正面から取り組む

#### 大規模な修正が必要な場合のプロセス
1. **修正の必要性を明確にする**: なぜ大規模な修正が必要なのかを説明できるようにする
2. **設計方針をユーザーに確認する**: 根本的な書き換えが必要な場合は、その設計方針についてユーザーの承認を得る
3. **段階的に実装する**: 大規模な修正を適切な単位に分割して実装する
4. **各段階でテストを実行する**: 修正の各段階でテストが通ることを確認する

#### 禁止される判断パターン
- 「この修正は大きすぎるから、とりあえずこの範囲だけ直そう」
- 「全部直すと時間がかかるから、最小限の修正にしよう」
- 「他の部分に影響が出るから、ここだけ特別な処理を入れよう」

## 7. バグ修正の完了条件

バグ修正が完了したと言えるのは、以下の全ての条件を満たした場合のみである：

1. **根本原因の特定**: バグの根本原因を明確に特定し、説明できる
2. **複数案の検討**: 複数の修正方法を検討し、Pros/Consを比較した上で最善の方法を選択した
3. **修正の妥当性**: その修正がなぜ問題を解決するのか、論理的に説明できる
4. **あるべき姿の実現**: 修正後のコードが「バグがなかったとしたら書いたであろうコード」になっている
5. **回帰テストの成功**: 修正後、関連するテストが全て成功する
6. **副作用の確認**: 修正が他の機能に悪影響を与えていないことを確認する
7. **デバッグコードの除去**: 調査のために追加したコードが全て削除されている
8. **コードの清潔さ**: 不要なフォールバック、一時的な修正、コメントアウトされたコードが残っていない

## 8. バグ修正時のチェックリスト

バグ修正作業を行う前に、以下のチェックリストを確認すること：

### 調査フェーズ
- [ ] バグの再現手順を明確にしたか？
- [ ] ログやデバッガを使用して実際の動作を確認したか？
- [ ] データフローを追跡して、どこで問題が発生しているか特定したか？
- [ ] 「なぜそうなるのか」を説明できるか？

### 仮説フェーズ
- [ ] 仮説を明文化したか？
- [ ] 仮説を検証する方法を考えたか？
- [ ] 場当たり的な修正ではなく、根本原因に対する修正か？

### 修正方法検討フェーズ
- [ ] 複数の修正案（最低2つ以上）を列挙したか？
- [ ] 各案のPros/Consを明確にしたか？
- [ ] 修正後のコードが「あるべき姿」になるかを評価したか？
- [ ] 編集範囲の大きさをマイナス要素として考えずに評価したか？
- [ ] 同様のバグが他の箇所で発生する可能性を検討したか？

### 修正フェーズ
- [ ] 根本原因に対する修正か（対症療法ではないか）？
- [ ] フォールバックで問題を隠蔽していないか？
- [ ] 固定時間待機を追加していないか？
- [ ] 修正範囲が大きくなることを理由に妥協していないか？
- [ ] 大規模な修正が必要な場合、ユーザーに設計方針を確認したか？

### 検証フェーズ
- [ ] 修正がなぜ問題を解決するのか論理的に説明できるか？
- [ ] 修正を元に戻したら問題が再発することを確認したか？
- [ ] 他の副作用で解決されている可能性を排除したか？
- [ ] 統計的に有意な回数のテストを実行したか？

### 完了フェーズ
- [ ] デバッグ用コードを全て削除したか？
- [ ] 不要なフォールバックや一時的なコードが残っていないか？
- [ ] コードがクリーンな状態か？
- [ ] 修正後のコードは「バグがなかったとしたら書いたであろうコード」になっているか？

---

**このドキュメントに記載された規範に従わないバグ修正は、たとえテストが通っても完了とは認められない。**
