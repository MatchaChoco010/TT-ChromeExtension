# Requirements Document

## Project Description (Input)
現状の拡張機能をインストールして動作確認をしてみました。
以下の点が気になるのでそれらを修正するタスクを作ってください。

### 未だに余計なLoadingタブが存在する
ブラウザを閉じて開くと、前回開いていたタブが削除不能のLoadingタブとして残り続けて増殖します。
実行すると本来のタブではないLoadingタブが謎に存在していることが確認できます。
ブラウザを閉じて開き直して前回と全く同じ数で同じタイトルのタブが復元されることを確認できるまで修正しなさい。

### タブタイトルのフォントサイズが変わらない
設定画面でフォントサイズを変えてもタブのタイトルのフォントサイズが変わりません。
矢印などのフォントサイズは変わっていますが、タイトルのテキストも変わるように修正しなさい。

### ブラウザを開き直したときにファビコンが復元されない
ファビコンもタイトル文字列と同様に永続化して、ブラウザを開き直したときに復元されるように修正しなさい。
また、その永続化した内容はファビコンが更新されたら即座に上書きする必要があります。

### まだ読み込んでいない休止タブをわかるようにしたい
休止タブはタイトルをグレーアウトするなどして、まだ読み込んでいないことがわかるように修正しなさい。

### 新しいタブのスタートタブのタイトルがおかしい
新しいタブのスタートタブのタイトルがchrome://cicaldi-webui/startpageなどになっておりスタートタブというタイトルではありません。

### ツリータブ上の文字列が選択できてしまう
文字列の選択は必要ありません。
Shiftクリックなどで複数選択しようとしたら文字列まで選択されました。
文字列の選択がなされないようにCSSなどを修正しなさい。

### 複数タブをグループ化の機能が動いていない
複数タブを選択してグループ化をコンテキストメニューから選んでもグループ化用の親タブが追加されません。
修正しなさい。

### シングルタブをグループに追加の機能が動いていない
タブを右クリックしてコンテキストメニューからシングルタブをグループに追加を選んでも何も起こりません。
修正しなさい。

### タブとタブの隙間のプレースホルダーの表示位置がおかしい
複数タブを開いて上の方にあるタブをドラッグするとただしいタブとタブの隙間以外にもプレースホルダーが表示されたりして正しい位置にプレースホルダーが表示されていない。

### タブとタブの隙間にドロップしたときの挙動がおかしい
タブとタブの隙間にドロップするプレースホルダーは表示されるようになりました。
しかし、ドロップしてもそのプレースホルダーの位置にタブが挿入されません。

### タブをドラッグしたときにツリービューが必要以上にスクロールする
ツリービューのスクロール範囲はタブが並んでいてツリー自体がツリービューのサイズを超えている場合に、その超えた量をスクロールするだけです。
dnd-kitのデフォルトの機能かわからないが、ドラッグすると右にも下にも必要以上にスクロールし続けながらドラッグできてしまう。

### ツリービューの外にドロップできない
ツリービューの外にドラッグしても新しいウィンドウが開いてそちらにタブが映るという挙動が実装されていません。
ツリーの外にドラッグしながらマウスを持っていってもツリービュー内にタブのドロップ先のプレビューがありますが、このdnd-kitの標準のドロップ検知ではツリービューの外へのドロップが検知できないかもしれません。
ツリービューの外へドロップしたというのを確実に検知するロジックを作りなさい。

### 現在のタブがピン留めタブの場合のハイライトがおかしい
現在のタブのハイライトが通常タブでしか動いていません。
ピン留めしたタブに移動しても通常タブのハイライトが解除されないのと、ピン留めタブがハイライトされない挙動を修正しなさい。

### ピン留めしたタブの並び替えができない
ピン留めしたタブ自体をドラッグアンドドロップで並び替えできるようにしなさい。

### 永続化されたタブの名前が更新されない
タブの中のページ遷移やそれ以外のタブタイトルの変更をタブのタイトルの永続化する内容の更新に反映しなさい。
そうしないと、タブを開いたあとリンクを辿ってページを切り替えたあとにブラウザを閉じて立ち上げ直したときに復元されるタイトル名がズレてしまいます。

### 複数ウィンドウの対応が間違っている
複数ウィンドウを開いてもタブツリーに全てのウィンドウのタブが表示されてしまっている。
各ウィンドウごとにタブツリーの内容が分離されるように修正しなさい。
ちゃんとそういう挙動になっていることが確認できるまで修正を行いなさい。


## Introduction

本ドキュメントは、Vivaldi-TT拡張機能における複数のバグ修正と機能改善の要件を定義します。ブラウザ再起動時のタブ状態復元、ドラッグ＆ドロップ操作の挙動、UIスタイルの一貫性、および複数ウィンドウ対応に関する問題を解決することを目的としています。

**リグレッション防止方針**: 今回修正するすべての機能について、E2Eテストが可能なものは可能な限りE2Eテストで確認し、今後のリグレッションを検知できるようにします。

## Requirements

### Requirement 1: タブ状態の永続化と復元

**Objective:** ユーザーとして、ブラウザを再起動しても前回のタブ状態が正確に復元されることを望む。これにより、作業の継続性が保たれる。

#### Acceptance Criteria
1. When ブラウザが起動した時, the Tab Tree Extension shall 前回保存されたタブ情報（タイトル、ファビコン、ツリー構造）を正確に復元する
2. When ブラウザが起動した時, the Tab Tree Extension shall 実際に存在するブラウザタブと同数のタブノードをツリーに表示する（余分な「Loading」タブを生成しない）
3. When タブのタイトルが変更された時, the Tab Tree Extension shall 永続化データを即座に更新する
4. When タブのファビコンが変更された時, the Tab Tree Extension shall 永続化データを即座に更新する
5. If 永続化データに存在するタブIDが実際のブラウザタブと一致しない場合, then the Tab Tree Extension shall 不整合なエントリを削除し、現在のブラウザタブのみを表示する

#### Test Requirements
- E2Eテストにより、タブ数・タイトル・ファビコンが正確に保存・復元されることを検証する
- E2Eテストにより、余分な「Loading」タブが生成されないことを検証する
- E2Eテストにより、永続化データと実際のブラウザタブの整合性が保たれることを検証する

### Requirement 2: UI表示の一貫性

**Objective:** ユーザーとして、設定で指定したフォントサイズが全てのUI要素に適用されること、およびタブの状態が視覚的に明確であることを望む。

#### Acceptance Criteria
1. When ユーザーが設定画面でフォントサイズを変更した時, the Tab Tree Extension shall タブタイトルのフォントサイズを設定値に応じて変更する
2. When 新しいタブ（スタートページ）が開かれた時, the Tab Tree Extension shall URLではなく「スタートページ」または適切なローカライズされたタイトルを表示する

#### Test Requirements
- E2Eテストにより、フォントサイズ設定がタブタイトルに反映されることを検証する
- E2Eテストにより、スタートページのタイトルがURL表示ではなく適切なタイトルで表示されることを検証する

### Requirement 3: 休止タブの視覚的区別

**Objective:** ユーザーとして、まだ読み込まれていない休止状態のタブを視覚的に識別できることを望む。

#### Acceptance Criteria
1. While タブが休止状態（discarded）である時, the Tab Tree Extension shall タブタイトルをグレーアウト表示する
2. When 休止タブがアクティブ化されて読み込みが開始された時, the Tab Tree Extension shall グレーアウト表示を解除する

#### Test Requirements
- E2Eテストにより、休止状態のタブがグレーアウト表示されることを検証する
- E2Eテストにより、休止タブがアクティブ化された際にグレーアウトが解除されることを検証する

### Requirement 4: テキスト選択の禁止

**Objective:** ユーザーとして、Shift+クリックでの複数タブ選択時に意図しないテキスト選択が発生しないことを望む。

#### Acceptance Criteria
1. The Tab Tree Extension shall ツリービュー内の全てのテキスト要素をユーザー選択不可（user-select: none）に設定する
2. When ユーザーがShift+クリックで複数タブを選択した時, the Tab Tree Extension shall テキストの選択状態を発生させない

#### Test Requirements
- E2Eテストにより、Shift+クリックでの複数タブ選択時にテキストが選択されないことを検証する
- E2Eテストにより、ツリービュー内のテキストがドラッグ選択できないことを検証する

### Requirement 5: アクティブタブのハイライト

**Objective:** ユーザーとして、現在アクティブなタブを通常タブ・ピン留めタブ問わず視覚的に識別できることを望む。

#### Acceptance Criteria
1. When 通常タブがアクティブになった時, the Tab Tree Extension shall 該当タブのみをハイライト表示し、ピン留めタブを含む他の全てのタブのハイライトを解除する
2. When ピン留めタブがアクティブになった時, the Tab Tree Extension shall 該当ピン留めタブのみをハイライト表示し、通常タブを含む他の全てのタブのハイライトを解除する
3. When アクティブタブが切り替わった時, the Tab Tree Extension shall 前のアクティブタブのハイライトを即座に解除する
4. The Tab Tree Extension shall 常に1つのタブのみがハイライト状態となることを保証する

#### Test Requirements
- E2Eテストにより、通常タブがアクティブになった時に該当タブのみがハイライトされることを検証する
- E2Eテストにより、ピン留めタブがアクティブになった時に該当ピン留めタブのみがハイライトされ、通常タブのハイライトが解除されることを検証する
- E2Eテストにより、通常タブとピン留めタブ間でアクティブタブを切り替えた際に、常に1つのタブのみがハイライト状態であることを検証する

### Requirement 6: ドラッグ＆ドロップ操作 - プレースホルダー表示

**Objective:** ユーザーとして、タブをドラッグ中にドロップ先が正確に視覚的にフィードバックされることを望む。

#### Acceptance Criteria
1. When タブをドラッグしている時, the Tab Tree Extension shall 有効なドロップ位置（タブとタブの隙間）にのみプレースホルダーを表示する
2. When タブをドラッグしている時, the Tab Tree Extension shall ドロップターゲットとなるタブをハイライト表示する（タブの子として挿入する場合）
3. The Tab Tree Extension shall プレースホルダーの位置が実際のドロップ位置と一致することを保証する

#### Test Requirements
- E2Eテストにより、ドラッグ中のプレースホルダーが正しいタブ間の位置に表示されることを検証する
- E2Eテストにより、ホバー中のタブが適切にハイライトされることを検証する
- E2Eテストにより、プレースホルダーの位置が視覚的に正しい位置にあることを検証し、テストが通過するまで修正を行う
- E2Eテストにより、不正な位置（タブとタブの隙間以外）にプレースホルダーが表示されないことを検証する

### Requirement 7: ドラッグ＆ドロップ操作 - ドロップ処理

**Objective:** ユーザーとして、タブをドロップした際にプレースホルダーで示された位置に正確に挿入されることを望む。

#### Acceptance Criteria
1. When タブをタブとタブの隙間にドロップした時, the Tab Tree Extension shall タブをプレースホルダーが表示されていた正確な位置に挿入する
2. When タブをドロップした時, the Tab Tree Extension shall ツリー構造とブラウザタブの順序を同期する

#### Test Requirements
- E2Eテストにより、タブをドロップした位置にタブが正確に挿入されることを検証する
- E2Eテストにより、ドロップ後のツリー構造がブラウザタブの順序と同期していることを検証する

### Requirement 8: ドラッグ＆ドロップ操作 - スクロール制限

**Objective:** ユーザーとして、ドラッグ中にツリービューが必要以上にスクロールしないことを望む。

#### Acceptance Criteria
1. While タブをドラッグしている時, the Tab Tree Extension shall ツリービューの縦スクロールをコンテンツ範囲内に制限する
2. While タブをドラッグしている時, the Tab Tree Extension shall ツリービューの横スクロールを禁止する（水平方向への過剰スクロールを防止する）
3. The Tab Tree Extension shall ドラッグ中のスクロールはツリーコンテンツがビューポートを超えている場合のみ許可する

#### Test Requirements
- E2Eテストにより、ドラッグ中にツリービューが必要以上に縦スクロールしないことを検証する
- E2Eテストにより、ドラッグ中に横スクロールが発生しないことを検証する

### Requirement 9: ツリービュー外へのドラッグ＆ドロップ

**Objective:** ユーザーとして、タブをツリービューの外にドロップして新しいウィンドウを作成できることを望む。

#### Acceptance Criteria
1. When タブをツリービューの外にドラッグした時, the Tab Tree Extension shall ツリービュー外へのドラッグを検知する
2. When タブをツリービューの外でドロップした時, the Tab Tree Extension shall 新しいブラウザウィンドウを作成する
3. When タブをツリービューの外でドロップした時, the Tab Tree Extension shall ドロップしたタブ（およびサブツリー）を新しいウィンドウに移動する
4. The Tab Tree Extension shall dnd-kit標準のドロップ検知に依存せず、マウス位置によるツリービュー外へのドロップを確実に検知する

#### Test Requirements
- E2Eテストにより、タブをツリービュー外にドロップした際に新しいウィンドウが作成されることを検証する
- E2Eテストにより、ドロップしたタブが新しいウィンドウに正確に移動されることを検証する

### Requirement 10: ピン留めタブの並び替え

**Objective:** ユーザーとして、ピン留めタブの順序をドラッグ＆ドロップで変更できることを望む。

#### Acceptance Criteria
1. When ピン留めタブをドラッグした時, the Tab Tree Extension shall ピン留めタブセクション内でのドラッグを許可する
2. When ピン留めタブを他のピン留めタブの位置にドロップした時, the Tab Tree Extension shall ピン留めタブの順序を変更する
3. When ピン留めタブの順序が変更された時, the Tab Tree Extension shall ブラウザのピン留めタブ順序と同期する
4. The Tab Tree Extension shall ピン留めタブを通常タブセクションにドロップすることを禁止する

#### Test Requirements
- E2Eテストにより、ピン留めタブをドラッグ＆ドロップで並び替えできることを検証する
- E2Eテストにより、並び替え後のピン留めタブ順序がブラウザと同期していることを検証する
- E2Eテストにより、ピン留めタブを通常タブセクションにドロップできないことを検証する

### Requirement 11: タブグループ化機能

**Objective:** ユーザーとして、複数のタブをグループ化したり、既存のグループにタブを追加できることを望む。

#### Acceptance Criteria
1. When ユーザーが複数タブを選択してコンテキストメニューから「グループ化」を選択した時, the Tab Tree Extension shall 拡張機能専用のグループ親タブを新規作成し、選択したタブをその子として配置する
2. When グループ親タブが作成された時, the Tab Tree Extension shall グループ親タブを通常のブラウザタブとは異なる専用のタブとして表示する
3. When ユーザーが単一タブのコンテキストメニューから「グループに追加」を選択した時, the Tab Tree Extension shall 利用可能なグループ一覧を表示する
4. When ユーザーがグループ一覧から対象グループを選択した時, the Tab Tree Extension shall 選択されたグループの子としてタブを移動する

#### Test Requirements
- E2Eテストにより、複数タブを選択してグループ化した際にグループ親タブが作成されることを検証する
- E2Eテストにより、グループ親タブが専用のタブとして表示されることを検証する
- E2Eテストにより、単一タブをグループに追加できることを検証する

### Requirement 12: 複数ウィンドウ対応

**Objective:** ユーザーとして、各ブラウザウィンドウで独立したタブツリーを使用できることを望む。

#### Acceptance Criteria
1. The Tab Tree Extension shall 各ブラウザウィンドウに対して独立したタブツリーを表示する
2. When 新しいウィンドウが開かれた時, the Tab Tree Extension shall そのウィンドウに属するタブのみをタブツリーに表示する
3. If 複数ウィンドウが開かれている場合, then the Tab Tree Extension shall 各ウィンドウのサイドパネルで自ウィンドウのタブのみを表示する（他ウィンドウのタブは表示しない）

#### Test Requirements
- E2Eテストにより、複数ウィンドウを開いた際に各ウィンドウで独立したタブツリーが表示されることを検証する
- E2Eテストにより、あるウィンドウのタブが他のウィンドウのタブツリーに表示されないことを検証する
