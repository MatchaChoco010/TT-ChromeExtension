# Implementation Plan

## タスク概要

本タスクリストは、Vivaldi-TT拡張機能における複数のバグ修正と機能改善を実装するためのものです。

---

## 1. 複数ウィンドウ対応の修正

- [x] 1.1 (P) ウィンドウIDによるタブフィルタリングの実装
  - TreeStateProviderでchrome.windows.getCurrent()を呼び出してcurrentWindowIdを取得する
  - タブツリーの表示を現在のウィンドウのタブのみにフィルタリングする
  - ウィンドウIDの変更を監視し、状態を更新する
  - _Requirements: 12.1, 12.2, 12.3_

- [x] 1.2 複数ウィンドウ対応のE2Eテスト
  - 複数ウィンドウを開いた際に各ウィンドウで独立したタブツリーが表示されることを検証
  - あるウィンドウのタブが他のウィンドウのタブツリーに表示されないことを検証
  - _Requirements: 12.1, 12.2, 12.3_

## 2. タブ状態の永続化と復元

- [x] 2.1 (P) ファビコン永続化機能の追加
  - StorageServiceにTAB_FAVICONSキーを追加してファビコンURLを永続化する
  - タブのファビコンが変更された際に永続化データを即座に更新する
  - ブラウザ起動時に永続化されたファビコンを復元する
  - _Requirements: 1.1, 1.4_

- [x] 2.2 (P) タブタイトルの永続化更新の修正
  - タブ内でのページ遷移時にタイトルの永続化データを更新する
  - タブタイトル変更イベントを適切にハンドリングする
  - _Requirements: 1.3_

- [x] 2.3 余分なLoadingタブの防止
  - handleTabUpdatedでchangeInfo.status条件を追加し、不要なタブノード生成を防止する
  - 永続化データに存在するタブIDが実際のブラウザタブと一致しない場合に不整合エントリを削除する
  - ブラウザ再起動後にタブ数が正確に復元されることを確認する
  - _Requirements: 1.2, 1.5_

- [x] 2.4 タブ永続化のE2Eテスト
  - タブ数・タイトル・ファビコンが正確に保存・復元されることを検証
  - 余分なLoadingタブが生成されないことを検証
  - 永続化データと実際のブラウザタブの整合性が保たれることを検証
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

## 3. UI表示の一貫性

- [x] 3.1 (P) タブタイトルへのフォントサイズ反映
  - text-smクラスを削除し、CSS変数var(--font-size)をタブタイトルに適用する
  - 設定画面でフォントサイズを変更した際にタブタイトルのサイズが反映されることを確認する
  - _Requirements: 2.1_

- [x] 3.2 (P) スタートページタイトルの修正
  - getDisplayTitle()ロジックを修正してchrome://vivaldi-webui/startpage等のURLを適切なタイトルに変換する
  - 新しいタブのスタートページが「スタートページ」として表示されることを確認する
  - _Requirements: 2.2_

- [x] 3.3 UI表示のE2Eテスト
  - フォントサイズ設定がタブタイトルに反映されることを検証
  - スタートページのタイトルがURL表示ではなく適切なタイトルで表示されることを検証
  - _Requirements: 2.1, 2.2_

## 4. 休止タブの視覚的区別

- [x] 4.1 (P) 休止タブのグレーアウト表示
  - ExtendedTabInfoにdiscardedフラグを追加する
  - discardedタブのタイトルにグレーアウトスタイルを適用する
  - 休止タブがアクティブ化されて読み込みが開始された際にグレーアウトを解除する
  - _Requirements: 3.1, 3.2_

- [x] 4.2 休止タブのE2Eテスト
  - 休止状態のタブがグレーアウト表示されることを検証
  - 休止タブがアクティブ化された際にグレーアウトが解除されることを検証
  - _Requirements: 3.1, 3.2_

## 5. テキスト選択の禁止

- [x] 5.1 (P) ツリービュー内のテキスト選択禁止
  - select-noneクラスをタブノード要素およびツリービュー全体に追加する
  - Shift+クリックでの複数タブ選択時にテキスト選択が発生しないことを確認する
  - _Requirements: 4.1, 4.2_

- [x] 5.2 テキスト選択禁止のE2Eテスト
  - Shift+クリックでの複数タブ選択時にテキストが選択されないことを検証
  - ツリービュー内のテキストがドラッグ選択できないことを検証
  - _Requirements: 4.1, 4.2_

## 6. アクティブタブのハイライト修正

- [x] 6.1 (P) ピン留めタブを含むアクティブタブハイライトの統一
  - PinnedTabsSectionにactiveTabId propを追加し、アクティブ時のスタイルを適用する
  - 通常タブがアクティブになった時にピン留めタブを含む他全てのタブのハイライトを解除する
  - ピン留めタブがアクティブになった時に該当ピン留めタブのみをハイライト表示する
  - 常に1つのタブのみがハイライト状態となることを保証する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 6.2 アクティブタブハイライトのE2Eテスト
  - 通常タブがアクティブになった時に該当タブのみがハイライトされることを検証
  - ピン留めタブがアクティブになった時に該当ピン留めタブのみがハイライトされ、通常タブのハイライトが解除されることを検証
  - 通常タブとピン留めタブ間でアクティブタブを切り替えた際に、常に1つのタブのみがハイライト状態であることを検証
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

## 7. ドラッグ＆ドロップ - プレースホルダー表示

- [x] 7.1 プレースホルダー位置計算の修正
  - GapDropDetectionのcalculateDropTargetでスクロールオフセットを考慮したマウスY座標計算に修正する
  - 有効なドロップ位置（タブとタブの隙間）にのみプレースホルダーを表示する
  - コンテナ境界外の場合はNoneを返すよう修正する
  - プレースホルダーの位置が実際のドロップ位置と一致することを保証する
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 7.2 プレースホルダー表示のE2Eテスト
  - ドラッグ中のプレースホルダーが正しいタブ間の位置に表示されることを検証
  - ホバー中のタブが適切にハイライトされることを検証
  - 不正な位置にプレースホルダーが表示されないことを検証
  - _Requirements: 6.1, 6.2, 6.3_

## 8. ドラッグ＆ドロップ - ドロップ処理

- [x] 8.1 ドロップ位置への正確な挿入
  - handleSiblingDropを修正し、プレースホルダーが表示されていた正確な位置にタブを挿入する
  - ツリー構造とブラウザタブの順序を同期する
  - _Requirements: 7.1, 7.2_

- [x] 8.2 ドロップ処理のE2Eテスト
  - タブをドロップした位置にタブが正確に挿入されることを検証
  - ドロップ後のツリー構造がブラウザタブの順序と同期していることを検証
  - _Requirements: 7.1, 7.2_

## 9. ドラッグ＆ドロップ - スクロール制限

- [x] 9.1 ドラッグ中のスクロール範囲制限
  - dnd-kitのautoScroll設定を調整してスクロール範囲をコンテンツ範囲内に制限する
  - ドラッグ中の横スクロールを禁止する
  - ツリーコンテンツがビューポートを超えている場合のみスクロールを許可する
  - _Requirements: 8.1, 8.2, 8.3_

- [x] 9.2 スクロール制限のE2Eテスト
  - ドラッグ中にツリービューが必要以上に縦スクロールしないことを検証
  - ドラッグ中に横スクロールが発生しないことを検証
  - _Requirements: 8.1, 8.2, 8.3_

## 10. ツリービュー外へのドラッグ＆ドロップ

- [x] 10.1 ツリービュー外へのドロップ検知
  - isOutsideTree状態を追加し、onDragMoveでマウス位置を追跡する
  - dnd-kit標準のドロップ検知に依存せず、マウス位置によるツリービュー外へのドロップを検知するロジックを実装する
  - _Requirements: 9.1, 9.4_

- [x] 10.2 ツリービュー外へのドロップ処理
  - ツリービュー外でドロップした際に新しいブラウザウィンドウを作成する
  - ドロップしたタブ（およびサブツリー）を新しいウィンドウに移動する
  - _Requirements: 9.2, 9.3_

- [x] 10.3 ツリー外ドロップのE2Eテスト
  - タブをツリービュー外にドロップした際に新しいウィンドウが作成されることを検証
  - ドロップしたタブが新しいウィンドウに正確に移動されることを検証
  - _Requirements: 9.1, 9.2, 9.3, 9.4_

## 11. ピン留めタブの並び替え

- [x] 11.1 ピン留めタブのドラッグ＆ドロップ並び替え
  - PinnedTabsSectionにdnd-kitのSortableContextを追加してドラッグ並び替えを有効化する
  - ドロップ時にchrome.tabs.move()でブラウザのピン留めタブ順序を同期する
  - ピン留めセクション外へのドロップを禁止する
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [x] 11.2 ピン留めタブ並び替えのE2Eテスト
  - ピン留めタブをドラッグ＆ドロップで並び替えできることを検証
  - 並び替え後のピン留めタブ順序がブラウザと同期していることを検証
  - ピン留めタブを通常タブセクションにドロップできないことを検証
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

## 12. タブグループ化機能の修正

- [x] 12.1 複数タブのグループ化機能の修正
  - handleCreateGroupのレスポンス処理を確認し、グループ親タブが確実に作成されるよう修正する
  - 選択したタブをグループ親タブの子として配置する
  - グループ親タブが通常のブラウザタブとは異なる専用のタブとして表示されることを確認する
  - _Requirements: 11.1, 11.2_

- [x] 12.2 シングルタブのグループ追加機能の修正
  - 「グループに追加」選択時にグループ一覧サブメニューを表示する
  - グループ選択後に対象タブをグループの子として移動する
  - 利用可能なグループがない場合はメニュー項目を無効化する
  - _Requirements: 11.3, 11.4_

- [x] 12.3 グループ化機能のE2Eテスト
  - 複数タブを選択してグループ化した際にグループ親タブが作成されることを検証
  - グループ親タブが専用のタブとして表示されることを検証
  - 単一タブをグループに追加できることを検証
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

## 13. 既存E2Eテストのセレクタ修正

- [x] 13.1 (P) タブタイトルセレクタの修正（error-handling.spec.ts）
  - `span.text-sm`セレクタをタスク3.1で変更されたCSS変数適用後の適切なセレクタに修正する
  - 長いタブタイトルと無効なURLのタブのテストが正しく動作することを確認する
  - _Requirements: 2.1_

- [x] 13.2 (P) Side PanelURL検証の修正（extension-fixture.spec.ts）
  - Side PanelのURL検証をwindowIdパラメータを含む形式に対応するよう修正する
  - URLの検証を完全一致からパターンマッチまたはパス部分のみの検証に変更する
  - _Requirements: 12.1, 12.2, 12.3_

- [x] 13.3 (P) グループ追加メニュー項目のセレクタ修正（context-menu.spec.ts）
  - コンテキストメニューの「グループに追加」検証ロジックを実装に合わせて修正する
  - サブメニュー表示時のグループ一覧検出を正しく行えるよう修正する
  - _Requirements: 11.3, 11.4_

## 14. フレーキーE2Eテストの修正

- [x] 14.1 (P) プレースホルダー移動テストの安定化（drag-drop-placeholder.spec.ts）
  - 「マウスを別の隙間に移動するとプレースホルダーも移動すること」テストのフレーキー原因を調査する
  - 固定時間待機（waitForTimeout）をポーリングベースの待機に置き換える
  - ドラッグ中のプレースホルダー位置変更をポーリングで確実に検知する
  - 10回連続でテストが通過することを確認する
  - _Requirements: 6.3_

- [x] 14.2 (P) タイトル永続化更新テストの安定化（tab-persistence.spec.ts）
  - 「タブ内でのページ遷移時にタイトルの永続化データが更新されること」テストのフレーキー原因を調査する
  - ページ遷移完了の検知をポーリングで確実に行う
  - タイトル更新の永続化をポーリングで確実に検知する
  - 10回連続でテストが通過することを確認する
  - _Requirements: 1.3_

## 15. E2Eテスト全体のフレーキー修正（25回連続実行検証）

- [x] 15.1 E2Eテスト25回連続実行とフレーキーテストの特定
  - 全E2Eテストを25回連続で実行し、失敗するテストを特定する
  - 失敗したテストのエラーメッセージとスタックトレースを収集する
  - 失敗頻度とパターンを分析してフレーキーの原因を調査する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 7.1, 7.2, 8.1, 8.2, 8.3, 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4, 11.1, 11.2, 11.3, 11.4, 12.1, 12.2, 12.3_

- [x] 15.2 フレーキーテストの修正（反復実行）
  - 特定されたフレーキーテストを片っ端から修正する
  - 固定時間待機（waitForTimeout）をポーリングベースの待機に置き換える
  - タイミング依存のアサーションをexpect.toPass()やポーリングユーティリティで安定化する
  - 各修正後に個別テストを10回連続で実行して安定性を確認する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 7.1, 7.2, 8.1, 8.2, 8.3, 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4, 11.1, 11.2, 11.3, 11.4, 12.1, 12.2, 12.3_

- [x] 15.3 最終検証（25回連続全テスト実行）
  - すべてのE2Eテストを25回連続で実行する
  - 全321テストが25回すべて成功することを確認する
  - 1件でも失敗があれば15.2に戻って修正を続ける
  - 完了条件：25回連続実行で失敗0件
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 7.1, 7.2, 8.1, 8.2, 8.3, 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4, 11.1, 11.2, 11.3, 11.4, 12.1, 12.2, 12.3_

## 16. フレーキーE2Eテストの再修正と25回連続実行検証

- [x] 16.1 報告されたフレーキーテストの修正
  - drag-drop-hierarchy.spec.ts:298「深い階層のタブを別の親にドロップした場合、depthが正しく再計算されること」テストの安定化
  - drag-drop-insert.spec.ts:412「子タブとして配置した場合も順序が正しく同期されること」テストの安定化
  - drag-drop-placeholder.spec.ts:99「タブとタブの隙間にドラッグするとプレースホルダーが表示されること」テストの安定化
  - drag-drop-placeholder.spec.ts:327「マウスを別の隙間に移動するとプレースホルダーも移動すること」テストの安定化
  - tab-persistence.spec.ts:201「タブ内でのページ遷移時にタイトルの永続化データが更新されること」テストの安定化
  - フレーキーの原因を調査し、固定時間待機をポーリングに置き換え、タイミング依存のロジックを修正する
  - 各テストを10回連続で実行して安定性を確認する
  - _Requirements: 1.3, 6.1, 6.3, 7.2_

- [x] 16.2 全E2Eテストのフレーキー調査と修正
  - 全E2Eテストを実行し、警告やエラーログを出すテストを特定する
  - console.warnやconsole.errorを出力するテストを修正し、不要なログを抑制する
  - タイムアウト警告が発生するテストの原因を調査して修正する
  - 各修正後に10回連続でテストが通過することを確認する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 7.1, 7.2, 8.1, 8.2, 8.3, 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4, 11.1, 11.2, 11.3, 11.4, 12.1, 12.2, 12.3_

- [x] 16.3 最終検証（25回連続全テスト実行）
  - すべてのE2Eテストを25回連続で実行する
  - 失敗・警告・余計なログが1件もないことを確認する
  - 1件でも問題があれば16.1または16.2に戻って修正を続ける
  - 完了条件：25回連続実行で失敗0件、警告0件、余計なログ0件
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 7.1, 7.2, 8.1, 8.2, 8.3, 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4, 11.1, 11.2, 11.3, 11.4, 12.1, 12.2, 12.3_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 2.1, 2.4 |
| 1.2 | 2.3, 2.4 |
| 1.3 | 2.2, 2.4, 14.2, 16.1 |
| 1.4 | 2.1, 2.4 |
| 1.5 | 2.3, 2.4 |
| 2.1 | 3.1, 3.3 |
| 2.2 | 3.2, 3.3 |
| 3.1 | 4.1, 4.2 |
| 3.2 | 4.1, 4.2 |
| 4.1 | 5.1, 5.2 |
| 4.2 | 5.1, 5.2 |
| 5.1 | 6.1, 6.2 |
| 5.2 | 6.1, 6.2 |
| 5.3 | 6.1, 6.2 |
| 5.4 | 6.1, 6.2 |
| 6.1 | 7.1, 7.2, 16.1 |
| 6.2 | 7.1, 7.2 |
| 6.3 | 7.1, 7.2, 14.1, 16.1 |
| 7.1 | 8.1, 8.2 |
| 7.2 | 8.1, 8.2, 16.1 |
| 8.1 | 9.1, 9.2 |
| 8.2 | 9.1, 9.2 |
| 8.3 | 9.1, 9.2 |
| 9.1 | 10.1, 10.3 |
| 9.2 | 10.2, 10.3 |
| 9.3 | 10.2, 10.3 |
| 9.4 | 10.1, 10.3 |
| 10.1 | 11.1, 11.2 |
| 10.2 | 11.1, 11.2 |
| 10.3 | 11.1, 11.2 |
| 10.4 | 11.1, 11.2 |
| 11.1 | 12.1, 12.3 |
| 11.2 | 12.1, 12.3 |
| 11.3 | 12.2, 12.3 |
| 11.4 | 12.2, 12.3 |
| 12.1 | 1.1, 1.2 |
| 12.2 | 1.1, 1.2 |
| 12.3 | 1.1, 1.2 |
