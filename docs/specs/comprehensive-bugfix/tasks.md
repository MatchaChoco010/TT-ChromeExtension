# Implementation Plan

## タスク概要

17項目のバグ修正を実装するための作業計画。E2Eテスト品質基準（`--repeat-each=10`で安定通過）を全タスクで遵守する。

---

## Tasks

### E2Eテスト基盤とUI表示修正

- [ ] 1. E2Eテスト安定化とポーリング待機の標準化
- [x] 1.1 (P) 既存E2Eテストのフレーキーテスト修正
  - タイトル永続化更新テスト（`tab-persistence.spec.ts:201:5`）の安定化
  - `waitForTimeout`使用箇所を`waitForCondition`ポーリングに置換
  - 不必要に長いタイムアウト設定を短縮
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 1.6_

- [x] 1.2 (P) ポーリングユーティリティの拡充
  - 新しい待機条件に対応するユーティリティ関数を追加（必要に応じて）
  - 既存ユーティリティの安定性を検証
  - _Requirements: 1.3, 1.4_

- [ ] 2. 設定タブと内部ページのタイトル表示修正
- [x] 2.1 (P) 拡張機能ページへのHTMLタイトル追加
  - `settings.html`に`<title>Settings</title>`を追加
  - `group.html`に`<title>Group</title>`を追加（グループ機能の準備）
  - ブラウザ標準のタイトル取得で正しく表示されることを確認
  - _Requirements: 7.1, 7.2, 7.3, 3.4_

- [x] 2.2 (P) タイトル表示ロジックの簡素化
  - `TreeNode.tsx`の`getDisplayTitle`関数が`chrome.tabs.Tab.title`をそのまま使用することを確認
  - 不要なフォールバック処理を削除（存在する場合）
  - 内部ページでもtitleがそのまま表示されることを検証
  - _Requirements: 7.3, 8.1, 8.2_

- [x] 2.3 E2Eテスト追加：設定タブと内部ページのタイトル表示
  - 設定タブを開いて「Settings」タイトルが表示されることを検証
  - 内部ページ（vivaldi:calendar等）のタイトル表示を検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 7.4, 7.5, 8.4, 8.5_

- [ ] 3. 未読インジケーター位置とバッジ表示の修正
- [x] 3.1 (P) 未読インジケーターのdepth対応
  - `UnreadBadge.tsx`にdepth propsを追加
  - インジケーター位置をdepthに応じてインデントするスタイル適用
  - `TreeNode.tsx`からdepthを渡すよう修正
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 3.2 (P) 親タブへの不要なバッジ表示削除
  - 未読の子タブがある場合でも親タブにバッジを表示しないよう修正
  - 要件に定義されていないバッジ表示を削除
  - _Requirements: 16.1, 16.2_

- [x] 3.3 E2Eテスト追加：未読インジケーターとバッジ非表示
  - 異なるdepthでのインジケーター位置を検証
  - 未読子タブがある状態で親タブにバッジが表示されないことを確認
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 9.4, 9.5, 16.3, 16.4, 16.5_

- [ ] 4. ビューのタブ数表示視認性向上
- [x] 4.1 (P) タブ数バッジのスタイル修正
  - `ViewSwitcher.tsx`のタブ数表示を調整
  - 数字が見切れないよう`min-width`を拡大
  - 位置を内側に配置して視認性向上
  - _Requirements: 17.1, 17.2_

- [x] 4.2 E2Eテスト追加：タブ数表示の視認性
  - タブ数が正しく表示されることを検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 17.3, 17.4_

### ドラッグ&ドロップ機能修正

- [ ] 5. サブツリーのドラッグ移動修正
- [x] 5.1 サブツリーサイズ計算の実装
  - `TreeStateManager.ts`に`getSubtreeSize`メソッドを追加
  - サブツリー全体のノード数を正確に計算
  - _Requirements: 2.1_

- [x] 5.2 ドロップ位置計算の修正
  - `useDragDrop.ts`の`calculateDropTarget`でサブツリーサイズを考慮
  - 下方向へのドラッグ時に正しい移動数で移動するよう修正
  - _Requirements: 2.1_

- [x] 5.3 折りたたみ/展開状態でのサブツリー移動
  - 折りたたまれた親タブのドラッグ時に非表示の子タブも含めて移動
  - 展開された親タブのドラッグ時に可視の子タブも含めて移動
  - _Requirements: 2.2, 2.3_

- [x] 5.4 E2Eテスト追加：サブツリードラッグ移動
  - 折りたたみ状態でのサブツリー移動を検証
  - 展開状態でのサブツリー移動を検証
  - 下方向への移動で正しい位置に配置されることを確認
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 2.4, 2.5_

- [ ] 6. 親子関係解消の永続化
- [x] 6.1 ドラッグによる親子関係解消の確実な反映
  - `TabTreeView.tsx`の`onDragEnd`コールバックで、ドラッグ中のノードとそのサブツリーを除外した`effectiveTabPositions`を使用して`aboveNodeId`/`belowNodeId`を正しく参照
  - `calculateDropTarget`がサブツリーを除外した`effectiveTabPositions`でgapIndexを計算するため、参照リストも同様に除外する必要があった
  - 元子タブの`parentId`がnullに正しく更新されることをE2Eテストで検証
  - _Requirements: 11.1, 11.3_

- [x] 6.2 元子タブからの新規タブ作成
  - 親子関係解消後の元子タブからリンクを開いた場合、元子タブの子として作成されることを確認
  - 元親タブの子タブにならないことを検証
  - _Requirements: 11.2_

- [x] 6.3 E2Eテスト追加：親子関係解消の永続化
  - ドラッグで親子関係を解消し、状態が維持されることを検証
  - 元子タブから新規タブを開いて正しい親子関係になることを確認
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 11.4, 11.5, 11.6_

### クロスウィンドウドラッグとウィンドウ管理

- [x] 7. クロスウィンドウドラッグ機能の実装
- [x] 7.1 DragSessionManagerの拡張
  - `notifyDragOut`メソッドを追加：ツリービュー領域からのドラッグ離脱を通知
  - `notifyTreeViewHover`メソッドを追加：別ウィンドウのツリービュー上のホバーを通知
  - 重複呼び出しの防止ロジックを実装
  - _Requirements: 4.1, 4.4, 4.5_

- [x] 7.2 ツリービュー上のホバー検知実装
  - `TabTreeView.tsx`で`mousemove`イベントを使用したホバー検知を実装
  - セッション状態のローカルキャッシュを実装（パフォーマンス最適化）
  - バックグラウンドスロットリング回避のためのフォーカス移動処理を実装
  - _Requirements: 4.4, 4.5_

- [x] 7.3 クロスウィンドウタブ移動の実装
  - ドロップ時に`chrome.tabs.move`で対象ウィンドウにタブを移動
  - ツリービュー外へのドロップで新規ウィンドウを作成
  - _Requirements: 4.2, 4.3_

- [x] 7.4 E2Eテスト追加：クロスウィンドウドラッグ
  - 別ウィンドウへのタブドラッグを検証
  - ツリービュー外ドロップでの新規ウィンドウ作成を検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 4.6, 4.7_

- [ ] 8. 空ウィンドウの自動クローズ
- [x] 8.1 タブ削除時の空ウィンドウ検知と自動クローズ
  - `event-handlers.ts`の`handleTabRemoved`で残タブ数をチェック
  - 空になったウィンドウを自動的に閉じる
  - 最後のウィンドウは閉じない（ブラウザ終了防止）
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 8.2 ドラッグ中の自動クローズ抑止
  - ドラッグセッション中はドラッグ元ウィンドウの自動クローズを抑止
  - ドラッグ完了時に空であれば自動クローズを実行
  - _Requirements: 5.4, 5.5_

- [x] 8.3 E2Eテスト追加：空ウィンドウ自動クローズ
  - タブ移動後の空ウィンドウが閉じることを検証
  - ドラッグ中は閉じないことを検証
  - 最後のウィンドウが閉じないことを検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 5.8, 5.9_

### タブ操作とビュー管理

- [ ] 9. 新規タブ作成時のツリー展開
- [x] 9.1 親タブの自動展開実装
  - `event-handlers.ts`の`handleTabCreated`で親タブの自動展開を実装
  - `TreeStateManager.ts`の`expandNode`メソッドを使用
  - `isLinkClick`判定でpendingTabParentsも考慮するよう修正
  - _Requirements: 10.1, 10.2_

- [x] 9.2 E2Eテスト追加：新規タブ作成時のツリー展開
  - 折りたたまれた親タブからリンクを開いて展開されることを検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 10.3, 10.4_

- [ ] 10. ビューへの新規タブ追加
- [x] 10.1 現在開いているビューへのタブ追加
  - 新規タブが現在開いているビューに追加されるよう修正
  - ビューが切り替わった場合は切り替わり後のビューに追加
  - _Requirements: 6.1, 6.3_

- [x] 10.2 新規タブ追加時のビュー維持
  - 新しいタブを開いても現在のビューが閉じないことを確認
  - _Requirements: 6.2_

- [x] 10.3 E2Eテスト追加：ビューへの新規タブ追加
  - ビューを追加して新規タブがそのビューに追加されることを検証
  - ビューが維持されることを検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 6.4, 6.5_

- [ ] 11. タブ複製時の配置修正
- [x] 11.1 複製タブの兄弟配置実装
  - `event-handlers.ts`で複製タブを兄弟として配置
  - 複製元タブの1個下の位置に表示
  - _Requirements: 14.1, 14.2_

- [x] 11.2 E2Eテスト追加：タブ複製時の配置
  - 複製タブが兄弟として配置されることを検証
  - 正しい位置に表示されることを確認
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 14.3, 14.4_

- [ ] 12. リンクから開いたタブの配置設定
- [x] 12.1 配置設定の動作確認と修正
  - 「リストの最後」設定時に新規タブがリストの最後に追加されることを確認
  - 設定に従った位置にタブが配置されるよう修正（必要な場合）
  - _Requirements: 15.1, 15.2_

- [x] 12.2 E2Eテスト追加：リンクタブ配置設定
  - 複数の配置設定パターンを検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 15.3, 15.4, 15.5_

### グループ化機能

- [ ] 13. タブのグループ化機能実装
- [x] 13.1 GroupManagerサービスの作成
  - `GroupManager.ts`を`/src/services/`に作成
  - `createGroup`メソッド：選択タブをグループ化してグループタブを生成
  - `canCreateGroup`メソッド：グループ化可能かどうかを判定（2タブ以上）
  - `determineGroupPosition`メソッド：グループタブの挿入位置を決定
  - _Requirements: 3.1, 3.2, 3.8_

- [x] 13.2 グループタブの生成と子タブ配置
  - グループタブに`chrome-extension://[拡張機能ID]/group.html`を表示
  - デフォルト名「新しいグループ」を設定
  - 選択タブを新しいグループタブの子として配置
  - 子タブの元の順序を維持
  - グループタブを展開状態に設定
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 13.3 グループタブの階層決定
  - 選択タブが異なる親を持つ場合はルートレベルに配置
  - 選択タブがすべて同じ親を持つ場合はその親の子として配置
  - _Requirements: 3.9, 3.10_

- [x] 13.4 コンテキストメニューへのグループ化オプション追加
  - 複数タブ選択時に「グループ化」オプションを表示
  - 単一タブ選択時は「グループ化」を無効化（グレーアウト）
  - _Requirements: 3.1, 3.8_

- [x] 13.5 E2Eテスト追加：タブグループ化
  - グループタブの生成と正しい位置への挿入を検証
  - 子タブの順序維持を検証
  - グループタブの展開状態を検証
  - 単一タブ選択時のメニュー無効化を検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 3.11, 3.12, 3.13_

### 永続化機能

- [ ] 14. ファビコンの永続化復元
- [x] 14.1 ファビコン永続化の確認と修正
  - ブラウザ再起動後にファビコンが正しく表示されることを確認
  - 未ロードタブでも永続化されたファビコンを表示
  - _Requirements: 12.1, 12.2_

- [x] 14.2 E2Eテスト追加：ファビコン永続化
  - ブラウザ再起動後のファビコン表示を検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 12.3, 12.4_

- [ ] 15. ツリー状態の永続化
- [x] 15.1 親子関係と折りたたみ状態の永続化確認
  - ブラウザ再起動後に親子関係が復元されることを確認
  - 折りたたみ状態が維持されることを確認
  - _Requirements: 13.1, 13.2, 13.3_

- [x] 15.2 E2Eテスト追加：ツリー状態永続化
  - 親子関係と折りたたみ状態の復元を検証
  - `--repeat-each=10`で安定性を確認
  - _Requirements: 13.4, 13.5, 13.6_

### 最終検証

- [ ] 16. 全E2Eテストの統合検証
- [x] 16.1 全テストスイートの実行
  - `npm run test:e2e`で全テストがパスすることを確認
  - 既存テストへの影響がないことを検証
  - 要件3.8（単一タブ選択時のグループ化無効化）に矛盾していたテストを複数タブ選択に修正
  - _Requirements: 1.1_

- [x] 16.2 新規テストの安定性最終確認
  - 全新規テストを`--repeat-each=10`で検証
  - フレーキーテストがゼロであることを確認
  - 検証済みテストファイル: settings-tab-title.spec.ts, unread-indicator.spec.ts, view-tab-count.spec.ts, drag-drop-subtree.spec.ts, drag-drop-child-independent.spec.ts, empty-window-auto-close.spec.ts, tree-expand-on-new-tab.spec.ts, view-new-tab.spec.ts, tab-duplicate.spec.ts, tab-position-settings.spec.ts, tab-grouping.spec.ts, favicon-restore.spec.ts, tree-state-persistence.spec.ts, cross-window-drag-drop.spec.ts
  - _Requirements: 1.4_

---

## Requirements Coverage

| 要件 | タスク |
|------|--------|
| 1.1-1.6 | 1.1, 1.2, 16.1, 16.2 |
| 2.1-2.5 | 5.1, 5.2, 5.3, 5.4 |
| 3.1-3.13 | 13.1, 13.2, 13.3, 13.4, 13.5 |
| 4.1-4.7 | 7.1, 7.2, 7.3, 7.4 |
| 5.1-5.9 | 8.1, 8.2, 8.3 |
| 6.1-6.5 | 10.1, 10.2, 10.3 |
| 7.1-7.5 | 2.1, 2.2, 2.3 |
| 8.1-8.5 | 2.2, 2.3 |
| 9.1-9.5 | 3.1, 3.3 |
| 10.1-10.4 | 9.1, 9.2 |
| 11.1-11.6 | 6.1, 6.2, 6.3 |
| 12.1-12.4 | 14.1, 14.2 |
| 13.1-13.6 | 15.1, 15.2 |
| 14.1-14.4 | 11.1, 11.2 |
| 15.1-15.5 | 12.1, 12.2 |
| 16.1-16.5 | 3.2, 3.3 |
| 17.1-17.4 | 4.1, 4.2 |
