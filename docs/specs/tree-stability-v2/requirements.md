# Requirements Document

## Introduction

Vivaldi-TTツリー型タブマネージャーにおいて、既存実装に存在するバグと動作不良を包括的に修正する。本要件書では、E2Eテストの安定性、ドラッグ＆ドロップ操作、タブの親子関係管理、グループ化機能、永続化、ビュー管理など13項目のバグ修正を定義する。

### 重要: 既存実装のバグ修正について

**本要件書に記載されたすべての機能は、既に実装済みのように見える可能性があるが、ユーザーによる実際の動作確認において正しく動作しないことが判明している。** したがって、各要件の実装作業は以下のプロセスに従うこと：

1. **既存コードの詳細な調査**: 該当機能の既存実装を詳細に読み、なぜ正しく動作しないのか根本原因を特定する
2. **原因の文書化**: 発見したバグの原因を明確に理解し、修正方針を決定する
3. **正しい実装への書き換え**: 単なるパッチではなく、根本原因を解消する形で実装を修正する
4. **動作確認**: 修正後、実際のブラウザ操作で正しく動作することを確認する
5. **E2Eテストによる検証**: 可能な限りE2Eテストを追加し、リグレッションを防止する

**「既に実装されているから動くはず」という前提を持たないこと。実際に動作しないことがユーザーにより確認されている。**

### E2Eテスト品質基準

すべてのE2Eテストは以下の品質基準を満たすこと：

- **フレーキーでないこと**: `--repeat-each=10`で10回連続成功すること
- **固定時間待機の禁止**: `waitForTimeout`を使用せず、ポーリングで状態確定を待機すること
- **実行時間の最適化**: 必要十分な短い実行時間で完了すること
- **不必要に長いタイムアウトの禁止**: タイムアウトを長くして対処するのではなく、根本原因を修正すること

## Requirements

### Requirement 1: E2Eテストの安定化

**Objective:** As a 開発者, I want E2Eテストがフレーキーでなく安定して通過する, so that CI/CDパイプラインの信頼性を確保できる

#### Acceptance Criteria

1. When `npm run test:e2e`を実行した場合, the E2Eテスト shall 全てのテストケースがパスすること
2. When `tab-persistence.spec.ts:201:5`のタイトル永続化更新テストを実行した場合, the テスト shall `--repeat-each=10`で10回連続成功すること
3. The E2Eテスト shall 固定時間待機（`waitForTimeout`）を使用せず、ポーリングで状態確定を待機すること
4. The E2Eテスト shall 必要十分な短い実行時間で完了すること

#### 調査要件

5. The 修正作業 shall 既存のテストコードを詳細に読み、テスト失敗の根本原因を特定すること
6. The 修正作業 shall テストコードだけでなく、テスト対象の実装コードにもバグがある可能性を考慮すること

### Requirement 2: サブツリーのドラッグ移動

**Objective:** As a ユーザー, I want 子タブを持つ親タブをドラッグして正しい位置に移動できる, so that タブツリーの構造を自由に再編成できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認で正しく動作しないことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When 子タブを持つ親タブを下方向にドラッグした場合, the タブツリー shall プレースホルダーを正しい位置に表示し、サブツリー全体を正しく移動すること
2. When 子タブを持つ親タブを飛び越える形で他のタブをドラッグした場合, the タブツリー shall 正しいドロップ位置を計算すること
3. When 折りたたまれた親タブをドラッグした場合, the タブツリー shall 非表示の子タブも含めてサブツリー全体を移動すること
4. When 展開された親タブをドラッグした場合, the タブツリー shall 可視の子タブも含めてサブツリー全体を移動すること

#### 調査要件

5. The 修正作業 shall 既存のドラッグ処理コードを詳細に読み、プレースホルダー位置計算のバグの根本原因を特定すること

#### E2Eテスト要件

6. The サブツリー移動機能 shall E2Eテストで検証されること（折りたたみ/展開状態両方）
7. The サブツリー移動E2Eテスト shall `--repeat-each=10`で安定して通過すること
8. The サブツリー移動E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 3: 新規タブ作成時の親子関係維持

**Objective:** As a ユーザー, I want 新しいタブを開いても既存の親子関係が維持される, so that 意図したツリー構造を保てる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認で正しく動作しないことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When 新しいタブを開いた場合, the タブツリー shall 既存タブの親子関係を変更しないこと
2. When リンクから新しいタブを開いた場合, the 新しいタブ shall リンク元タブの子タブとして配置されること（設定による）
3. When 複数のタブが親子関係にある状態で新しいタブを開いた場合, the タブツリー shall 他のタブの親子関係を解消しないこと

#### 調査要件

4. The 修正作業 shall 既存のタブ作成処理コードを詳細に読み、親子関係が解消される根本原因を特定すること

#### E2Eテスト要件

5. The 親子関係維持機能 shall E2Eテストで検証されること
6. The 親子関係維持E2Eテスト shall `--repeat-each=10`で安定して通過すること
7. The 親子関係維持E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 4: タブのグループ化機能

**Objective:** As a ユーザー, I want 選択したタブをグループ化できる, so that 関連するタブをまとめて管理できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認でグループタブすら作成されないことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

##### グループタブの生成

1. When 複数のタブを選択してコンテキストメニューから「グループ化」を選択した場合, the タブツリー shall 新しい親タブ（グループタブ）を生成すること
2. When グループタブを生成する場合, the グループタブ shall 選択されたタブの中で最も上にあるタブの位置に挿入されること
3. When グループタブを生成する場合, the グループタブ shall グループ用ページ（`chrome-extension://[拡張機能ID]/group.html`）を表示すること
4. When グループタブを生成する場合, the グループタブ shall デフォルトで「新しいグループ」という名前を持つこと

##### 子タブの配置

5. When グループ化を実行した場合, the タブツリー shall 選択していたすべてのタブを新しいグループタブの子タブとして配置すること
6. When 子タブを配置する場合, the 子タブ shall 元の選択順序（ツリー上での上から下の順）を維持すること
7. When グループ化が完了した場合, the グループタブ shall 展開状態（子タブが表示される状態）であること

##### 単一タブの取り扱い

8. When 単一のタブのみが選択されている場合, the コンテキストメニュー shall 「グループ化」オプションを無効化（グレーアウト）すること

#### 調査要件

9. The 修正作業 shall 既存のグループ化処理コードを詳細に読み、グループタブが作成されない根本原因を特定すること

#### E2Eテスト要件

10. The グループ化機能 shall E2Eテストで検証されること
11. The グループ化E2Eテスト shall 以下を検証すること:
    - グループタブの生成と正しい位置への挿入
    - 子タブの順序維持
    - グループタブの展開状態
    - 単一タブ選択時のメニュー無効化
12. The グループ化E2Eテスト shall `--repeat-each=10`で安定して通過すること
13. The グループ化E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 5: クロスウィンドウドラッグ

**Objective:** As a ユーザー, I want 別のウィンドウからタブをドラッグして現在のウィンドウに移動できる, so that ウィンドウ間でタブを自由に整理できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認で全てドラッグアウトと判定されて新しいウィンドウが開いてしまうことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When 別ウィンドウでタブをドラッグ中に、別のウィンドウのツリービューにマウスを重ねた場合, the ドラッグセッション shall そのウィンドウのツリービューへのドロップを受け入れること
2. When クロスウィンドウドラッグでタブをドロップした場合, the タブ shall ドロップ先のウィンドウに移動すること
3. If クロスウィンドウドラッグ中にツリービュー外にドロップした場合, the タブ shall 新規ウィンドウとして分離されること

#### 調査要件

4. The 修正作業 shall 既存のクロスウィンドウドラッグ処理コードを詳細に読み、ドラッグアウトと誤判定される根本原因を特定すること

#### E2Eテスト要件

5. The クロスウィンドウドラッグ機能 shall E2Eテストで検証されること
6. The クロスウィンドウドラッグE2Eテスト shall `--repeat-each=10`で安定して通過すること
7. The クロスウィンドウドラッグE2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 6: 空ウィンドウの自動クローズ

**Objective:** As a ユーザー, I want タブが全て移動したウィンドウが自動的に閉じる, so that 不要な空ウィンドウが残らない

#### Acceptance Criteria

1. When ドラッグ操作によりウィンドウの全ての通常タブが別ウィンドウに移動した場合, the 元ウィンドウ shall 自動的に閉じること
2. While ウィンドウにピン留めタブのみが存在する場合, the ウィンドウ shall 開いたまま維持されること
3. While ウィンドウに通常タブが1つ以上存在する場合, the ウィンドウ shall 開いたまま維持されること

#### E2Eテスト要件

4. The 空ウィンドウ自動クローズ機能 shall E2Eテストで検証されること
5. The 空ウィンドウE2Eテスト shall `--repeat-each=10`で安定して通過すること
6. The 空ウィンドウE2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 7: ビューへの新規タブ追加

**Objective:** As a ユーザー, I want 新しく追加したビューに新規タブを追加できる, so that プロジェクト別にタブを整理できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認でビューを開いた状態で新しいタブを開くとビューが勝手に閉じて元のビューに新しいタブが追加されることが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When ビューを追加して開いた状態で新しいタブを開いた場合, the タブ shall 現在開いているビューに追加されること
2. When 新しいタブを開いた場合, the 現在開いているビュー shall 閉じずに開いたまま維持されること
3. If ビューが切り替わった場合, the 新規タブ shall 切り替わり後のビューに追加されること

#### 調査要件

4. The 修正作業 shall 既存のビュー管理コードを詳細に読み、ビューが勝手に閉じてしまう根本原因を特定すること

#### E2Eテスト要件

5. The ビューへの新規タブ追加機能 shall E2Eテストで検証されること
6. The ビューE2Eテスト shall `--repeat-each=10`で安定して通過すること
7. The ビューE2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 8: タブ親子関係の不整合解消

**Objective:** As a ユーザー, I want 新しいタブを開いても他のタブの親子関係が維持される, so that 意図したツリー構造を保てる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認で新しいタブを開くと他のタブの親子関係が解消されることが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When 新しいタブを開いた場合, the タブツリー shall 既存タブ間の親子関係を解消しないこと
2. When 任意の操作を行った場合, the タブツリー shall 明示的に変更されていない親子関係を維持すること

#### 調査要件

3. The 修正作業 shall 既存のタブ管理コードを詳細に読み、親子関係が意図せず解消される根本原因を特定すること

#### E2Eテスト要件

4. The 親子関係不整合解消 shall E2Eテストで検証されること
5. The 親子関係E2Eテスト shall 複数のタブ操作シナリオを検証すること
6. The 親子関係E2Eテスト shall `--repeat-each=10`で安定して通過すること
7. The 親子関係E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 9: ファビコンの永続化復元

**Objective:** As a ユーザー, I want ブラウザ再起動後もファビコンが表示される, so that タブを視覚的に識別できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認でブラウザを開き直したときに永続化されていたファビコンが表示されないことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When ブラウザを再起動した場合, the タブツリー shall 永続化されていたファビコンを表示すること
2. While タブがまだロードされていない場合, the タブツリー shall 永続化されたファビコンを表示すること
3. When タブがロードされた場合, the タブツリー shall 新しいファビコンで表示を更新すること

#### E2Eテスト要件

4. The ファビコン永続化復元 shall E2Eテストで検証されること
5. The ファビコンE2Eテスト shall `--repeat-each=10`で安定して通過すること
6. The ファビコンE2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 10: ツリー状態の永続化

**Objective:** As a ユーザー, I want ブラウザ再起動後もタブのツリー構造が維持される, so that 作業状態を復元できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認でブラウザを閉じて再度開いたときにツリーの親子関係が解除されることが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When ブラウザを閉じた場合, the 拡張機能 shall タブの親子関係を永続化すること
2. When ブラウザを再起動した場合, the タブツリー shall 永続化された親子関係を復元すること
3. When ブラウザを再起動した場合, the タブツリー shall ツリーの折りたたみ状態も復元すること

#### E2Eテスト要件

4. The ツリー状態永続化 shall E2Eテストで検証されること
5. The ツリー永続化E2Eテスト shall 親子関係と折りたたみ状態を検証すること
6. The ツリー永続化E2Eテスト shall `--repeat-each=10`で安定して通過すること
7. The ツリー永続化E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 11: タブ複製時の配置

**Objective:** As a ユーザー, I want 複製したタブが兄弟タブとして配置される, so that 複製元タブと並列に作業できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認で複製したタブが子タブになってしまうことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When タブを複製した場合, the 複製されたタブ shall 複製元タブの子タブではなく兄弟タブとして配置されること
2. When タブを複製した場合, the 複製されたタブ shall 複製元タブの1個下の位置に表示されること

#### E2Eテスト要件

3. The タブ複製時の配置 shall E2Eテストで検証されること
4. The タブ複製E2Eテスト shall `--repeat-each=10`で安定して通過すること
5. The タブ複製E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 12: リンクから開いたタブの配置設定

**Objective:** As a ユーザー, I want リンクから開いたタブの配置設定が正しく動作する, so that 設定通りにタブが配置される

**注意:** この機能は既に実装されているように見えるが、実際の動作確認で「リストの最後」に設定しても最後に追加されず1個下に追加される場合があることが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When 設定で「リンククリックから開かれたタブの位置」を「リストの最後」に設定した場合, the 新規タブ shall リストの最後（ルートレベルの末尾）に追加されること
2. When 設定で「リンククリックから開かれたタブの位置」を「親タブの下」に設定した場合, the 新規タブ shall 親タブの子タブとして配置されること
3. When リンクから新しいタブを開いた場合, the タブ shall 設定に従った位置に配置されること

#### 調査要件

4. The 修正作業 shall 既存のタブ配置処理コードを詳細に読み、設定が正しく反映されない根本原因を特定すること

#### E2Eテスト要件

5. The リンクタブ配置設定 shall E2Eテストで検証されること
6. The 配置設定E2Eテスト shall 複数の設定パターンを検証すること
7. The 配置設定E2Eテスト shall `--repeat-each=10`で安定して通過すること
8. The 配置設定E2Eテスト shall 必要十分な短い実行時間で完了すること

### Requirement 13: 未読インジケーターの復元時制御

**Objective:** As a ユーザー, I want ブラウザ復元時のタブに未読インジケーターが表示されない, so that 実際に未読のタブを正確に把握できる

**注意:** この機能は既に実装されているように見えるが、実際の動作確認でブラウザ復元時のタブに未読インジケーターがついてしまうことが判明している。既存コードを詳細に読み、バグの根本原因を特定して修正すること。

#### Acceptance Criteria

1. When ブラウザを再起動してタブが復元された場合, the 復元されたタブ shall 未読インジケーターを表示しないこと
2. When 復元されたタブがアクティブ化された後に非アクティブになった場合, the タブ shall 通常の未読判定ルールに従うこと

#### E2Eテスト要件

3. The 未読インジケーター復元時制御 shall E2Eテストで検証されること
4. The 未読インジケーターE2Eテスト shall `--repeat-each=10`で安定して通過すること
5. The 未読インジケーターE2Eテスト shall 必要十分な短い実行時間で完了すること
