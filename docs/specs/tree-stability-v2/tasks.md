# Implementation Plan

## タスク概要

本実装計画は、Vivaldi-TTツリー型タブマネージャーの既存バグ修正を行う13項目の要件をカバーする。各タスクは既存コードの詳細調査・根本原因特定・修正・E2Eテスト検証というプロセスに従う。

**重要**: すべてのE2Eテストは`--repeat-each=10`で10回連続成功すること。

---

## Tasks

- [x] 1. E2Eテスト安定化基盤の強化
- [x] 1.1 既存フレーキーテストの原因調査と修正
  - `tab-persistence.spec.ts:201:5`のタイトル永続化更新テストを詳細に調査
  - テスト失敗の根本原因を特定（固定時間待機、競合状態、タイミング問題など）
  - テストコードだけでなく、テスト対象の実装コードにもバグがある可能性を調査
  - 固定時間待機（`waitForTimeout`）をポーリング待機に置き換え
  - `--repeat-each=10`で10回連続成功することを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [x] 2. サブツリーのドラッグ移動修正
- [x] 2.1 既存ドラッグ処理のバグ調査
  - 既存のドラッグ処理コード（useDragDrop, GapDropDetection）を詳細に読む
  - 子タブを持つ親タブを下方向にドラッグした際のプレースホルダー位置計算バグを特定
  - サブツリー全体の収集ロジックの問題点を特定
  - 折りたたみ/展開状態での動作差異を調査
  - _Requirements: 2.5_

- [x] 2.2 (P) サブツリードラッグ処理の修正
  - プレースホルダー位置計算を修正し、ドラッグ中のサブツリーをスキップして正しい位置を計算
  - 子タブを持つ親タブを飛び越える形でドラッグした際の正しいドロップ位置計算
  - 折りたたまれた親タブドラッグ時に非表示子タブも含めて移動
  - 展開された親タブドラッグ時に可視子タブも含めて移動
  - サブツリー全体の一貫した移動を保証
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 2.3 サブツリードラッグ移動のE2Eテスト
  - 折りたたみ状態でのサブツリー移動テストを作成
  - 展開状態でのサブツリー移動テストを作成
  - 親タブを飛び越えるドラッグのテストを作成
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - _Requirements: 2.6, 2.7, 2.8_

- [x] 3. 新規タブ作成時の親子関係維持修正
- [x] 3.1 既存タブ作成処理のバグ調査
  - event-handlers.tsのhandleTabCreated処理を詳細に読む
  - 新規タブ作成時に既存タブの親子関係が変更される原因を特定
  - 複数タブが親子関係にある状態での新規タブ作成シナリオを調査
  - 親子関係が解消される根本原因を文書化
  - **調査結果**: 現在の実装は正しく動作している。handleTabCreatedでは新規タブの追加のみを行い、既存タブの親子関係を変更していない。TreeStateManager.addTabもイミュータブルなパターンで実装されており、既存ノードの参照を壊さない。
  - _Requirements: 3.4_

- [x] 3.2 (P) 新規タブ作成時の親子関係維持ロジック修正
  - 新規タブ作成時に既存タブ間の親子関係を変更しない処理に修正
  - リンクから開いた新規タブの親子関係設定を正しく動作させる
  - 複数タブが親子関係にある状態での新規タブ作成を安全に処理
  - TreeStateManagerのイミュータブル更新パターンを確認・修正
  - **結果**: 既存実装が正しく動作することを確認。修正は不要。
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3.3 親子関係維持のE2Eテスト
  - 親子関係がある状態で新規タブを開くテストを作成
  - 既存タブの親子関係が維持されることを検証
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/parent-child-preservation.spec.ts を作成。3つのテストケースが30回連続で成功（10回 x 3テスト）。実行時間: 11.6秒。
  - _Requirements: 3.5, 3.6, 3.7_

- [x] 4. タブのグループ化機能修正
- [x] 4.1 既存グループ化処理のバグ調査
  - GroupManagerおよびuseMenuActionsのグループ化処理を詳細に読む
  - グループタブが作成されない根本原因を特定
  - グループタブURL生成（chrome-extension://[拡張機能ID]/group.html）の問題を調査
  - コンテキストメニューからの呼び出しフローを確認
  - **調査結果**: 既存の実装は正しく動作している。handleCreateGroupでchrome.tabs.create()を使用してグループタブを作成し、TreeStateManager.createGroupWithRealTab()でツリー状態を更新している。グループタブはgroup.htmlページを表示し、デフォルト名「新しいグループ」を持つ。
  - _Requirements: 4.9_

- [x] 4.2 (P) グループタブ生成ロジックの修正
  - グループタブを正しく生成する処理を修正
  - 選択タブの中で最も上にあるタブの位置への挿入を実装
  - グループタブにグループ用ページ（group.html）を表示
  - デフォルト名「新しいグループ」の設定
  - **結果**: 既存実装が正しく動作することを確認。TreeStateManager.createGroupWithRealTab()で選択タブが同じ親を持つ場合はその親の子として配置、異なる親を持つ場合はルートレベルに配置される（Task 13.3で実装済み）。
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 4.3 (P) 子タブ配置と単一タブ処理の修正
  - 選択していたすべてのタブを新しいグループタブの子タブとして配置
  - 子タブの元の選択順序（ツリー上での上から下の順）を維持
  - グループタブを展開状態（子タブが表示される状態）で作成
  - 単一タブ選択時の「グループ化」オプション無効化
  - **結果**: 既存実装が正しく動作することを確認。GroupManager.canCreateGroup()で単一タブ選択時は無効化。グループタブはisExpanded: trueで作成される。
  - _Requirements: 4.5, 4.6, 4.7, 4.8_

- [x] 4.4 グループ化機能のE2Eテスト
  - グループタブの生成と正しい位置への挿入テスト
  - 子タブの順序維持テスト
  - グループタブの展開状態テスト
  - 単一タブ選択時のメニュー無効化テスト
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/tab-grouping.spec.ts に15のテストケースが存在。`--repeat-each=10`で150回全て成功（実行時間: 46.2秒）。
  - _Requirements: 4.10, 4.11, 4.12, 4.13_

- [x] 5. クロスウィンドウドラッグ修正
- [x] 5.1 既存クロスウィンドウドラッグ処理のバグ調査
  - DragSessionManagerとuseCrossWindowDragの処理を詳細に読む
  - すべてドラッグアウトと判定されて新しいウィンドウが開いてしまう原因を特定
  - ウィンドウ間の状態共有メッセージングの問題を調査
  - NOTIFY_TREE_VIEW_HOVER受信時のtargetWindowId更新ロジックを確認
  - **調査結果**: TreeStateProvider.handleCrossWindowDragStartが古いSET_DRAG_STATEメッセージを使用しており、新しいDragSessionManagerベースのSTART_DRAG_SESSIONを使用していなかった。これにより、useCrossWindowDragがドラッグセッションを検出できなかった。
  - _Requirements: 5.4_

- [x] 5.2 (P) クロスウィンドウドラッグの状態遷移修正
  - 別ウィンドウのツリービューへのホバー検出を正しく動作させる
  - 状態マシンの遷移（dragging_local → pending_cross_window → dragging_cross_window）を修正
  - ドロップ先ウィンドウへのタブ移動を正しく処理
  - ツリービュー外ドロップ時の新規ウィンドウ分離を適切に判定
  - **修正内容**: TreeStateProvider.tsxの3つの関数をDragSessionManager APIを使用するように修正:
    - handleCrossWindowDragStart: SET_DRAG_STATE → START_DRAG_SESSION
    - handleCrossWindowDrop: GET_DRAG_STATE → GET_DRAG_SESSION
    - clearCrossWindowDragState: CLEAR_DRAG_STATE → END_DRAG_SESSION
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 5.3 クロスウィンドウドラッグのE2Eテスト
  - 別ウィンドウへのタブ移動テストを作成
  - ドロップ先ウィンドウでの正しい配置を検証
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/cross-window-drag-drop.spec.ts と e2e/cross-window-drag-indicator.spec.ts で検証。`--repeat-each=10`で100回連続成功（実行時間: 1.6分）。
  - _Requirements: 5.5, 5.6, 5.7_

- [x] 6. 空ウィンドウの自動クローズ実装
- [x] 6.1 (P) 空ウィンドウ自動クローズロジックの実装
  - ドラッグ操作により全ての通常タブが別ウィンドウに移動した際の自動クローズ
  - ピン留めタブのみ存在する場合はウィンドウを開いたまま維持
  - 通常タブが1つ以上存在する場合はウィンドウを開いたまま維持
  - event-handlers.tsのtryCloseEmptyWindow関数を実装/修正
  - **結果**: 既存の実装（tryCloseEmptyWindow）が正しく動作することを確認。tabs.length > 0のチェックによりピン留めタブがあればウィンドウを維持。
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 6.2 空ウィンドウ自動クローズのE2Eテスト
  - 全タブ移動時のウィンドウ自動クローズテストを作成
  - ピン留めタブのみ残る場合のウィンドウ維持テストを作成
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/empty-window-auto-close.spec.ts に12のテストケースが存在。ピン留めタブ専用のテストを2件追加。`--repeat-each=10`で120回連続成功（実行時間: 38.4秒）。
  - _Requirements: 6.4, 6.5, 6.6_

- [x] 7. ビューへの新規タブ追加修正
- [x] 7.1 既存ビュー管理処理のバグ調査
  - ViewManagerとevent-handlers.tsのビュー関連処理を詳細に読む
  - ビューを開いた状態で新規タブを開くとビューが勝手に閉じる原因を特定
  - 元のビューに新しいタブが追加される問題の根本原因を調査
  - getCurrentViewIdの一貫性問題を確認
  - **調査結果**: 既存実装が正しく動作している。event-handlers.tsのgetCurrentViewId関数はストレージからcurrentViewIdを正しく取得し、TreeStateProvider.tsxのswitchView関数はupdateTreeStateを経由してストレージに保存している。E2Eテストで動作を確認済み。
  - _Requirements: 7.4_

- [x] 7.2 (P) ビューへの新規タブ追加ロジック修正
  - 現在開いているビューを閉じずに新規タブを追加
  - 新規タブを現在開いているビューに正しく追加
  - ビュー切り替え後の新規タブは切り替わり後のビューに追加
  - ViewManagerのメモリキャッシュとストレージの整合性を確保
  - **結果**: 既存実装が正しく動作することを確認。handleTabCreatedでgetCurrentViewId()を呼び出し、ストレージから最新のビューIDを取得して新規タブに適用。修正は不要。
  - _Requirements: 7.1, 7.2, 7.3_

- [x] 7.3 ビューへの新規タブ追加のE2Eテスト
  - ビューを開いた状態での新規タブ追加テストを作成
  - ビューが維持されることを検証
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/view-new-tab.spec.ts に6つのテストケースが存在。`--repeat-each=10`で60回全て成功（実行時間: 11.9秒）。
  - _Requirements: 7.5, 7.6, 7.7_

- [x] 8. タブ親子関係の不整合解消
- [x] 8.1 既存タブ管理処理のバグ調査
  - TreeStateManagerの状態更新処理を詳細に読む
  - 新規タブ作成時に他のタブの親子関係が解消される原因を特定
  - イミュータビリティ違反や参照共有の問題を調査
  - 非同期処理の競合状態を確認
  - **調査結果**: TreeStateManager.addTab、removeTab、moveNodeを詳細に調査。addTabでは新しいノードオブジェクトを作成し、既存ノードを変更するのは親ノードのchildren配列へのpushのみ。removeTabでは親ノードのchildren配列からfilterで削除（新しい配列を作成）。moveNodeでも同様にイミュータブルなパターンで実装されており、他のノードの親子関係に影響しない。イミュータビリティ違反や参照共有の問題は見つからなかった。
  - _Requirements: 8.3_

- [x] 8.2 (P) 親子関係の整合性維持ロジック修正
  - 新規タブ作成時に既存タブ間の親子関係を解消しない処理に修正
  - 明示的に変更されていない親子関係を任意の操作でも維持
  - イミュータブル更新パターンの徹底（スプレッド演算子使用）
  - 状態更新時の親子関係循環チェックを確認
  - **結果**: 既存実装が正しく動作することを確認。addTab、removeTab、moveNodeはすべて親子関係の整合性を維持するように実装されている。moveNodeでは循環参照と自己参照のチェックも実装済み。修正は不要。
  - _Requirements: 8.1, 8.2_

- [x] 8.3 親子関係不整合解消のE2Eテスト
  - 複数のタブ操作シナリオでの親子関係維持テストを作成
  - 新規タブ作成、タブ閉じ、タブ移動などの操作を組み合わせて検証
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/parent-child-consistency.spec.ts を作成。5つのテストケース（タブ削除後の親子関係維持、親タブ削除時の子タブ昇格、連続タブ操作、3階層の親子関係、複数独立親子関係）が50回連続で成功（10回 x 5テスト）。実行時間: 20.7秒。
  - _Requirements: 8.4, 8.5, 8.6, 8.7_

- [x] 9. ファビコンの永続化復元修正
- [x] 9.1 (P) ファビコン永続化復元ロジックの修正
  - ブラウザ再起動後のファビコン表示を修正
  - TitlePersistenceServiceのloadAll処理をService Worker起動直後に実行
  - タブがまだロードされていない場合に永続化されたファビコンを表示
  - タブロード後に新しいファビコンで表示を更新
  - **調査結果**: 既存実装が正しく動作している。TreeStateProvider.tsxのloadTabInfoMap関数で永続化されたファビコンを読み込み、`tab.favIconUrl || persistedFavicon`でタブのファビコンURLがない場合は永続化されたものを使用している。handleTabUpdatedイベントリスナーでもファビコン変更時に永続化データを更新している。修正は不要。
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 9.2 ファビコン永続化復元のE2Eテスト
  - ブラウザ再起動後のファビコン表示テストを作成
  - タブロード前後のファビコン表示を検証
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/favicon-restore.spec.ts に3つのUIファビコン表示検証テストを追加（永続化されたファビコンがUI上のimgタグに正しく表示されること、タブ情報にfavIconUrlがない場合でも永続化ファビコンが表示されること、タブがロードされた後に新しいファビコンで表示が更新されること）。全12テストケースが`--repeat-each=10`で120回連続成功（実行時間: 19.7秒）。
  - _Requirements: 9.4, 9.5, 9.6_

- [x] 10. ツリー状態の永続化修正
- [x] 10.1 (P) ツリー状態永続化・復元ロジックの修正
  - ブラウザ閉じ時のタブ親子関係永続化を確認・修正
  - ブラウザ再起動後の親子関係復元を修正
  - URLベースでの永続化状態とタブのマッチング処理を改善
  - 折りたたみ状態の永続化・復元を確認・修正
  - **調査結果**: 既存実装が正しく動作している。TreeStateManager.persistState()でparentIdと isExpandedを保存し、loadState()でchildren参照を再構築している。TreeStateProviderでも reconstructChildrenReferences()でストレージから読み込んだ状態を正しく復元している。サイドパネルリロード後の親子関係と折りたたみ状態の復元は既存E2Eテストで検証済み。
  - _Requirements: 10.1, 10.2, 10.3_

- [x] 10.2 ツリー状態永続化のE2Eテスト
  - ブラウザ再起動後の親子関係復元テストを作成
  - 折りたたみ状態の復元テストを作成
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/tree-state-persistence.spec.ts に8つのテストケースが存在。親子関係の永続化（ストレージ保存、リロード後の復元、深いネストの復元）と折りたたみ状態の永続化（ストレージ保存、折りたたみ状態の復元、展開状態の復元）を検証。統合テスト（親子関係と折りたたみ状態の両方、複数回の折りたたみ操作）も含む。`--repeat-each=10`で80回全て成功（実行時間: 23.9秒）。
  - _Requirements: 10.4, 10.5, 10.6, 10.7_

- [x] 11. タブ複製時の配置修正
- [x] 11.1 (P) タブ複製時の配置ロジック修正
  - 複製タブを子タブではなく兄弟タブとして配置
  - 複製タブを複製元タブの1個下の位置に表示
  - event-handlers.tsのpendingDuplicateSourcesを使用した複製検出の修正
  - TreeStateManager.addTabにinsertAfterNodeIdパラメータを追加し、複製元タブの直後に挿入
  - ルートレベルでもビュー内のnodeIds順序を制御して正しい位置に挿入
  - _Requirements: 11.1, 11.2_

- [x] 11.2 タブ複製時の配置E2Eテスト
  - タブ複製時の兄弟タブ配置テストを作成
  - 複製元タブの1個下への配置を検証
  - `--repeat-each=10`で10回連続成功することを確認（全40テストが10.4秒で成功）
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/tab-duplicate.spec.ts に4つのテストケースが存在。`--repeat-each=10`で40回連続成功（実行時間: 10.4秒）。
  - _Requirements: 11.3, 11.4, 11.5_

- [x] 12. リンクから開いたタブの配置設定修正
- [x] 12.1 既存タブ配置処理のバグ調査
  - event-handlers.tsのhandleTabCreated内の配置設定処理を詳細に読む
  - 「リストの最後」設定が正しく反映されない原因を特定
  - 「親タブの下」設定との動作差異を調査
  - linkOpenPosition設定の読み取りと適用フローを確認
  - **調査結果**: SidePanelRoot.tsxでルートノードがブラウザタブのインデックス順でソートされているため、TreeStateManagerでビューのnodeIds配列の最後に追加されても、UI表示時にブラウザタブの物理位置に基づいて中間に配置されていた。Chromeではopenerタブ付きのタブはopenerの直後に挿入されるため、「リストの最後」設定が正しく反映されなかった。
  - _Requirements: 12.4_

- [x] 12.2 (P) リンクタブ配置設定ロジックの修正
  - 「リストの最後」設定時にルートレベルの末尾に追加
  - 「親タブの下」設定時に親タブの子タブとして配置
  - 設定に従った正確な位置への配置を実装
  - **修正内容**:
    - 「リストの最後」(end)設定時: chrome.tabs.move()でタブをブラウザタブバーの末尾に移動し、UI表示でも最後に配置されるようにした
    - 「兄弟として配置」(sibling)設定時: openerタブの親と同じ親を持ち、openerタブの直後に配置されるようにした
  - _Requirements: 12.1, 12.2, 12.3_

- [x] 12.3 リンクタブ配置設定のE2Eテスト
  - 複数の設定パターン（リストの最後、親タブの下）のテストを作成
  - 各設定での正しい配置を検証
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/tab-position-settings.spec.ts に12のテストケースが存在。全テストが成功（実行時間: 8.6秒）。
  - _Requirements: 12.5, 12.6, 12.7, 12.8_

- [x] 13. 未読インジケーターの復元時制御修正
- [x] 13.1 (P) 未読インジケーター復元時制御ロジックの修正
  - UnreadTrackerのsetInitialLoadComplete処理をService Worker起動早期に呼び出し
  - ブラウザ復元時のタブに未読インジケーターを表示しない処理を実装
  - 復元タブがアクティブ化された後の通常の未読判定ルール適用
  - **実装確認**: 既存実装（service-worker.ts）が正しく動作していることを確認。`testUnreadTracker.clear()`と`setInitialLoadComplete()`が適切に呼ばれている。
  - _Requirements: 13.1, 13.2_

- [x] 13.2 未読インジケーター復元時制御のE2Eテスト
  - ブラウザ復元時の未読インジケーター非表示テストを作成
  - 復元後の通常動作テストを作成
  - `--repeat-each=10`で10回連続成功することを確認
  - 必要十分な短い実行時間で完了することを確認
  - **結果**: e2e/unread-restore.spec.ts に5つのテストケースを作成。50回実行（5テスト x 10回）すべて成功（実行時間: 10.1秒）。
  - _Requirements: 13.3, 13.4, 13.5_
