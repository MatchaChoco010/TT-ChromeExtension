# Requirements Document

## Introduction

本仕様は、Vivaldi-TT（ツリー型タブマネージャー）の実使用で発見されたUX問題の修正および機能追加を定義します。ピン留めタブの挙動、ドラッグ&ドロップの改善、タブタイトルの永続化、ビュー機能の強化など、多岐にわたる改善を含みます。

## Requirements

### Requirement 1: ピン留めタブの動作改善

**Objective:** ユーザーとして、ピン留めタブが一貫した動作をし、誤操作を防止したい。また、必要に応じてピン留めを解除したい。

#### Acceptance Criteria

1. The 拡張機能 shall ピン留めタブエリアのタブに閉じるボタンを表示しない
2. The 拡張機能 shall ピン留めタブをタブツリー一覧に表示しない（ピン留めエリアのみに表示する）
3. The 拡張機能 shall ピン留めタブに対する閉じる操作を無効化する
4. When ブラウザAPIによりピン留めタブが閉じられた場合, the 拡張機能 shall ピン留めエリアからも該当タブを削除する
5. The 拡張機能 shall ピン留めタブの状態をブラウザのタブ状態と常に同期する
6. When ピン留めタブを右クリックした場合, the 拡張機能 shall コンテキストメニューに「ピン留めを解除」オプションを表示する
7. When 「ピン留めを解除」を選択した場合, the 拡張機能 shall そのタブのピン留めを解除し、通常タブとしてタブツリーに移動する

### Requirement 2: 古いタブデータのクリーンアップ

**Objective:** ユーザーとして、ブラウザを再起動した際に、実在しないタブが残らないようにしたい。

#### Acceptance Criteria

1. When ブラウザ起動時, the 拡張機能 shall 現在開いているタブ一覧を取得し、ツリー状態と照合する
2. When ツリー内にブラウザに存在しないタブが検出された場合, the 拡張機能 shall そのタブをツリー状態から自動削除する
3. The 拡張機能 shall クリーンアップ処理をバックグラウンドで非同期実行する

### Requirement 3: 閉じるボタンの位置改善

**Objective:** ユーザーとして、タブの閉じるボタンが常にタブの右端に表示され、視覚的に一貫性を持たせたい。

#### Acceptance Criteria

1. When タブにホバーした場合, the 拡張機能 shall 閉じるボタンをタブの右端に固定表示する
2. The 拡張機能 shall 閉じるボタンの位置をタブタイトルの長さに関係なく右端に配置する
3. While タブにホバーしていない場合, the 拡張機能 shall 閉じるボタンを非表示にする

### Requirement 4: タブタイトルの正確な表示

**Objective:** ユーザーとして、タブのタイトルが常に正しく表示されるようにしたい。

#### Acceptance Criteria

1. When タブがロード完了した場合, the 拡張機能 shall タブのタイトルを最新の値で更新する
2. When タブのタイトルが変更された場合, the 拡張機能 shall 表示を即座に更新する
3. The 拡張機能 shall Vivaldi/Chromeの内部URL（chrome://vivaldi-webui/startpage等）に対して「新しいタブ」と表示する
4. While タブがLoading状態の場合, the 拡張機能 shall 「Loading...」と表示する

### Requirement 5: タブタイトルの永続化

**Objective:** ユーザーとして、ブラウザ再起動後もタブタイトルが保持され、すぐに識別できるようにしたい。

#### Acceptance Criteria

1. When タブのタイトルが確定した場合, the 拡張機能 shall タイトルをストレージに永続化する
2. When ブラウザ起動時, the 拡張機能 shall 永続化されたタイトルを復元して表示する
3. When タブが再読み込みされ新しいタイトルが取得された場合, the 拡張機能 shall 永続化データを上書きする
4. The 拡張機能 shall タブが閉じられた際に該当タブのタイトルデータを削除する

### Requirement 6: 新規ウィンドウドロップエリアの削除

**Objective:** ユーザーとして、邪魔な「ここにドロップして新しいウィンドウで開く」領域を表示させたくない。

#### Acceptance Criteria

1. The 拡張機能 shall 「ここにドロップして新しいウィンドウで開く」の専用領域を表示しない
2. When タブがツリービュー外にドロップされた場合, the 拡張機能 shall そのタブを新しいウィンドウで開く

### Requirement 7: ドラッグ時のスクロール制御

**Objective:** ユーザーとして、タブをドラッグ中に過度なスクロールが発生しないようにしたい。

#### Acceptance Criteria

1. While タブをドラッグ中, the 拡張機能 shall スクロール可能範囲を実際のコンテンツ範囲内に制限する
2. The 拡張機能 shall 本来のスクロール可能量を超えるスクロールを防止する

### Requirement 8: ドロップ判定領域の改善

**Objective:** ユーザーとして、タブ間の隙間にドロップして兄弟要素として配置しやすくしたい。

#### Acceptance Criteria

1. The 拡張機能 shall タブの上下の一定領域（例：上部25%、下部25%）を兄弟要素挿入用のドロップゾーンとする
2. The 拡張機能 shall タブの中央領域（例：中央50%）を子要素追加用のドロップゾーンとする
3. When タブの上部ドロップゾーンにドロップした場合, the 拡張機能 shall ドラッグ中のタブをその上に兄弟として挿入する
4. When タブの下部ドロップゾーンにドロップした場合, the 拡張機能 shall ドラッグ中のタブをその下に兄弟として挿入する

### Requirement 9: スクロールバーの改善

**Objective:** ユーザーとして、スクロールバーの表示でUIがガタつかず、ダークモードにも対応したい。

#### Acceptance Criteria

1. The 拡張機能 shall スクロールバーの表示/非表示でレイアウトがシフトしないようにする
2. The 拡張機能 shall スクロールバーのスタイルをダークモードに対応させる
3. The 拡張機能 shall スクロールバーにオーバーレイスタイルを適用し、コンテンツ幅に影響を与えないようにする

### Requirement 10: タブグループの仕様変更

**Objective:** ユーザーとして、タブグループが独立した領域ではなく、ツリー内の親タブとして機能するようにしたい。

#### Acceptance Criteria

1. The 拡張機能 shall 「Groups」という独立したセクションを表示しない
2. When タブグループが作成された場合, the 拡張機能 shall グループ用の専用親タブをツリー内に作成する
3. The 拡張機能 shall グループ内のタブをその親タブの子要素として表示する

### Requirement 11: テキスト選択の無効化

**Objective:** ユーザーとして、タブ操作時に意図しないテキスト選択が発生しないようにしたい。

#### Acceptance Criteria

1. The 拡張機能 shall タブ要素内のテキスト選択を無効化する
2. The 拡張機能 shall コンテキストメニュー内のテキスト選択を無効化する
3. While Shift+クリックで複数タブを選択中, the 拡張機能 shall テキスト選択が発生しないようにする

### Requirement 12: 複数タブのグループ化機能

**Objective:** ユーザーとして、複数選択したタブを一括でグループ化したい。

#### Acceptance Criteria

1. When 複数タブが選択されている状態でコンテキストメニューの「グループ化」を選択した場合, the 拡張機能 shall 新しいグループ親タブを作成する
2. When グループ化が実行された場合, the 拡張機能 shall 選択されたすべてのタブを新しいグループの子要素として移動する
3. The 拡張機能 shall グループ化後に親子関係を正しくツリーに反映する

### Requirement 13: 起動時の未読バッジ制御

**Objective:** ユーザーとして、ブラウザ起動時に既存タブに未読バッジが表示されないようにしたい。

#### Acceptance Criteria

1. When ブラウザ起動時, the 拡張機能 shall 既存のすべてのタブに未読バッジを表示しない
2. When ブラウザ起動後に新しいタブが開かれた場合, the 拡張機能 shall そのタブに未読バッジを表示する
3. The 拡張機能 shall 起動完了後に開かれたタブを「新規タブ」として識別する

### Requirement 14: ドラッグ中のタブサイズ安定化

**Objective:** ユーザーとして、タブをドラッグ中に他のタブのサイズが変わらないようにしたい。

#### Acceptance Criteria

1. While タブをドラッグ中, the 拡張機能 shall 他のタブの表示サイズを一定に保つ
2. While タブをドラッグ中に他のタブにホバーした場合, the 拡張機能 shall そのタブのサイズを変更しない
3. The 拡張機能 shall ドラッグ開始時のタブレイアウトを維持する

### Requirement 15: ビュー切り替えの修正

**Objective:** ユーザーとして、ビューを切り替えた際に正しいビューにタブが追加されるようにしたい。

#### Acceptance Criteria

1. When ビューを切り替えた後に新しいタブを開いた場合, the 拡張機能 shall 現在アクティブなビューにタブを追加する
2. When ビューを追加した場合, the 拡張機能 shall そのビューを永続化する
3. The 拡張機能 shall ビューの切り替え状態を正しく管理し、ビューが意図せず消えないようにする

### Requirement 16: ビューのスクロール切り替え

**Objective:** ユーザーとして、ビューリスト上でマウススクロールでビューを切り替えたい。

#### Acceptance Criteria

1. When ビューリストのファビコン上でマウスホイールを上にスクロールした場合, the 拡張機能 shall 前のビューに切り替える
2. When ビューリストのファビコン上でマウスホイールを下にスクロールした場合, the 拡張機能 shall 次のビューに切り替える
3. The 拡張機能 shall 最初/最後のビューでループせずに停止する

### Requirement 17: ビューのタブ数表示

**Objective:** ユーザーとして、各ビューに含まれるタブ数を一目で確認したい。

#### Acceptance Criteria

1. The 拡張機能 shall 各ビューのファビコン上にタブ数を小さく表示する
2. The 拡張機能 shall ファビコンのサイズを維持したままタブ数を表示する
3. When ビュー内のタブ数が変化した場合, the 拡張機能 shall 表示を即座に更新する

### Requirement 18: コンテキストメニューからビュー移動

**Objective:** ユーザーとして、タブを右クリックメニューから別のビューに移動したい。

#### Acceptance Criteria

1. When タブを右クリックした場合, the 拡張機能 shall コンテキストメニューに「別のビューへ移動」サブメニューを表示する
2. The 拡張機能 shall サブメニュー内に全ビューをリスト表示する（現在のビューを除く）
3. When サブメニューからビューを選択した場合, the 拡張機能 shall 選択中のタブ（複数選択含む）をそのビューに移動する

### Requirement 19: ビューのカスタムアイコン

**Objective:** ユーザーとして、ビューにURL由来のファビコンだけでなく、あらかじめ用意されたアイコンを設定したい。

#### Acceptance Criteria

1. The 拡張機能 shall ライセンス上問題のないアイコンセットを同梱する
2. When ビューのアイコンを編集する際, the 拡張機能 shall アイコン選択UIを表示する
3. The 拡張機能 shall 複数のカテゴリ別アイコン（仕事、趣味、SNS、開発など）を提供する
4. When カスタムアイコンが選択された場合, the 拡張機能 shall そのアイコンをビューに適用し永続化する

### Requirement 20: 設定ボタンの配置変更

**Objective:** ユーザーとして、ツリービューのサイドパネルをシンプルに保ち、設定へのアクセスは拡張機能ポップアップから行いたい。

#### Acceptance Criteria

1. The 拡張機能 shall ツリービューのサイドパネルに設定ボタンを表示しない
2. When ブラウザツールバーの拡張機能アイコンをクリックした場合, the 拡張機能 shall ポップアップメニューを表示する
3. The 拡張機能 shall ポップアップメニューに「設定を開く」ボタンを配置する
4. When 「設定を開く」ボタンをクリックした場合, the 拡張機能 shall 設定ページ（Options Page）を開く

### Requirement 21: ポップアップメニューからのスナップショット取得

**Objective:** ユーザーとして、拡張機能ポップアップからスナップショットを取得したい。

#### Acceptance Criteria

1. The 拡張機能 shall ポップアップメニューに「スナップショットを取得」ボタンを配置する
2. When 「スナップショットを取得」ボタンをクリックした場合, the 拡張機能 shall 現在のタブツリー状態のスナップショットを取得する
3. When スナップショット取得が完了した場合, the 拡張機能 shall ユーザーに完了を通知する
