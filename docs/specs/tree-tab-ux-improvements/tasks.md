# Implementation Plan

## Task Overview

| Category | Tasks | Sub-tasks |
|----------|-------|-----------|
| Core Infrastructure | 3 | 8 |
| UI Components | 6 | 17 |
| Integration & Testing | 2 | 5 |
| 追加実装 | 1 | 2 |
| **Total** | **12** | **32** |

## Requirements Coverage

| Requirement | Task(s) |
|-------------|---------|
| 1 (ピン留めタブ動作改善) | 2.1, 2.2 |
| 2 (古いタブデータクリーンアップ) | 1.1 |
| 3 (閉じるボタン位置改善) | 4.1 |
| 4 (タブタイトル表示改善) | 4.2 |
| 5 (タブタイトル永続化) | 1.2 |
| 6 (新規ウィンドウドロップエリア削除) | 5.1 |
| 7 (ドラッグ時スクロール制御) | 5.2 |
| 8 (ドロップ判定領域改善) | 5.3 |
| 9 (スクロールバー改善) | 4.3 |
| 10 (タブグループ仕様変更) | 6.1 |
| 11 (テキスト選択無効化) | 4.4 |
| 12 (複数タブグループ化) | 6.2 |
| 13 (起動時未読バッジ制御) | 1.3 |
| 14 (ドラッグ中タブサイズ安定化) | 5.4 |
| 15 (ビュー切り替え修正) | 3.1 |
| 16 (ビュースクロール切り替え) | 3.2 |
| 17 (ビュータブ数表示) | 3.3 |
| 18 (コンテキストメニューからビュー移動) | 7.1, 7.2, **12.1, 12.2** |
| 19 (ビューカスタムアイコン) | 8.1, 8.2 |
| 20 (設定ボタン配置変更) | 9.1, 9.2 |
| 21 (ポップアップからスナップショット) | 9.3 |

---

## Tasks

- [ ] 1. バックグラウンドサービス基盤の拡張
- [x] 1.1 (P) 古いタブデータのクリーンアップ機能を追加
  - ブラウザ起動時に現在開いているタブ一覧を取得し、ツリー状態と照合する
  - ツリー内にブラウザに存在しないタブが検出された場合、そのタブをツリー状態から自動削除する
  - クリーンアップ処理をバックグラウンドで非同期実行する
  - TreeStateManagerにcleanupStaleNodesメソッドを追加
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 1.2 (P) タブタイトル永続化サービスを実装
  - タブのタイトルが確定した際にストレージに永続化する
  - ブラウザ起動時に永続化されたタイトルを復元して表示する
  - タブが再読み込みされ新しいタイトルが取得された場合、永続化データを上書きする
  - タブが閉じられた際に該当タブのタイトルデータを削除する
  - タイトル保存はデバウンス（300ms）でストレージ書き込み頻度を制限
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 1.3 (P) 起動時の未読バッジ制御機能を追加
  - ブラウザ起動時に既存のすべてのタブに未読バッジを表示しない
  - ブラウザ起動後に新しいタブが開かれた場合にそのタブに未読バッジを表示する
  - 起動完了後に開かれたタブを「新規タブ」として識別する
  - UnreadTrackerに起動完了フラグ管理を追加
  - _Requirements: 13.1, 13.2, 13.3_

- [ ] 2. ピン留めタブ機能の改善
- [x] 2.1 ピン留めタブの表示と操作を改善
  - ピン留めタブエリアのタブに閉じるボタンを表示しない
  - ピン留めタブをタブツリー一覧に表示しない（ピン留めエリアのみに表示する）
  - ピン留めタブに対する閉じる操作を無効化する
  - ブラウザAPIによりピン留めタブが閉じられた場合、ピン留めエリアからも該当タブを削除する
  - ピン留めタブの状態をブラウザのタブ状態と常に同期する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.2 ピン留め解除コンテキストメニューを追加
  - ピン留めタブを右クリックした場合、コンテキストメニューに「ピン留めを解除」オプションを表示する
  - 「ピン留めを解除」を選択した場合、そのタブのピン留めを解除し、通常タブとしてタブツリーに移動する
  - _Requirements: 1.6, 1.7_

- [ ] 3. ビュー機能の改善
- [x] 3.1 ビュー切り替え動作を修正
  - ビューを切り替えた後に新しいタブを開いた場合、現在アクティブなビューにタブを追加する
  - ビューを追加した場合、そのビューを永続化する
  - ビューの切り替え状態を正しく管理し、ビューが意図せず消えないようにする
  - _Requirements: 15.1, 15.2, 15.3_

- [x] 3.2 (P) ビューのスクロール切り替え機能を追加
  - ビューリストのファビコン上でマウスホイールを上にスクロールした場合、前のビューに切り替える
  - ビューリストのファビコン上でマウスホイールを下にスクロールした場合、次のビューに切り替える
  - 最初/最後のビューでループせずに停止する
  - ViewSwitcherにonWheelハンドラを追加
  - _Requirements: 16.1, 16.2, 16.3_

- [x] 3.3 (P) ビューのタブ数表示機能を追加
  - 各ビューのファビコン上にタブ数を小さく表示する
  - ファビコンのサイズを維持したままタブ数を表示する
  - ビュー内のタブ数が変化した場合、表示を即座に更新する
  - TreeStateProviderでビューごとのタブ数を計算しメモ化する
  - _Requirements: 17.1, 17.2, 17.3_

- [ ] 4. タブ表示UIの改善
- [x] 4.1 (P) 閉じるボタンの位置を改善
  - タブにホバーした場合、閉じるボタンをタブの右端に固定表示する
  - 閉じるボタンの位置をタブタイトルの長さに関係なく右端に配置する
  - タブにホバーしていない場合、閉じるボタンを非表示にする
  - TreeNodeコンポーネントのCSS（justify-end）を調整
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 4.2 (P) タブタイトルの表示を改善
  - タブがロード完了した場合、タブのタイトルを最新の値で更新する
  - タブのタイトルが変更された場合、表示を即座に更新する
  - Vivaldi/Chromeの内部URL（chrome://vivaldi-webui/startpage等）に対して「新しいタブ」と表示する
  - タブがLoading状態の場合、「Loading...」と表示する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 4.3 (P) スクロールバーのスタイルを改善
  - スクロールバーの表示/非表示でレイアウトがシフトしないようにする
  - スクロールバーのスタイルをダークモードに対応させる
  - スクロールバーにオーバーレイスタイルを適用し、コンテンツ幅に影響を与えないようにする
  - TabTreeViewのCSSを調整
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 4.4 (P) テキスト選択を無効化
  - タブ要素内のテキスト選択を無効化する
  - コンテキストメニュー内のテキスト選択を無効化する
  - Shift+クリックで複数タブを選択中、テキスト選択が発生しないようにする
  - user-select: noneをTreeNode、ContextMenuに適用
  - _Requirements: 11.1, 11.2, 11.3_

- [ ] 5. ドラッグ&ドロップ機能の改善
- [x] 5.1 新規ウィンドウドロップエリアを削除
  - 「ここにドロップして新しいウィンドウで開く」の専用領域を表示しない
  - タブがツリービュー外にドロップされた場合、そのタブを新しいウィンドウで開く
  - ExternalDropZoneコンポーネントを削除
  - 関連するE2Eテストも削除
  - _Requirements: 6.1, 6.2_

- [x] 5.2 (P) ドラッグ時のスクロール制御を改善
  - タブをドラッグ中、スクロール可能範囲を実際のコンテンツ範囲内に制限する
  - 本来のスクロール可能量を超えるスクロールを防止する
  - TabTreeViewのスクロールロジックを調整
  - _Requirements: 7.1, 7.2_

- [x] 5.3 (P) ドロップ判定領域を改善
  - タブの上下の一定領域（上部25%、下部25%）を兄弟要素挿入用のドロップゾーンとする
  - タブの中央領域（中央50%）を子要素追加用のドロップゾーンとする
  - タブの上部ドロップゾーンにドロップした場合、ドラッグ中のタブをその上に兄弟として挿入する
  - タブの下部ドロップゾーンにドロップした場合、ドラッグ中のタブをその下に兄弟として挿入する
  - GapDropDetectionロジックを追加または改善
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 5.4 (P) ドラッグ中のタブサイズを安定化
  - タブをドラッグ中、他のタブの表示サイズを一定に保つ
  - タブをドラッグ中に他のタブにホバーした場合、そのタブのサイズを変更しない
  - ドラッグ開始時のタブレイアウトを維持する
  - TreeNodeのCSS調整
  - _Requirements: 14.1, 14.2, 14.3_

- [ ] 6. タブグループ機能の改善
- [x] 6.1 タブグループをツリー内で統合表示
  - 「Groups」という独立したセクションを表示しない
  - タブグループが作成された場合、グループ用の専用親タブをツリー内に作成する
  - グループ内のタブをその親タブの子要素として表示する
  - _Requirements: 10.1, 10.2, 10.3_

- [x] 6.2 複数タブのグループ化機能を追加
  - 複数タブが選択されている状態でコンテキストメニューの「グループ化」を選択した場合、新しいグループ親タブを作成する
  - グループ化が実行された場合、選択されたすべてのタブを新しいグループの子要素として移動する
  - グループ化後に親子関係を正しくツリーに反映する
  - useMenuActionsにcreateGroupアクションを追加
  - _Requirements: 12.1, 12.2, 12.3_

- [ ] 7. サブメニュー対応のコンテキストメニュー拡張
- [x] 7.1 汎用サブメニューコンポーネントを作成
  - 親メニュー項目ホバーで子メニューを表示する
  - 画面端での位置自動調整を行う
  - キーボードナビゲーションに対応する
  - SubMenuコンポーネントを新規作成
  - _Requirements: 18.1, 18.2_

- [x] 7.2 ビュー移動サブメニューを実装
  - タブを右クリックした場合、コンテキストメニューに「別のビューへ移動」サブメニューを表示する
  - サブメニュー内に全ビューをリスト表示する（現在のビューを除く）
  - サブメニューからビューを選択した場合、選択中のタブ（複数選択含む）をそのビューに移動する
  - ContextMenuにSubMenuを統合
  - _Requirements: 18.1, 18.2, 18.3_

- [ ] 8. カスタムアイコン機能の実装
- [x] 8.1 アイコンピッカーコンポーネントを作成
  - ライセンス上問題のないアイコンセット（lucide-react）を使用する
  - カテゴリ別アイコングリッド表示を行う
  - 選択アイコンのプレビューを表示する
  - IconPickerコンポーネントを新規作成
  - _Requirements: 19.1, 19.2, 19.3_

- [x] 8.2 ビュー編集にカスタムアイコン選択を統合
  - ビューのアイコンを編集する際、アイコン選択UIを表示する
  - 複数のカテゴリ別アイコン（仕事、趣味、SNS、開発など）を提供する
  - カスタムアイコンが選択された場合、そのアイコンをビューに適用し永続化する
  - ViewEditModalにIconPickerを統合
  - _Requirements: 19.1, 19.2, 19.3, 19.4_

- [ ] 9. ポップアップメニューの実装
- [x] 9.1 サイドパネルから設定ボタンを削除
  - ツリービューのサイドパネルに設定ボタンを表示しない
  - 既存のSettingsButtonコンポーネントをサイドパネルから削除
  - _Requirements: 20.1_

- [x] 9.2 ポップアップメニューを新規作成
  - ブラウザツールバーの拡張機能アイコンをクリックした場合、ポップアップメニューを表示する
  - ポップアップメニューに「設定を開く」ボタンを配置する
  - 「設定を開く」ボタンをクリックした場合、設定ページ（Options Page）を開く
  - manifest.jsonにaction.default_popupを追加
  - PopupMenuコンポーネントを新規作成
  - _Requirements: 20.2, 20.3, 20.4_

- [x] 9.3 スナップショット取得ボタンを追加
  - ポップアップメニューに「スナップショットを取得」ボタンを配置する
  - 「スナップショットを取得」ボタンをクリックした場合、現在のタブツリー状態のスナップショットを取得する
  - スナップショット取得が完了した場合、ユーザーに完了を通知する
  - SnapshotManagerと連携
  - _Requirements: 21.1, 21.2, 21.3_

- [ ] 10. 統合テストとE2Eテストの追加
- [x] 10.1 既存E2Eテストの確認と修正
  - ExternalDropZone削除に伴う関連テストの削除
  - SettingsButton削除に伴う関連テストの更新
  - ピン留めタブ、ビュー機能の変更に伴うテストの修正
  - グループセクション（groups.spec.ts）を削除（要件10でGroupsセクションが廃止されたため）
  - ピン留めタブとツリービューの統合テストを要件に合わせて修正（要件1.2の実装完了後に有効化）
  - common-constants.tsから不要なグループ関連セレクタを削除
  - _Requirements: 1.1, 6.1, 20.1_

- [x] 10.2 新機能のE2Eテストを追加
  - ピン留めタブの閉じるボタン非表示確認
  - ビュースクロール切り替えテスト
  - ポップアップメニューテスト（設定ページ表示、スナップショット取得）
  - サブメニュー操作テスト
  - _Requirements: 1.1, 16.1, 20.2, 21.1, 18.1_

- [ ] 11. 最終統合と検証
- [x] 11.1 全機能の統合テスト
  - 全コンポーネント間の連携を確認
  - ツリー状態の永続化と復元を検証
  - ビュー機能と新機能の統合を確認
  - _Requirements: 1.1, 2.1, 5.1, 15.1_

- [x] 11.2 型チェックとリントの確認
  - npm run type-checkがエラーなしで通過すること
  - npm run lintがエラーなしで通過すること
  - anyの使用がないことを確認
  - _Requirements: 全要件_

- [x] 11.3 全テストスイートの実行
  - npm testが全テスト通過すること
  - npm run test:e2eが全テスト通過すること
  - フレーキーテストがないことを確認（repeat-each=10）
  - _Requirements: 全要件_

---

## 追加タスク: 要件18の未完了部分

- [x] 12. 「別のビューへ移動」サブメニュー機能の完成
- [x] 12.1 SidePanelRootからTabTreeViewへのビュー情報受け渡しを実装
  - SidePanelRootでTreeStateProviderからviews（ビューリスト）とmoveTabsToView（移動関数）を取得する
  - TabTreeViewにviewsとonMoveToViewプロパティを渡す
  - 現在のビュー以外のビューをフィルタリングしてContextMenuに渡す
  - _Requirements: 18.1, 18.2, 18.3_

- [x] 12.2 ビュー移動サブメニューのE2Eテストを有効化
  - スキップされている「サブメニュー操作 - 別のビューへ移動」テストを有効化する
  - 「別のビューへ移動」にホバーするとサブメニューが表示されることを確認
  - サブメニューからビューを選択するとタブがそのビューに移動することを確認
  - 現在のビューはサブメニューに表示されないことを確認
  - _Requirements: 18.1, 18.2, 18.3_
