# Requirements Document

## Introduction

本仕様は、Vivaldi-TT拡張機能の動作確認で発見された14件の問題を修正するためのバグ修正・UI改善プロジェクトです。対象領域はテスト品質、UIスタイリング、ドラッグ＆ドロップ操作、複数ウィンドウ対応、および各種機能の正常動作回復です。

## Project Description (Input)
現状の拡張機能をインストールして動作確認をしてみました。
以下の点が気になるのでそれらを修正するタスクを作ってください。

## テストが全部実行されていない
スキップされているテストを修正してください。
Headedでしか動かないe2eテスト以外はスキップしてはいけません。

## タブツリーの背景色がデフォルトで無彩色でない
タブツリーの背景色がダークブルーではなくデフォルトで無彩色にするべきです。
余計な色味は必要ないです。

## 現在のタブの周りの枠線が邪魔
現在のタブが薄い青曰くで囲まれるが、これは目立ちすぎるため、もっと控えめにするべき。枠線は必要ない。

## 複数ウィンドウ間での
複数ウィンドウでの扱いについて要件通りに実装しなさい。

## ブラウザを開いたときに生まれるLoadingの消せないタブ
ブラウザを新しく開いたときに、Loadingのまま消せないタブが生まれています。
対応するタブがChromeに存在しないゴースト状態の拡張機能にだけタブが登録されてブラウザ側にはすでに存在しないタブが残っていないか調べなさい。
そのようなタブはブラウザを開いた際にタブツリーから削除するコードを実装するべきです。
修正しなさい。

## ブラウザを新しく開いて復元されたタブに未読インジケーターが付いている
未読インジケータはブラウザを開いて復元されたタブには付けないように修正しなさい。

## タブにホバーしたときの閉じるボタンが右端ではない
タブにホバーしたときに出てくる閉じるボタンがタイトルの直後なので、タイトルが短い場合は閉じるボタンが真ん中あたりになってしまう。
これは使い勝手が著しく悪い。
タイトルの長さによらず、閉じるボタンはタブの右端に表示されるように修正しなさい。

## ホバー時にホバーされたタブの大きさが変わりガクガクする
タブにホバーしたときにホバーされている領域が変わってホバー状態が切り替わりまくることでガタガタとちらつきます。
ホバーされる側のタブはスタイルが変わっても大きさが変わらないようにしなさい。

## タブの隙間にドロップする当たり判定がおかしい
タブの隙間にドロップするための当たり判定が完全に間違っています。
タブの隙間ドロップのプレースホルダーが全てのタブの後ろに表示されていたり、タブとタブの間にドロップできないようになっています。
修正しなさい。

## タブに重ねて親子関係を作るドロップ時にタブツリーのタブのあった隙間が広がる
タブをドラッグしたときにはタブツリーのタブは大きさが変わらないべきです。

## ピン留めされたタブがタブツリーにも表示されてしまっている
ピン留めされたタブはタブツリーの通常タブからは非表示にして、上のピン留めタブのファビコンだけのところに表示するようにするべきです。

## 設定を開くボタンを押しても設定画面が開かない
設定を開くボタンを拡張機能のポップアップメニューからクリックしても設定画面が開きません。
修正しなさい。

## タブをドラッグして左右に持っていくとタブツリー自体が左右にスクロールしてしまう
タブツリーは左右にスクロールしてはいけません。

## タブをタブツリーから外にドラッグしても新しいウィンドウが開かない
タブツリーからタブを外にドラッグしたときに新しいウィンドウが開くように修正しなさい。

## 複数ウィンドウの動作が要件と異なる
複数ウィンドウ開いたらそのウィンドウ内に開かれているタブだけをタブツリーに表示するべきです。
全てのウィンドウで同じタブツリーが開かれているのは要件を明らかに満たしていません。

## Requirements

### Requirement 1: テスト品質改善
**Objective:** As a 開発者, I want スキップされているテストが全て実行される状態にする, so that コード品質が保証され、リグレッションを検出できる

#### Acceptance Criteria
1. When テストスイートを実行した時, the 拡張機能 shall Headedモードでのみ動作するE2Eテスト以外の全テストを実行する
2. The 拡張機能 shall スキップ状態のテストを修正または削除して、意図的なスキップをなくす
3. If テストがスキップされている場合, then the 開発者 shall そのテストを修正するか、UIが削除された場合はテスト自体を削除する

### Requirement 2: タブツリー背景色の無彩色化
**Objective:** As a ユーザー, I want タブツリーの背景色がデフォルトで無彩色である, so that 余計な色味がなく視覚的にニュートラルなUIになる

#### Acceptance Criteria
1. The 拡張機能 shall タブツリーの背景色をデフォルトで無彩色（グレー系）に設定する
2. The 拡張機能 shall ダークブルーなどの有彩色をデフォルト背景色として使用しない

### Requirement 3: アクティブタブの枠線削除
**Objective:** As a ユーザー, I want 現在のタブが控えめに表示される, so that アクティブタブの視認性が適度に保たれつつ目立ちすぎない

#### Acceptance Criteria
1. The 拡張機能 shall アクティブタブの周囲に青色の枠線を表示しない
2. The 拡張機能 shall アクティブタブを背景色の変化など控えめな方法で識別可能にする

### Requirement 4: ゴーストタブの自動削除
**Objective:** As a ユーザー, I want ブラウザ起動時にゴーストタブが自動的に削除される, so that 消せないLoadingタブが残らない

#### Acceptance Criteria
1. When ブラウザを起動した時, the 拡張機能 shall Chrome APIに存在しないタブをタブツリーから削除する
2. When 拡張機能が初期化された時, the 拡張機能 shall ツリー内の全タブIDをChrome APIで検証し、存在しないタブを除去する
3. The 拡張機能 shall ゴーストタブ（Loadingのまま消せないタブ）を発生させない

### Requirement 5: 復元タブの未読インジケーター非表示
**Objective:** As a ユーザー, I want ブラウザ復元時のタブに未読インジケーターが付かない, so that 既読/未読の状態が正確に反映される

#### Acceptance Criteria
1. When ブラウザを起動してタブが復元された時, the 拡張機能 shall 復元されたタブに未読インジケーターを付けない
2. When 新規タブが開かれた時, the 拡張機能 shall 新規タブにのみ未読インジケーターを付ける

### Requirement 6: 閉じるボタンの右端固定
**Objective:** As a ユーザー, I want タブホバー時の閉じるボタンが常にタブの右端に表示される, so that タイトルの長さに関係なく一貫した位置でタブを閉じられる

#### Acceptance Criteria
1. When タブにマウスをホバーした時, the 拡張機能 shall 閉じるボタンをタブの右端に表示する
2. The 拡張機能 shall タイトルの長さに関わらず閉じるボタンの位置を右端に固定する

### Requirement 7: ホバー時のサイズ安定化
**Objective:** As a ユーザー, I want タブにホバーしてもタブサイズが変わらない, so that ホバー状態のちらつきが発生しない

#### Acceptance Criteria
1. When タブにマウスをホバーした時, the 拡張機能 shall タブ要素のサイズを変更しない
2. The 拡張機能 shall ホバー状態の変化によるガタつき・ちらつきを防止する

### Requirement 8: ドロップ判定の修正
**Objective:** As a ユーザー, I want タブをドラッグして正しい位置にドロップできる, so that タブの並び替えや親子関係の構築が意図通りに行える

#### Acceptance Criteria
1. When タブをドラッグしてタブとタブの隙間にドロップした時, the 拡張機能 shall その位置にタブを挿入する
2. The 拡張機能 shall ドロップのプレースホルダーを正しい挿入位置に表示する
3. The 拡張機能 shall タブとタブの間へのドロップを正しく受け付ける

### Requirement 9: ドラッグ中のタブサイズ固定
**Objective:** As a ユーザー, I want ドラッグ中にタブツリーのレイアウトが変わらない, so that ドロップ位置を正確に判断できる

#### Acceptance Criteria
1. While タブをドラッグしている間, the 拡張機能 shall タブツリー内の他のタブのサイズを変更しない
2. While タブをドラッグしている間, the 拡張機能 shall 親子関係を作るドロップでも隙間が広がらないようにする

### Requirement 10: ピン留めタブの表示分離
**Objective:** As a ユーザー, I want ピン留めタブが通常タブツリーに表示されない, so that ピン留めタブは専用セクションでのみ管理できる

#### Acceptance Criteria
1. The 拡張機能 shall ピン留めされたタブを通常のタブツリーから非表示にする
2. The 拡張機能 shall ピン留めタブを上部のピン留めセクションにファビコンのみで表示する

### Requirement 11: 設定画面の起動修正
**Objective:** As a ユーザー, I want 設定ボタンをクリックして設定画面を開ける, so that 拡張機能の設定を変更できる

#### Acceptance Criteria
1. When ポップアップメニューの設定ボタンをクリックした時, the 拡張機能 shall 設定画面（Options Page）を開く
2. The 拡張機能 shall chrome.runtime.openOptionsPage()を正しく呼び出す

### Requirement 12: 水平スクロールの禁止
**Objective:** As a ユーザー, I want タブツリーが左右にスクロールしない, so that 横方向のドラッグでレイアウトが崩れない

#### Acceptance Criteria
1. While タブをドラッグして左右に移動した時, the 拡張機能 shall タブツリーコンテナを水平方向にスクロールしない
2. The 拡張機能 shall タブツリーの水平スクロールを無効化する

### Requirement 13: ツリー外ドロップで新規ウィンドウ
**Objective:** As a ユーザー, I want タブをツリー外にドラッグして新しいウィンドウで開ける, so that タブを別ウィンドウに分離できる

#### Acceptance Criteria
1. When タブをタブツリーの外にドラッグ＆ドロップした時, the 拡張機能 shall そのタブを新しいウィンドウで開く
2. When 子タブを持つタブをツリー外にドロップした時, the 拡張機能 shall サブツリーごと新しいウィンドウに移動する

### Requirement 14: 複数ウィンドウ対応
**Objective:** As a ユーザー, I want 各ウィンドウでそのウィンドウのタブのみが表示される, so that ウィンドウごとに独立したタブツリーを管理できる

#### Acceptance Criteria
1. When 複数のブラウザウィンドウを開いた時, the 拡張機能 shall 各ウィンドウのタブツリーにそのウィンドウのタブのみを表示する
2. The 拡張機能 shall 全ウィンドウで同じタブツリーを共有しない
3. When 新しいウィンドウを開いた時, the 拡張機能 shall そのウィンドウ専用のタブツリーを表示する
