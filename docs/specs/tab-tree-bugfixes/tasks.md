# Implementation Plan

## Task Overview

本タスクリストは、Vivaldi-TT拡張機能の14件のバグ修正・UI改善を実装するための作業項目です。

---

## Tasks

- [ ] 1. テスト品質改善
- [x] 1.1 (P) スキップされているテストの修正・削除
  - スキップ状態のE2Eテストファイルを特定し、実行可能な状態に修正する
  - Headedモード専用テスト（明示的な理由があるもの）以外のスキップを解除する
  - 削除されたUIに関連するテストは完全に削除する（`test.skip()`でコードを残さない）
  - ViewSwitching.integration.test.tsxなど不要なテストを削除する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 2. UIスタイリング修正
- [x] 2.1 (P) タブツリー背景色の無彩色化
  - Tailwind CSS設定でgrayパレットをneutralで上書きする
  - ビルド後にダークブルーではなく無彩色が適用されることを確認する
  - _Requirements: 2.1, 2.2_

- [x] 2.2 (P) アクティブタブの枠線削除と控えめな表示
  - 現在のタブを囲む青色の枠線（ring-2 ring-blue-400）を削除する
  - 背景色の変化など控えめな方法でアクティブタブを識別可能にする
  - _Requirements: 3.1, 3.2_

- [x] 2.3 (P) 閉じるボタンの右端固定とホバー時サイズ安定化
  - タブホバー時の閉じるボタンを常にタブの右端に表示する
  - タイトルの長さに関わらず閉じるボタン位置を固定する
  - ホバー状態の変化でタブサイズが変わらないようvisible/invisibleで制御する
  - ホバー状態の切り替わりによるガタつき・ちらつきを防止する
  - _Requirements: 6.1, 6.2, 7.1, 7.2_

- [x] 2.4 (P) タブツリーの水平スクロール禁止
  - タブツリーコンテナにoverflow-x-hiddenを適用する
  - ドラッグ時に左右にスクロールしないことを確認する
  - _Requirements: 12.1, 12.2_

- [ ] 3. ピン留めタブの表示分離
- [x] 3.1 ピン留めタブのツリー非表示と専用セクション表示
  - ピン留めされたタブを通常のタブツリーから除外する
  - ピン留めタブを上部セクションにファビコンのみで表示する
  - ピン留め状態の変更時にツリーとセクションが適切に更新されることを確認する
  - _Requirements: 10.1, 10.2_

- [ ] 4. ドラッグ＆ドロップ修正
- [x] 4.1 ドロップ判定ロジックの修正
  - タブとタブの隙間へのドロップを正しく検出する
  - ドロップのプレースホルダーを正しい挿入位置に表示する
  - 全タブの後ろにプレースホルダーが表示される問題を修正する
  - _Requirements: 8.1, 8.2, 8.3_

- [x] 4.2 ドラッグ中のタブサイズ固定
  - ドラッグ中に他のタブのサイズが変更されないようにする
  - 親子関係を作るドロップ時にも隙間が広がらないようにする
  - _Requirements: 9.1, 9.2_

- [x] 4.3 ツリー外ドロップで新規ウィンドウ作成
  - タブをタブツリー外にドロップした際に新しいウィンドウを開く
  - 子タブを持つタブの場合はサブツリーごと新しいウィンドウに移動する
  - Service Workerで新規ウィンドウ作成メッセージを処理する
  - _Requirements: 13.1, 13.2_

- [ ] 5. ゴーストタブと未読インジケーター修正
- [x] 5.1 ゴーストタブの自動削除
  - ブラウザ起動時にChrome APIに存在しないタブをツリーから削除する
  - 初期化時にツリー内の全タブIDをChrome APIで検証する
  - Loadingのまま消せないゴーストタブの発生を防止する
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 5.2 復元タブの未読インジケーター非表示
  - ブラウザ起動時に復元されたタブには未読インジケーターを付けない
  - 初期化完了後に開かれた新規タブにのみ未読インジケーターを付ける
  - UnreadTrackerの初期化順序を調整する
  - _Requirements: 5.1, 5.2_

- [ ] 6. 設定画面と複数ウィンドウ対応
- [x] 6.1 (P) 設定画面の起動修正
  - manifest.jsonにoptions_page設定を追加する
  - ポップアップメニューの設定ボタンからchrome.runtime.openOptionsPage()を呼び出す
  - 設定画面が正しく開くことを確認する
  - _Requirements: 11.1, 11.2_

- [x] 6.2 複数ウィンドウでのタブツリー表示分離
  - TreeStateProviderで現在のウィンドウIDを取得・保持する
  - タブ情報にwindowIdを含めてフィルタリングする
  - 各ウィンドウでそのウィンドウのタブのみを表示する
  - 新しいウィンドウを開いた際に専用のタブツリーが表示されることを確認する
  - _Requirements: 14.1, 14.2, 14.3_

- [ ] 7. 統合検証
- [x] 7.1 全体動作確認とE2Eテスト更新
  - 全修正項目の動作確認を行う
  - 既存E2Eテストが全てパスすることを確認する
  - 必要に応じてE2Eテストを修正・追加する
  - 型チェック（npm run type-check）がエラーなしで通過することを確認する
  - _Requirements: 1.1, 1.2, 1.3_

---

## Requirements Coverage

| Requirement | Task(s) |
|-------------|---------|
| 1.1, 1.2, 1.3 | 1.1, 7.1 |
| 2.1, 2.2 | 2.1 |
| 3.1, 3.2 | 2.2 |
| 4.1, 4.2, 4.3 | 5.1 |
| 5.1, 5.2 | 5.2 |
| 6.1, 6.2 | 2.3 |
| 7.1, 7.2 | 2.3 |
| 8.1, 8.2, 8.3 | 4.1 |
| 9.1, 9.2 | 4.2 |
| 10.1, 10.2 | 3.1 |
| 11.1, 11.2 | 6.1 |
| 12.1, 12.2 | 2.4 |
| 13.1, 13.2 | 4.3 |
| 14.1, 14.2, 14.3 | 6.2 |
