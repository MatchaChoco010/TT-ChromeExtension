# Requirements Document

## Project Description (Input)
次のようなツリー型のタブをマネージするサイドパネルを追加するChromiumの拡張機能を作りたい。
利用するブラウザはVivaldiを想定している。

- サイドパネルAPIを利用してサイドパネルにツリー型タブを表示
- タブをツリー型に多段にして管理できる
- ドラッグアンドドロップでタブをツリー状にできる
- タブをまとめてグループ化してツリーを構築できる
- グループページが存在する
- 未読タブのインジケータを作れる
- ツリー型タブのパネルの内部に複数切り替えられるタブツリーのルートのビュー切り替え作れる
- 別のウィンドウのタブにドラッグ・アンド・ドロップできる
- ドラッグアンドドロップのホバー時にブランチを展開したり
- サイドバーの外部にドラッグ・アンド・ドロップしたら新しいウィンドウを開いたり
- 折りたたまれた複数のタブを閉じようとしたときに警告をしたり
- マウスホバー時に閉じるボタンがタブに表示されるようにしたり
- 新しいタブの位置を調整できたり
- フォントサイズ変更やフォント自体の変更もできたり
- jsonで開いているタブをスナップショットを取れる
- 定期的にスナップショットを記録していける
- コンテキストメニューも装備している
- CSSをカスタムできる機能がある
- 拡張機能の開発中にホットリロードで挙動を確認できる

## Introduction
本ドキュメントは、Vivaldiブラウザ向けのツリー型タブ管理拡張機能(Vivaldi-TT)の要件を定義します。この拡張機能は、Chrome Side Panel APIを利用してタブをツリー構造で管理し、ドラッグ&ドロップによる直感的な操作、グループ化、スナップショット機能など、高度なタブ管理機能を提供します。

## Requirements

### Requirement 1: サイドパネル表示
**Objective:** ユーザーとして、サイドパネルでツリー型タブを視覚的に管理できるようにしたい。これにより、多数のタブを効率的に整理・把握できる。

#### Acceptance Criteria
1. When ユーザーが拡張機能をインストールする, the 拡張機能 shall Chrome Side Panel APIを使用してサイドパネルを登録する
2. When ユーザーがサイドパネルを開く, the サイドパネル shall 現在のウィンドウの全タブをツリー構造で表示する
3. The サイドパネル shall 各タブのファビコン、タイトル、階層レベルを表示する
4. When タブが開かれる or 閉じられる, the サイドパネル shall リアルタイムでタブリストを更新する
5. When ユーザーがサイドパネル内のタブをクリックする, the 拡張機能 shall 対応するタブをアクティブにする

### Requirement 2: ツリー構造管理
**Objective:** ユーザーとして、タブを多段階のツリー構造で整理したい。これにより、関連するタブをグループ化して視認性を向上させる。

#### Acceptance Criteria
1. The 拡張機能 shall タブの親子関係を管理し、多段階の階層構造を保持する
2. When ユーザーがタブから新しいタブを開く, the 拡張機能 shall 新しいタブを元のタブの子として配置する（設定に応じて）
3. When ユーザーが親タブを閉じる, the 拡張機能 shall 子タブの処理方法（昇格 or 一括閉じ）を設定に従って実行する
4. The サイドパネル shall インデントまたは視覚的な線を使用してツリーの階層を表現する
5. When ユーザーが折りたたみアイコンをクリックする, the サイドパネル shall 該当するブランチ配下の子タブを展開/折りたたみする

### Requirement 3: ドラッグ&ドロップ操作（パネル内）
**Objective:** ユーザーとして、ドラッグ&ドロップでタブの階層と順序を変更したい。これにより、素早くツリー構造を再編成できる。

#### Acceptance Criteria
1. When ユーザーがサイドパネル内でタブをドラッグする, the サイドパネル shall ドラッグ中のタブをハイライト表示する
2. When ユーザーがタブを別のタブの上でドロップする, the 拡張機能 shall ドロップ先のタブの子としてタブを移動する
3. When ユーザーがタブを別のタブの間でドロップする, the 拡張機能 shall 同じ階層レベルでタブの順序を変更する
4. When ユーザーがタブをドラッグ中に折りたたまれたブランチの上でホバーする and ホバー時間が閾値（例: 1秒）を超える, the サイドパネル shall 自動的にそのブランチを展開する
5. The サイドパネル shall ドラッグ中にドロップ可能な位置を視覚的に示す（例: ドロップラインの表示）

### Requirement 4: クロスウィンドウドラッグ&ドロップ
**Objective:** ユーザーとして、タブを別のウィンドウに移動したい。これにより、複数のウィンドウ間でタブを柔軟に管理できる。

#### Acceptance Criteria
1. When ユーザーがタブをサイドパネルから別のウィンドウのサイドパネルにドラッグする, the 拡張機能 shall タブを対象ウィンドウに移動する
2. When ユーザーがタブをサイドパネルの外部（メインブラウザエリア）にドロップする, the 拡張機能 shall 新しいウィンドウを作成し、そこにタブを移動する
3. When ユーザーが複数の子タブを持つ親タブを別のウィンドウにドラッグする, the 拡張機能 shall 親タブとそのサブツリー全体を移動する
4. The 拡張機能 shall クロスウィンドウ移動時にタブのツリー構造を維持する

### Requirement 5: グループ化とグループページ
**Objective:** ユーザーとして、複数のタブをグループとしてまとめたい。これにより、関連するタブセットを一つの単位として管理できる。

#### Acceptance Criteria
1. When ユーザーが複数のタブを選択してグループ化コマンドを実行する, the 拡張機能 shall 新しいグループページを作成し、選択されたタブをその配下に配置する
2. The グループページ shall カスタマイズ可能なタイトルと色を持つ
3. When ユーザーがグループページをクリックする, the サイドパネル shall グループの概要または特別なグループビューを表示する
4. When ユーザーがグループを折りたたむ, the サイドパネル shall グループ内のタブを非表示にする
5. When ユーザーがグループページを閉じる, the 拡張機能 shall グループ内のすべてのタブを閉じる前に確認を求める

### Requirement 6: ビュー切り替え
**Objective:** ユーザーとして、サイドパネル内で複数のタブツリービューを切り替えたい。これにより、異なるワークスペースやコンテキストを管理できる。

#### Acceptance Criteria
1. The 拡張機能 shall 複数の仮想的なタブツリールート（ビュー）を作成・管理できる機能を提供する
2. When ユーザーが新しいビューを作成する, the 拡張機能 shall 空のタブツリーを持つ新しいビューを初期化する
3. When ユーザーがビュー切り替えUIを操作する, the サイドパネル shall 選択されたビューに対応するタブツリーを表示する
4. The 拡張機能 shall 各ビューに名前と色を割り当てる機能を提供する
5. When ユーザーがタブを別のビューに移動する, the 拡張機能 shall タブを対象ビューのツリーに配置する

### Requirement 7: 未読タブインジケータ
**Objective:** ユーザーとして、まだ閲覧していないタブを識別したい。これにより、重要な未確認コンテンツを見逃さない。

#### Acceptance Criteria
1. When タブが新しく開かれる and ユーザーがそのタブをまだアクティブにしていない, the サイドパネル shall そのタブに未読インジケータ（例: バッジや色の変更）を表示する
2. When ユーザーがタブをアクティブにする, the 拡張機能 shall そのタブの未読インジケータを削除する
3. The ユーザー shall 設定で未読インジケータの表示/非表示を切り替えられる
4. The サイドパネル shall 未読タブの数をカウント表示する機能を提供する（オプション）

### Requirement 8: タブ閉じる操作と警告
**Objective:** ユーザーとして、誤って多数のタブを閉じることを防ぎたい。これにより、重要な作業を失うリスクを低減する。

#### Acceptance Criteria
1. When ユーザーがマウスをタブの上にホバーする, the サイドパネル shall そのタブに閉じるボタンを表示する
2. When ユーザーが閉じるボタンをクリックする, the 拡張機能 shall そのタブを閉じる
3. When ユーザーが折りたたまれたブランチを持つ親タブを閉じようとする, the 拡張機能 shall 配下のタブ数を示す確認ダイアログを表示する
4. If ユーザーが確認ダイアログで「OK」を選択する, then the 拡張機能 shall 親タブとそのすべての子タブを閉じる
5. The ユーザー shall 設定で警告の閾値（例: 3タブ以上）をカスタマイズできる

### Requirement 9: 新しいタブの位置調整
**Objective:** ユーザーとして、新しく開かれるタブの位置を制御したい。これにより、ワークフローに合わせてタブの配置を最適化できる。

#### Acceptance Criteria
1. The 拡張機能 shall 設定で新しいタブの挿入位置を選択できる機能を提供する（例: 現在のタブの隣、現在のタブの子、リストの最後）
2. When リンクから新しいタブが開かれる and 設定が「子として配置」である, the 拡張機能 shall 新しいタブを元のタブの子として配置する
3. When ユーザーが手動で新しいタブを開く and 設定が「リストの最後」である, the 拡張機能 shall 新しいタブを現在のビューのツリーの最後に配置する
4. The ユーザー shall 異なるタブ開き方（リンククリック、アドレスバー、など）に対して個別の位置ルールを設定できる

### Requirement 10: UI/UXカスタマイズ
**Objective:** ユーザーとして、サイドパネルの外観をカスタマイズしたい。これにより、個人の好みや視認性を向上させる。

#### Acceptance Criteria
1. The 拡張機能 shall 設定でフォントサイズを調整する機能を提供する（例: 小、中、大、カスタムpx値）
2. When ユーザーがフォントサイズを変更する, the サイドパネル shall すべてのタブアイテムのフォントサイズを更新する
3. The 拡張機能 shall 設定でフォントファミリーを選択する機能を提供する（例: システムフォント、カスタムフォント名）
4. The 拡張機能 shall カスタムCSSファイルをロードする機能を提供する
5. When ユーザーがカスタムCSSファイルを指定する, the サイドパネル shall そのCSSを適用してスタイルをオーバーライドする
6. The 拡張機能 shall カスタムCSSのエラーを検出し、ユーザーに通知する

### Requirement 11: スナップショット機能
**Objective:** ユーザーとして、現在のタブセッションを保存・復元したい。これにより、作業状態を保護し、後で再開できる。

#### Acceptance Criteria
1. When ユーザーがスナップショットコマンドを実行する, the 拡張機能 shall 現在開いているすべてのタブとそのツリー構造をJSON形式でエクスポートする
2. The JSONスナップショット shall タブのURL、タイトル、親子関係、グループ情報を含む
3. When ユーザーがスナップショットをインポートする, the 拡張機能 shall JSONから読み込んだタブとツリー構造を復元する
4. The 拡張機能 shall 定期的な自動スナップショット機能を提供する
5. When 自動スナップショットが有効である and 設定された間隔（例: 10分）が経過する, the 拡張機能 shall 自動的にスナップショットを保存する
6. The 拡張機能 shall 保存されたスナップショット履歴を管理し、古いスナップショットを削除する機能を提供する（例: 最新10件を保持）

### Requirement 12: コンテキストメニュー
**Objective:** ユーザーとして、右クリックメニューから素早くタブ操作を実行したい。これにより、効率的にタブを管理できる。

#### Acceptance Criteria
1. When ユーザーがサイドパネル内のタブを右クリックする, the サイドパネル shall コンテキストメニューを表示する
2. The コンテキストメニュー shall 以下の操作を含む: タブを閉じる、タブを複製、タブをピン留め、新しいウィンドウで開く、グループ化
3. When ユーザーがコンテキストメニューから操作を選択する, the 拡張機能 shall 対応するアクションを実行する
4. When 複数のタブが選択されている状態でコンテキストメニューを開く, the コンテキストメニュー shall 複数タブに対応する操作（例: 選択されたタブをすべて閉じる、グループ化）を表示する

### Requirement 13: 開発者向けホットリロード
**Objective:** 拡張機能開発者として、開発中にホットリロードで変更を確認したい。これにより、開発効率を向上させる。

#### Acceptance Criteria
1. The 拡張機能 shall 開発モードでホットリロード機能を有効にできる設定を提供する
2. When ソースファイルが変更される and ホットリロードが有効である, the 拡張機能 shall 自動的に拡張機能をリロードする
3. When ホットリロードが実行される, the 拡張機能 shall サイドパネルのUIを再初期化し、最新のコードを反映する
4. The 拡張機能 shall ホットリロード時にタブの状態（ツリー構造、開いているタブ）を可能な限り保持する
5. If ホットリロード中にエラーが発生する, then the 拡張機能 shall エラーメッセージをコンソールに出力する

### Requirement 14: Vivaldi互換性
**Objective:** ユーザーとして、Vivaldiブラウザで拡張機能が正常に動作することを保証したい。これにより、Vivaldiの機能と統合して使用できる。

#### Acceptance Criteria
1. The 拡張機能 shall Vivaldiブラウザの最新バージョンで動作する
2. The 拡張機能 shall VivaldiのタブAPIとChrome拡張機能APIの両方と互換性を持つ
3. When Vivaldi固有のタブプロパティが利用可能である, the 拡張機能 shall それらを活用してユーザー体験を向上させる
4. The 拡張機能 shall Vivaldiのテーマ設定と調和するデフォルトスタイルを提供する
5. If VivaldiのAPIが利用できない場合, then the 拡張機能 shall 標準のChrome拡張機能APIにフォールバックする
