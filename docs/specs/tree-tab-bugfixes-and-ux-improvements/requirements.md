# Requirements Document

## Project Description (Input)
現状のVivaldi Tree Tab拡張機能で発見された複数の問題を修正するタスク。以下の問題を修正する：

1. **E2Eテストのフレーキー問題**: 以下のテストが落ちている
   - [chromium] › e2e/tab-grouping.spec.ts:853:5 › タブグループ化機能 › 実タブグループ化機能（Task 16.6） › 単一タブをグループ化しても実タブのグループ親が作成される
   - [chromium] › e2e/tab-persistence.spec.ts:201:5 › Task 2.4: Tab Persistence › Requirement 1.3: タイトルの永続化更新 › タブ内でのページ遷移時にタイトルの永続化データが更新されること

2. **タブの並び替えが正しくない**: タブをドラッグして並び替えるとブラウザのタブは並び替わるが、拡張機能側のツリービューのタブが並び替わらない

3. **タブのグループ化が全く動いていない**: 右クリックのコンテキストメニューからのタブのグループ化が動いていない。グループ化したら選択中のタブの親タブが生成されて親タブの下に選択していたタブが子タブとして配置されるべき。親となるグループタブ用の拡張機能専用タブが生成されるコードが存在するか確認が必要

4. **別ウィンドウからタブをドラッグしてこれない**: 別のウィンドウでタブをドラッグして、新しいウィンドウのツリービューにマウスを重ねたら、その新しいウィンドウの方にドラッグ中のタブを移動すべき。現状では全てドラッグアウトと判定されて新しいウィンドウが開いてしまう

5. **ドラッグアウトしてタブが無くなったウィンドウは自動的に閉じるべき**: ドラッグアウトでタブを全て移動させたウィンドウが自動的に閉じない。何もタブがないウィンドウが残り続けてしまう

6. **ビューを追加しても新しいタブをそのビューに追加できない**: ビューを追加まではできるが、そのビューを開いた状態で新しいタブを開いてもそのビューが閉じてしまって元のビューに新しいタブが追加されてしまう

7. **設定タブの名前が「新しいタブ」になっている**: chrome-extension://xxx/settings.html のタブが「新しいタブ」という名前になっている。「設定」など適切な名前にすべき

8. **未読インジケーターの位置の調整**: 新しいタブの未読インジケーターの形と位置を変更する。右側の青丸から、タブに重ねる形で左下の角に小さい三角形の切り欠きを重ねるようにする

9. **ブラウザを開き直したときにファビコンが復元されない**: ブラウザを開き直したらタブをロードしていなくても永続化されていたファビコンが表示されるべき

10. **タブを複製すると子タブになってしまう**: 複製したタブは子タブではなく兄弟タブとしてツリー型タブの複製されるタブの1個下に表示されるべき

11. **ブラウザを開き直したときに復元されたタブに未読インジケータが付く**: ブラウザを開き直したときに復元されたタブには未読インジケーターをつけないべき

## Introduction

本仕様は、Vivaldi Tree Tab拡張機能で発見された11件のバグ修正およびUX改善を定義する。対象は、E2Eテストの安定性、ドラッグ&ドロップ操作、タブグループ化機能、ビュー管理、永続化処理、およびUI表示に関する問題である。

すべての機能修正についてE2Eテストでの検証を可能な限り実施し、今後のリグレッション検知を可能にする。また、E2Eテストのフレーキーさ排除と実行時間の最適化も本仕様の範囲に含める。

## Requirements

### Requirement 1: E2Eテストの安定性

**Objective:** 開発者として、E2Eテストが安定して通過すること、テスト結果に対する信頼性を確保したい

#### Acceptance Criteria
1. When `npm run test:e2e` を実行したとき, the Vivaldi Tree Tab拡張機能 shall 「単一タブをグループ化しても実タブのグループ親が作成される」テスト（tab-grouping.spec.ts:853）を安定して通過させる
2. When `npm run test:e2e` を実行したとき, the Vivaldi Tree Tab拡張機能 shall 「タブ内でのページ遷移時にタイトルの永続化データが更新されること」テスト（tab-persistence.spec.ts:201）を安定して通過させる
3. When 修正されたE2Eテストに対して `--repeat-each=10` を実行したとき, the テスト shall 10回連続で成功する
4. The E2Eテスト shall 固定時間待機（waitForTimeout）を使用せず、ポーリングベースの状態確定待機を使用する
5. When E2Eテストを実行したとき, the テスト shall 必要十分な短い時間で完了する（不必要に長いタイムアウト設定を避ける）

### Requirement 2: ドラッグによるタブ並び替え

**Objective:** ユーザーとして、ドラッグ&ドロップでタブを並び替えたときにツリービューの表示も正しく更新されること、直感的にタブを整理したい

#### Acceptance Criteria
1. When ユーザーがツリービュー内でタブをドラッグして別の位置にドロップしたとき, the ツリービュー shall ドロップした位置にタブを移動して表示を更新する
2. When ユーザーがドラッグ操作でタブを並び替えたとき, the ツリービュー shall ブラウザのタブ順序と同期した状態でタブを表示する
3. When タブの並び替えが完了したとき, the 拡張機能 shall 並び替え後の順序を永続化データに保存する

#### E2Eテスト要件
4. The タブ並び替え機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When タブ並び替えのE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 3: タブグループ化機能

**Objective:** ユーザーとして、コンテキストメニューからタブをグループ化できること、関連するタブを階層的に整理したい

#### Acceptance Criteria
1. When ユーザーがタブを選択してコンテキストメニューから「グループ化」を実行したとき, the 拡張機能 shall 新しいグループ親タブを生成する
2. When グループ親タブが生成されたとき, the 拡張機能 shall グループ親タブの下に選択されていたタブを子タブとして配置する
3. When グループ化が実行されたとき, the 拡張機能 shall グループ親タブ用の拡張機能専用ページ（chrome-extension://xxx/group.html）を開く
4. When 単一タブを選択してグループ化を実行したとき, the 拡張機能 shall その単一タブの親としてグループ親タブを生成する

#### E2Eテスト要件
5. The タブグループ化機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
6. When タブグループ化のE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 4: クロスウィンドウドラッグ

**Objective:** ユーザーとして、別のウィンドウからタブをドラッグしてきたときに現在のウィンドウに移動できること、ウィンドウ間でタブを効率的に移動したい

#### 実装方針
Service Workerを中継点として使用し、ウィンドウ間でドラッグ状態を共有する：
- ドラッグがツリー外に出た時点で、Service Workerにタブ情報（タイトル、ファビコン、タブID等）を送信
- 別ウィンドウのツリービューにマウスが入った際、Service Workerからドラッグ中のタブ情報を取得
- 取得した情報でドラッグプレビューを表示し、ドロップ位置を決定
- ドロップ実行時に`chrome.tabs.move`でタブを移動

#### Acceptance Criteria
1. When ユーザーがタブをドラッグしながら別のウィンドウのツリービューにマウスを重ねたとき, the 拡張機能 shall そのタブをドラッグ先のウィンドウに移動する
2. When クロスウィンドウドラッグが検出されたとき, the 拡張機能 shall 新しいウィンドウを開かずに既存のウィンドウにタブを移動する
3. When タブが別ウィンドウに移動されたとき, the 拡張機能 shall 移動元ウィンドウのツリービューからそのタブを削除し、移動先ウィンドウのツリービューに追加する

#### E2Eテスト要件
4. The クロスウィンドウドラッグ機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When クロスウィンドウドラッグのE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 5: 空ウィンドウの自動クローズ

**Objective:** ユーザーとして、全てのタブをドラッグアウトしたウィンドウが自動的に閉じること、不要なウィンドウが残らないようにしたい

#### Acceptance Criteria
1. When ドラッグアウトによりウィンドウ内のすべてのタブが移動されたとき, the 拡張機能 shall そのウィンドウを自動的に閉じる
2. While ウィンドウに表示可能なタブが存在しないとき, the 拡張機能 shall そのウィンドウを閉じる処理を実行する
3. If ウィンドウを閉じる際にエラーが発生した場合, the 拡張機能 shall エラーをログに記録し、ウィンドウを手動で閉じられる状態を維持する

#### E2Eテスト要件
4. The 空ウィンドウ自動クローズ機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When 空ウィンドウ自動クローズのE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 6: ビューへの新規タブ追加

**Objective:** ユーザーとして、ビューを開いた状態で新しいタブを開いたときにそのビューにタブが追加されること、ビュー機能を活用してタブを整理したい

#### 実装方針
現在ビューが閉じてしまう根本原因を特定してから修正を行う：
- まず既存コードを調査し、新規タブ作成時にビューが閉じる原因を特定する
- 原因特定後、適切な修正を実施する
- 対症療法的な修正ではなく、根本原因に対処する

#### Acceptance Criteria
1. While ビューが開かれている状態のとき, the 拡張機能 shall 新しく開いたタブをそのビューに追加する
2. When ビューを開いた状態で新しいタブを作成したとき, the 拡張機能 shall ビューを閉じずに維持する
3. When 新しいタブがビューに追加されたとき, the 拡張機能 shall そのタブをビューのツリー構造内に表示する

#### E2Eテスト要件
4. The ビューへの新規タブ追加機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When ビューへの新規タブ追加のE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 7: 設定タブの名前表示

**Objective:** ユーザーとして、設定ページのタブに適切な名前が表示されること、タブを識別しやすくしたい

#### Acceptance Criteria
1. When 設定ページ（chrome-extension://xxx/settings.html）が開かれたとき, the 拡張機能 shall タブのタイトルに「設定」と表示する
2. The 設定ページ shall 「新しいタブ」ではなく「設定」というタイトルを持つHTMLドキュメントを提供する

#### E2Eテスト要件
3. The 設定タブの名前表示機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
4. When 設定タブの名前表示のE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 8: 未読インジケーターのUI改善

**Objective:** ユーザーとして、未読タブを視覚的に識別しやすいUI、タブの状態を直感的に把握したい

#### Acceptance Criteria
1. When タブが未読状態のとき, the ツリービュー shall タブ要素の左下角に三角形の切り欠き形状で未読インジケーターを表示する
2. The 未読インジケーター shall タブ要素に重なる形で配置される
3. When タブが既読状態に変わったとき, the ツリービュー shall 未読インジケーターを非表示にする

#### E2Eテスト要件
4. The 未読インジケーターのUI表示機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When 未読インジケーターのE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 9: ファビコンの永続化復元

**Objective:** ユーザーとして、ブラウザを再起動したときに永続化されていたファビコンが表示されること、タブを視覚的に識別したい

#### Acceptance Criteria
1. When ブラウザを再起動してタブが復元されたとき, the 拡張機能 shall 永続化されていたファビコンを表示する
2. While タブがまだロードされていない状態のとき, the 拡張機能 shall 永続化データに保存されたファビコンを使用して表示する
3. When タブがロードされてファビコンが更新されたとき, the 拡張機能 shall 新しいファビコンで表示を更新する

#### E2Eテスト要件
4. The ファビコン永続化復元機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When ファビコン永続化復元のE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 10: タブ複製時の配置

**Objective:** ユーザーとして、タブを複製したときに兄弟タブとして配置されること、意図した階層構造を維持したい

#### Acceptance Criteria
1. When ユーザーがタブを複製したとき, the 拡張機能 shall 複製されたタブを元のタブの兄弟として配置する
2. When タブ複製が実行されたとき, the 拡張機能 shall 複製されたタブを元のタブの直下（1つ下の位置）に挿入する
3. When タブ複製が実行されたとき, the 拡張機能 shall 複製されたタブを子タブではなく同じ階層レベルに配置する

#### E2Eテスト要件
4. The タブ複製時の配置機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When タブ複製時の配置のE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 11: 復元タブの未読状態

**Objective:** ユーザーとして、ウィンドウを開き直したときに復元されたタブに未読インジケーターが付かないこと、本当の未読タブのみを識別したい

#### 実装方針
ウィンドウが開いたタイミングで既存タブを記録し、それ以降に追加されたタブのみを未読として扱う：
- ウィンドウが開いた時点で、そのウィンドウ内の既存タブIDを記録する
- 記録されたタブ = 復元タブ → 未読インジケーターを表示しない
- 記録後に`onCreated`で追加されるタブ = 新規タブ → 未読インジケーターを表示する
- 「一定時間後にリセット」ではなく、ウィンドウ初期化完了時点のタブリストをスナップショットとして取る方式

#### Acceptance Criteria
1. When ウィンドウを開き直してタブが復元されたとき, the 拡張機能 shall 復元されたタブに未読インジケーターを表示しない
2. When ウィンドウが開いたとき, the 拡張機能 shall そのタイミングで存在するタブを復元タブとして記録する
3. When ウィンドウ初期化後にユーザーが新しいタブを開いたとき, the 拡張機能 shall その新しいタブにのみ未読インジケーターを表示する

#### E2Eテスト要件
4. The 復元タブの未読状態機能 shall E2Eテストで検証可能であり、`--repeat-each=10`で10回連続成功すること
5. When 復元タブの未読状態のE2Eテストを実行したとき, the テスト shall ポーリングベースの状態確定待機を使用してフレーキーでないこと

### Requirement 12: E2Eテスト品質基準

**Objective:** 開発者として、すべてのE2Eテストがフレーキーでなく、最適な実行時間で完了すること、CI/CDパイプラインの信頼性を確保したい

#### Acceptance Criteria
1. The すべてのE2Eテスト shall 固定時間待機（waitForTimeout）を使用せず、ポーリングベースの状態確定待機（polling-utils.ts）を使用する
2. When 新規E2Eテストを追加したとき, the テスト shall `--repeat-each=10`で10回連続成功することを検証する
3. The E2Eテスト shall Chrome Background Throttling対策として、ドラッグ操作前にページをフォーカス状態にする
4. The E2Eテスト shall 必要十分な短い実行時間で完了し、不必要に長いタイムアウト設定を使用しない
5. When E2Eテストがタイムアウトする場合, the 開発者 shall タイムアウト値を増やすのではなく、根本原因を調査して修正する
6. The E2Eテスト shall 既存テストのコーディングパターンを踏襲し、`e2e/utils/`の共通ユーティリティを再利用する
7. The E2Eテスト shall `page.pause()`などのユーザー操作を待機するデバッグ機能を使用しない
