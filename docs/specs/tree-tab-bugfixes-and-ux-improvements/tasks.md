# Implementation Plan

## Tasks

### E2Eテスト安定性修正

- [ ] 1. E2Eテストの安定化とフレーキー排除
- [x] 1.1 タブグループ化テストの安定化
  - 「単一タブをグループ化しても実タブのグループ親が作成される」テストの失敗原因を調査
  - ポーリングベースの状態確定待機に修正（固定時間待機を排除）
  - タブグループ化後のツリー状態確定を`waitForCondition`または`waitForParentChildRelation`で待機
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 1.1, 1.3, 1.4, 1.5, 12.1, 12.2, 12.3, 12.6_

- [x] 1.2 (P) タブ永続化テストの安定化
  - 「タブ内でのページ遷移時にタイトルの永続化データが更新されること」テストの失敗原因を調査
  - ナビゲーション完了とタイトル更新の状態確定をポーリングで待機
  - 永続化データの更新反映をポーリングで確認
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 12.1, 12.2, 12.6_

### 機能修正

- [ ] 2. タブ並び替え機能の修正
- [x] 2.1 ドラッグによるタブ並び替えのツリービュー同期
  - ドラッグ&ドロップでタブを並び替えた際にツリービューが更新されない原因を調査
  - ブラウザタブ移動イベント（onMoved）発生時のツリー状態更新ロジックを確認
  - ツリー状態がブラウザタブ順序と同期するよう修正
  - 並び替え後の順序を永続化データに反映
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2.2 タブ並び替えE2Eテストの追加
  - タブ並び替え操作のE2Eテストを作成
  - ドラッグ&ドロップ後のツリービュー更新をポーリングで検証
  - ブラウザタブとツリービューの同期を確認
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 2.4, 2.5_

- [ ] 3. タブグループ化機能の修正
- [x] 3.1 コンテキストメニューからのグループ化の実装確認と修正
  - 右クリックメニューからのグループ化が動作しない原因を調査
  - CREATE_GROUPメッセージハンドラの実装を確認
  - グループ親タブ用の拡張機能専用ページ（group.html）のタブ作成ロジックを確認
  - グループ化実行時にグループ親タブを生成し、選択タブを子として配置
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 3.2 タブグループ化E2Eテストの追加
  - コンテキストメニューからのグループ化E2Eテストを作成
  - 複数タブ選択時のグループ化を検証
  - 単一タブのグループ化を検証
  - グループ親タブとして拡張機能専用ページが開かれることを確認
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 3.5, 3.6_

- [ ] 4. クロスウィンドウドラッグ機能の修正
- [x] 4.1 Service Worker中継方式でのクロスウィンドウドラッグ実装
  - ドラッグがツリー外に出たときにService Workerへタブ情報を送信する仕組みを実装
  - SET_DRAG_SESSION、GET_DRAG_SESSION、EXECUTE_CROSS_WINDOW_DROPメッセージを追加
  - 別ウィンドウのツリービューでマウスが入った際にドラッグ情報を取得
  - ドロップ実行時に`chrome.tabs.move`でタブを移動
  - 両ウィンドウのツリービューを更新
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4.2 クロスウィンドウドラッグE2Eテストの追加
  - 別ウィンドウへのタブドラッグ移動E2Eテストを作成
  - 新規ウィンドウが開かずに既存ウィンドウに移動することを検証
  - 移動元・移動先両方のツリービュー更新を確認
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 4.4, 4.5_

- [ ] 5. 空ウィンドウ自動クローズ機能の修正
- [x] 5.1 ドラッグアウト後の空ウィンドウ自動クローズ実装
  - ドラッグアウトによりウィンドウ内の全タブが移動された後の処理を調査
  - タブが0になったウィンドウを自動的に閉じるロジックを追加
  - エラー発生時のログ記録と手動クローズ可能状態の維持
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 5.2 空ウィンドウ自動クローズE2Eテストの追加
  - 全タブドラッグアウト後のウィンドウ自動クローズE2Eテストを作成
  - ウィンドウが自動的に閉じることを検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 5.4, 5.5_

- [ ] 6. ビューへの新規タブ追加機能の修正
- [x] 6.1 ビュー維持機能の原因調査と修正
  - ビューを開いた状態で新規タブを作成するとビューが閉じる原因を調査
  - タブ作成時のイベントハンドリングフローを確認
  - ビュー状態の管理・更新ロジックを確認
  - 根本原因に対処する修正を実施
  - 新規タブを現在開いているビューに追加
  - **調査結果**: Task 10.1（tab-tree-comprehensive-fix）で既に修正済み。TreeStateManager.persistStateで既存のcurrentViewIdを保持し、event-handlers.tsのgetCurrentViewId()でストレージから現在のビューIDを取得。E2Eテスト（view-new-tab.spec.ts）全6テストがパス。
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 6.2 ビューへの新規タブ追加E2Eテストの追加
  - ビューを開いた状態での新規タブ追加E2Eテストを作成
  - ビューが閉じずに維持されることを検証
  - 新規タブがビュー内に表示されることを確認
  - `--repeat-each=10`で10回連続成功を検証
  - **完了**: view-new-tab.spec.tsに6つのテストケースが実装済み。全テストがポーリングベース待機を使用し、--repeat-each=10で60テスト全パス。
  - _Requirements: 6.4, 6.5_

- [x] 7. (P) 設定タブの名前表示修正
  - settings.htmlの`<title>`タグは既に「Vivaldi-TT 設定」に設定済み
  - 設定ページを開いた際にタブタイトルが「設定」を含むことを確認
  - E2Eテストで設定タブのタイトル表示を検証（settings.spec.ts に2テスト追加）
  - `--repeat-each=10`で20テスト（2テスト x 10回）全パス
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 8. (P) 未読インジケーターのUI改善
- [x] 8.1 (P) 未読インジケーターの形状・位置変更
  - UnreadBadgeコンポーネントのスタイリングを変更
  - 右側の青丸から左下角の三角形切り欠きに変更
  - タブ要素に重なる形で配置
  - 既読状態への変化時に非表示化を確認
  - _Requirements: 8.1, 8.2, 8.3_

- [x] 8.2 未読インジケーターE2Eテストの追加
  - 未読インジケーターの表示・非表示E2Eテストを作成
  - 左下三角形の形状で表示されることを検証
  - 既読になったときに非表示になることを確認
  - `--repeat-each=10`で10回連続成功を検証（40テスト全パス）
  - _Requirements: 8.4, 8.5_

- [ ] 9. ファビコン永続化復元機能の修正
- [x] 9.1 ブラウザ再起動時のファビコン復元実装
  - 永続化されたファビコンデータの読み込みロジックを確認
  - ブラウザ起動時に永続化ファビコンを優先表示するよう修正
  - タブロード完了後は新しいファビコンで上書き
  - **完了**: TreeStateProvider.tsx の loadTabInfoMap で永続化ファビコンを読み込み、tab.favIconUrl || persistedFavicon で Chrome API のファビコンがない場合に永続化データを使用。ファビコン変更時は handleTabUpdated で永続化し、タブ閉鎖時は handleTabRemoved で永続化データを削除。E2Eテスト（favicon-restore.spec.ts）全9テスト × 10回 = 90テスト全パス。
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 9.2 ファビコン永続化復元E2Eテストの追加
  - ブラウザ再起動後のファビコン表示E2Eテストを作成
  - 永続化ファビコンが復元されることを検証
  - `--repeat-each=10`で10回連続成功を検証（30テスト全パス）
  - **完了**: favicon-restore.spec.ts に Requirement 9.4, 9.5 のテストケース3件を追加
    - サイドパネルリロード後もファビコンがストレージに保持されることを検証
    - ファビコン永続化の読み書きが正しく動作することを検証
    - タブを閉じた際にファビコンデータが自動クリーンアップされることを検証
  - _Requirements: 9.4, 9.5_

- [ ] 10. タブ複製時の配置修正
- [x] 10.1 複製タブの兄弟配置実装
  - タブ複製時に子タブになる原因を調査
  - 複製タブを元タブの兄弟として配置するよう修正
  - 複製タブを元タブの直下（1つ下の位置）に挿入
  - 同じ階層レベルを維持
  - **完了**: Task 4.2 (tab-tree-bugfix-2) で既に実装済み。pendingDuplicateSources Setを使用して複製元タブを登録し、handleTabCreatedで複製タブを元タブの兄弟として配置するロジックが実装されている。E2Eテスト（tab-duplicate.spec.ts）全3テスト × 10回 = 30テスト全パス。
  - _Requirements: 10.1, 10.2, 10.3_

- [x] 10.2 タブ複製配置E2Eテストの追加
  - タブ複製時の配置E2Eテストを作成
  - 複製タブが兄弟として配置されることを検証
  - 元タブの直下に挿入されることを確認
  - `--repeat-each=10`で10回連続成功を検証
  - **完了**: tab-duplicate.spec.ts に3つのテストケースが実装済み。全テストがポーリングベース待機を使用し、--repeat-each=10で30テスト全パス。
  - _Requirements: 10.4, 10.5_

- [ ] 11. 復元タブの未読状態修正
- [x] 11.1 セッション復元タブの未読除外実装
  - ウィンドウが開いた時点で既存タブIDを記録するロジックを追加
  - initialTabIdsByWindowマップを実装
  - onCreatedイベントで復元タブか新規タブかを判定
  - 復元タブには未読インジケーターを表示しない
  - 新規タブにのみ未読インジケーターを表示
  - **完了**: 既存の実装（UnreadTrackerのinitialLoadCompleteフラグ）がブラウザ起動時の復元タブに対して未読除外を実現している。E2Eテスト（restored-tab-unread.spec.ts）を追加し、5テストケースを実装。全テストがポーリングベース待機を使用し、--repeat-each=10で50テスト全パス。
  - _Requirements: 11.1, 11.2, 11.3_

- [x] 11.2 復元タブ未読状態E2Eテストの追加
  - ブラウザ再起動後の復元タブ未読状態E2Eテストを作成
  - 復元タブに未読インジケーターが付かないことを検証
  - 新規タブには未読インジケーターが付くことを確認
  - `--repeat-each=10`で10回連続成功を検証
  - **完了**: restored-tab-unread.spec.ts に5つのテストケースが実装済み（Task 11.1で追加）。全テストがポーリングベース待機を使用し、--repeat-each=10で50テスト全パス。
  - _Requirements: 11.4, 11.5_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3, 1.4, 1.5 | 1.1, 1.2 |
| 2.1, 2.2, 2.3, 2.4, 2.5 | 2.1, 2.2 |
| 3.1, 3.2, 3.3, 3.4, 3.5, 3.6 | 3.1, 3.2 |
| 4.1, 4.2, 4.3, 4.4, 4.5 | 4.1, 4.2 |
| 5.1, 5.2, 5.3, 5.4, 5.5 | 5.1, 5.2 |
| 6.1, 6.2, 6.3, 6.4, 6.5 | 6.1, 6.2 |
| 7.1, 7.2, 7.3, 7.4 | 7 |
| 8.1, 8.2, 8.3, 8.4, 8.5 | 8.1, 8.2 |
| 9.1, 9.2, 9.3, 9.4, 9.5 | 9.1, 9.2 |
| 10.1, 10.2, 10.3, 10.4, 10.5 | 10.1, 10.2 |
| 11.1, 11.2, 11.3, 11.4, 11.5 | 11.1, 11.2 |
| 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7 | 1.1, 1.2, 2.2, 3.2, 4.2, 5.2, 6.2, 7, 8.2, 9.2, 10.2, 11.2 |
