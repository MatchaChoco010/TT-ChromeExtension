# Implementation Plan

## Tasks

- [ ] 1. E2Eテストフレーキー問題の修正
- [x] 1.1 (P) ドロップインジケーター位置変化テストのポーリング化
  - プレースホルダー位置検証テストで固定時間待機を排除
  - インジケーターのY座標変化をポーリングで待機するユーティリティを実装
  - 前回位置と異なる値になるまで状態を監視
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 1.2 (P) マウス移動によるプレースホルダー移動テストのポーリング化
  - マウスを別の隙間に移動した際のプレースホルダー追従テストを安定化
  - DOM変化を待機するポーリングロジックを適用
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 1.2, 1.4_

- [x] 1.3 (P) タブタイトル永続化テストのポーリング化
  - ページ遷移時のタイトル更新テストで固定時間待機を排除
  - Service Workerのツリー状態を監視しタイトル変化をポーリングで検出
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 1.3, 1.4_

- [ ] 2. ビューのタブカウント正確性の実装
- [x] 2.1 不整合タブ削除時のタブカウント再計算機能
  - TreeStateProviderで不整合タブ削除時にviewTabCountsを再計算
  - 存在しないタブIDがツリーから削除された際にカウントを更新
  - ViewSwitcherが最新のカウント値を表示することを確認
  - _Requirements: 2.1, 2.3_

- [x] 2.2 タブカウント更新のE2Eテスト追加
  - 不整合タブ削除時のカウント再計算を検証するE2Eテスト
  - タブ追加・削除時のカウント即時更新を検証するE2Eテスト
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 2.2, 2.4, 2.5_

- [ ] 3. タブ間隙間へのドロップ正確性の実装
- [x] 3.1 Gapドロップ位置計算ロジックの修正
  - GapDropDetectionでドロップターゲット計算を正確に実装
  - プレースホルダーが示す位置にタブを配置するロジックを修正
  - 異なる深度の隙間へのドロップ時に正しい位置に配置
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 3.2 Gapドロップ精度のE2Eテスト追加
  - タブ間隙間へのドロップで正確な位置に配置されることを検証
  - 異なる深度の隙間へのドロップを検証
  - `--repeat-each=10`で10回連続成功する安定したテストを実装
  - _Requirements: 3.4, 3.5, 3.6_

- [ ] 4. ドラッグ中のタブサイズ安定性の実装
- [x] 4.1 ドラッグ中タブサイズ固定のCSS修正
  - 親子関係形成時にタブサイズが変化しないようCSS調整
  - ドラッグ操作中のタブノードサイズを一定に維持
  - ホバーターゲット変化時もサイズを固定
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4.2 ドラッグ中タブサイズ安定性のE2Eテスト追加
  - ドラッグ中のタブサイズが一定であることを検証
  - 親子関係形成時のサイズ安定性を検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 4.4, 4.5_

- [ ] 5. ドラッグ時スクロール制限の実装
- [x] 5.1 スクロール量制限ロジックの実装
  - TabTreeViewでドラッグ中のスクロール量をコンテンツ範囲内に制限
  - コンテンツがビューポートより小さい場合はスクロールを無効化
  - 最大スクロール量をコンテンツ末尾までに制限
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 5.2 スクロール制限のE2Eテスト追加
  - ドラッグ時のスクロール量が制限されていることを検証
  - コンテンツが小さい場合にスクロールしないことを検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 5.4, 5.5_

- [ ] 6. タブグループ化機能の実装
- [x] 6.1 コンテキストメニューからのグループ化機能
  - ContextMenuに「タブをグループ化」メニュー項目を追加
  - 新しい親タブ（グループノード）を生成するロジック実装
  - 選択タブを親タブの子として配置
  - デフォルト名「グループ」を設定
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 6.2 グループ化機能のE2Eテスト追加
  - コンテキストメニューからのグループ化操作を検証
  - 単一タブのグループ化、複数タブ選択時のグループ化を検証
  - グループ化後の親子関係を検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 6.5, 6.6, 6.7, 6.8_

- [ ] 7. クロスウィンドウタブドラッグの実装
- [x] 7.1 クロスウィンドウドラッグ検出とインジケーター表示
  - 別ウィンドウへのドラッグ時にドロップインジケーターを表示
  - CrossWindowDragHandlerでウィンドウ間ドラッグを検出
  - Service Workerとのメッセージングで状態同期
  - _Requirements: 7.1, 7.3_

- [x] 7.2 クロスウィンドウドロップ処理の実装
  - 別ウィンドウのツリービュー上でのドロップでタブを移動
  - chrome.tabs.moveでタブをドロップ先ウィンドウに移動
  - ツリー状態を両ウィンドウで同期
  - _Requirements: 7.2_

- [x] 7.3 クロスウィンドウドラッグのE2Eテスト追加
  - クロスウィンドウドラッグでのタブ移動を検証
  - ドロップ先ウィンドウでのインジケーター表示を検証
  - 移動後のタブがドロップ先ウィンドウに属することを検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 7.4, 7.5, 7.6_

- [ ] 8. 新規タブ追加ボタンの実装
- [x] 8.1 NewTabButtonコンポーネントの作成
  - タブツリー末尾にフルワイドの新規タブ追加ボタンを表示
  - クリック時にchrome.tabs.createで新規タブを作成
  - 新規タブを現在のビューに追加
  - 新規タブをアクティブにする
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 8.2 新規タブ追加ボタンのE2Eテスト追加
  - 新規タブ追加ボタンの存在を検証
  - ボタンクリックで新規タブが追加されることを検証
  - 新規タブがツリー末尾に配置されることを検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 8.5, 8.6, 8.7_

- [ ] 9. 新規タブのタイトル正確性の実装
- [x] 9.1 スタートページタイトル表示の修正
  - VivaldiのスタートページURLを判定するロジックを追加
  - スタートページ表示時に「スタートページ」とタイトル表示
  - ページ遷移後は新しいページのタイトルに更新
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 9.2 スタートページタイトルのE2Eテスト追加
  - 新規タブのタイトルが「スタートページ」であることを検証
  - ページ遷移後のタイトル更新を検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 9.4, 9.5_

- [ ] 10. ビューへの新規タブ追加の実装
- [x] 10.1 現在ビューへの新規タブ追加機能
  - ビューを開いている状態で新しいタブをそのビューに追加
  - 新規タブ追加後もViewSwitcherが現在のビューを維持
  - デフォルトビュー以外のビューでも新規タブが現在ビューに属する
  - _Requirements: 10.1, 10.2, 10.3_

- [x] 10.2 ビューへの新規タブ追加のE2Eテスト追加
  - カスタムビューを開いた状態での新規タブ追加を検証
  - 新規タブ追加後もビューが維持されることを検証
  - 新規タブが正しいビューに属することを検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 10.4, 10.5, 10.6_

- [x] 11. 未読インジケーター位置の修正
- [x] 11.1 未読インジケーター右端固定表示のCSS修正
  - UnreadBadgeをタブノードの右端に固定表示
  - タイトル長に関わらず一定位置に表示
  - CloseButtonとの共存レイアウトを調整
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [x] 11.2 未読インジケーター位置のE2Eテスト追加
  - 未読インジケーターがタブ右端に表示されることを検証
  - 短いタイトルと長いタイトルの両方で位置が一定であることを検証
  - `--repeat-each=10`で10回連続成功を検証
  - _Requirements: 11.5, 11.6_

- [ ] 12. ピン留めタブの並び替え同期の実装
- [x] 12.1 ピン留めタブ順序同期機能の修正
  - ブラウザでのピン留めタブ並び替えをツリービューに反映
  - chrome.tabs.onMovedイベントを監視して順序を同期
  - 任意の位置への移動で正しい順序を維持
  - _Requirements: 12.1, 12.2, 12.3, 12.4_

- [x] 12.2 ピン留めタブ順序同期のE2Eテスト追加
  - ピン留めタブの並び替え同期を包括的に検証
  - 3つ以上のピン留めタブで各位置への移動を検証
  - 1つ目、2つ目、3つ目のタブそれぞれの移動を個別に検証
  - `--repeat-each=10`で10回連続成功する安定したテストを実装
  - _Requirements: 12.5, 12.6, 12.7, 12.8_

- [ ] 13. ユニットテストのモック設定修正
- [x] 13.1 chrome.tabs.onMovedモック追加
  - TreeStateProviderで追加された`chrome.tabs.onMoved`リスナーに対応するモックを追加
  - `DragDropTreeIntegration.test.tsx`のbeforeEachにonMovedモックを追加
  - `PanelDragDropIntegration.test.tsx`のbeforeEachにonMovedモックを追加
  - `SidePanelRoot.test.tsx`のbeforeEachにonMovedモックを追加
  - _Requirements: 12.1, 12.2, 12.3, 12.4_

- [x] 13.2 ユニットテスト全件成功の確認
  - `npm test -- --run`を実行してすべてのユニットテストが成功することを確認
  - 失敗するテストがあれば原因を特定し修正
  - 全テスト成功まで修正を繰り返す
  - _Requirements: 1.4, 12.1, 12.2, 12.3, 12.4_

- [x] 13.3 E2Eテスト全件成功の確認
  - `npm run test:e2e`を実行してすべてのE2Eテストが成功することを確認
  - 失敗するテストがあれば原因を特定し修正
  - 全テスト成功まで修正を繰り返す
  - _Requirements: 1.1, 1.2, 1.3, 1.4_
