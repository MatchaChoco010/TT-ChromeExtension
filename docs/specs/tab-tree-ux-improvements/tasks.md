# Implementation Plan

## Task 1: TreeStateProviderの拡張（タブ情報・ピン留め・選択状態管理）

- [x] 1.1 (P) タブ情報（TabInfo）マップの管理機能を追加する
  - TreeStateProviderにtabInfoMapステートを追加し、tabIdをキーとしてタブのタイトル・ファビコンURL・ピン状態を保持する
  - chrome.tabs.queryで初期データをロードし、全タブの情報をマップに格納する
  - chrome.tabs.onUpdatedイベントを監視し、title・favIconUrl・pinned変更時にtabInfoMapを更新する
  - getTabInfo(tabId)ヘルパー関数を提供し、コンポーネントからタブ情報を取得可能にする
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 1.2 (P) ピン留めタブ専用リストの管理機能を追加する
  - tabInfoMapからピン留め状態のタブIDをフィルタリングしてpinnedTabIds配列を算出する
  - ピン留め状態の変更時（onUpdated）にpinnedTabIdsを自動更新する
  - ピン留めタブをツリー構造から除外し、専用セクションで表示可能にする
  - _Requirements: 12.1_

- [x] 1.3 (P) 複数選択状態の管理機能を追加する
  - selectedNodeIds（Set）とlastSelectedNodeIdステートを追加する
  - selectNode(nodeId, modifiers)関数を実装し、Shift/Ctrlキーに応じた選択ロジックを提供する
  - Shiftキー押下時は最後に選択したノードから現在のノードまでの範囲を選択する
  - Ctrlキー押下時は現在の選択状態にトグル追加/削除する
  - clearSelection()とisNodeSelected(nodeId)ヘルパー関数を提供する
  - _Requirements: 9.1, 9.2_

## Task 2: タブノード表示の改善

- [x] 2.1 SortableTreeNodeItemでタブ情報を表示する
  - TreeStateProviderからgetTabInfoを使用してタブのタイトルとファビコンURLを取得する
  - タブ名として内部IDではなくページタイトルを表示する
  - タブの左側にファビコンを表示し、取得できない場合はデフォルトアイコンを表示する
  - タブ情報がロード中の場合は「Loading...」プレースホルダーを表示する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 2.2 (P) タブにホバー時の閉じるボタンを実装する
  - タブアイテムにホバー状態を検知するイベントハンドラを追加する
  - ホバー時のみタブ右側に×ボタンを表示する
  - 閉じるボタンクリック時にchrome.tabs.removeを呼び出してタブを閉じる
  - ホバー解除時は閉じるボタンを非表示にする
  - _Requirements: 10.1, 10.2, 10.3_

- [x] 2.3 (P) 選択状態の視覚的フィードバックを実装する
  - isNodeSelected状態に応じてタブアイテムの背景色を変更する
  - 複数選択時は選択されたすべてのタブが視覚的に識別可能になる
  - クリックイベントにmodifiersを渡してselectNode関数を呼び出す
  - _Requirements: 9.1, 9.2_

## Task 3: ピン留めタブセクションの実装

- [x] 3.1 PinnedTabsSectionコンポーネントを作成する
  - ツリービュー上部にピン留めタブ専用セクションを配置する
  - ピン留めタブをファビコンサイズで横並びグリッド表示する
  - 各ピン留めタブにクリックでタブをアクティブ化する機能を実装する
  - ピン留めタブと通常タブの間に区切り線を表示する
  - ピン留めタブが0件の場合はセクション自体を非表示にする
  - _Requirements: 12.1, 12.2, 12.3, 12.4_

## Task 4: ドラッグ&ドロップの改善（ビジュアルフィードバックとdepth選択）

- [x] 4.1 DropIndicatorコンポーネントを作成する
  - ドロップ位置を示す水平線インジケーターを実装する
  - インデント幅に応じてインジケーターの左位置を計算し、depthを視覚化する
  - ドラッグ中のみ表示し、ドロップ後またはドラッグキャンセル時に非表示にする
  - 高速なマウス移動時のちらつきを防ぐためRequestAnimationFrameでスロットリングする
  - _Requirements: 7.2, 8.4, 16.4_

- [x] 4.2 ドラッグ中のdepth計算ロジックを実装する
  - useDndMonitorのonDragMoveイベントでマウスX座標を取得する
  - マウスX座標からドロップ先のdepthを計算するcalculateTargetDepth関数を実装する
  - depth範囲を0から隣接ノードのdepth+1までに制限する
  - マウス左右移動でdepthがリアルタイムに変化し、DropIndicatorに反映する
  - _Requirements: 8.3, 8.4, 8.5_

- [x] 4.3 タブとタブ間の隙間ドロップ判定を実装する
  - ドラッグ中のマウスY座標からタブ上か隙間上かを判定する
  - タブ上にホバー時はそのタブをハイライト表示する
  - 隙間上にホバー時はDropIndicatorをその位置に表示する
  - 当たり判定を使いやすい形で実装（タブ中央付近はタブ判定、端は隙間判定）
  - _Requirements: 7.1, 7.2, 7.3_

- [x] 4.4 ドラッグ中のタブ位置固定とドロップ時のツリー再構築を実装する
  - ドラッグ開始時にisDraggingフラグを立て、既存タブの表示位置を固定する
  - dnd-kitのリアルタイム並べ替え機能を無効化し、ドロップ位置のみインジケーターで表示する
  - ドロップ時にtargetIndexとtargetDepthを使用してツリー構造を再構築する
  - ドラッグ終了時にisDraggingをfalseにし、新しいツリー状態を反映する
  - _Requirements: 16.1, 16.2, 16.3, 16.4_

- [x] 4.5 ドラッグ中の横スクロール防止を実装する
  - isDraggingがtrueの間、ツリービューコンテナにoverflow-x: hiddenを適用する
  - ドラッグ終了時に通常のスクロール動作を復元する
  - マウスを左右に動かしてもビューが横スクロールしないことを確認する
  - _Requirements: 14.1, 14.2, 14.3_

- [x] 4.6 子タブの独立ドラッグ操作を実装する
  - 子タブをドラッグした際に親タブを追従させず、子タブのみ移動可能にする
  - ドロップ先の階層に応じて親子関係を再構築する
  - 子タブを親から切り離して別の位置にドロップ可能にする
  - _Requirements: 8.1, 8.2_

## Task 5: ツリービュー外ドロップによる新規ウィンドウ作成

- [x] 5.1 ExternalDropZoneコンポーネントを作成する
  - ツリービュー下部にドロップ可能エリアを配置する
  - ドラッグ中のみエリアをアクティブ化し、視覚的にドロップ可能であることを示す
  - ドラッグがエリア外に出た場合も新規ウィンドウ作成のドロップ先として扱う
  - _Requirements: 15.1_

- [x] 5.2 新規ウィンドウ作成機能を実装する
  - ツリービュー外へのドロップ時にchrome.windows.createで新規ウィンドウを作成する
  - ドラッグしたタブとその子タブ（サブツリー全体）を新規ウィンドウに移動する
  - タブグループをドロップした場合はグループ配下のすべてのタブを移動する
  - 新規ウィンドウでもツリー構造（親子関係）を維持する
  - _Requirements: 15.2, 15.3, 15.4, 15.5_

## Task 6: 複数選択対応コンテキストメニュー

- [x] 6.1 コンテキストメニューに複数選択操作オプションを追加する
  - 右クリック時に選択されたタブ数を表示する
  - 選択されたタブを一括で閉じるオプションを追加する
  - 選択されたタブをグループにまとめるオプションを追加する
  - _Requirements: 9.3, 9.4, 9.5_

- [x] 6.2 (P) コンテキストメニューにスナップショット取得オプションを追加する
  - ツリービュー内での右クリックメニューに「スナップショットを取得」を追加する
  - 選択時にSnapshotManagerを呼び出して現在のタブツリー状態を保存する
  - タブビュートップのスナップショットボタンを削除する
  - _Requirements: 4.1, 4.2, 4.3_

## Task 7: ビュー切り替えUIの改善

- [x] 7.1 ViewSwitcherをファビコンサイズアイコンボタンに改修する
  - 各ビューをファビコンサイズのアイコンボタンで表示する
  - ビューにアイコンが設定されていない場合はカラーサークルを表示する
  - 現在の鉛筆ボタンによるインライン編集UIを削除する
  - _Requirements: 3.1, 3.2, 3.5_

- [x] 7.2 (P) ビュー編集モーダルダイアログを実装する
  - ViewEditModalコンポーネントを作成し、ビュー名・色・アイコンの編集機能を提供する
  - モーダルオーバーレイで表示し、保存/キャンセル操作を実装する
  - _Requirements: 3.4_

- [x] 7.3 ビューボタンの右クリックコンテキストメニューを実装する
  - ビューボタンを右クリックした際にコンテキストメニューを表示する
  - メニューから「ビューの編集」を選択するとViewEditModalを開く
  - 「ビューの削除」オプションも提供する
  - _Requirements: 3.3, 3.4_

## Task 8: 設定画面の新規タブ表示

- [x] 8.1 設定画面用の新規エントリポイントを作成する
  - Vite設定にsettings.htmlのマルチエントリポイントを追加する
  - settings.htmlとsrc/settings/index.tsxを作成する
  - 既存のSettingsPanelコンポーネントを再利用してレイアウトする
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 8.2 設定画面を新規タブで開く機能を実装する
  - chrome.tabs.createを使用して設定画面をブラウザタブとして開く
  - サイドパネル内部での設定画面表示を削除または非活性化する
  - 拡張機能アイコンクリック時のメニューに設定画面を開くオプションを追加する
  - _Requirements: 5.1, 5.2, 5.4_

## Task 9: スナップショット自動保存設定

- [x] 9.1 設定画面にスナップショット自動保存セクションを追加する
  - 自動保存の有効/無効を切り替えるトグルスイッチを実装する
  - 自動保存の間隔（分単位）を設定する数値入力フィールドを追加する
  - 保持するスナップショットの最大数を設定するフィールドを追加する
  - 設定変更時にStorageServiceを通じて永続化する
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

- [x] 9.2 スナップショット自動保存バックグラウンド処理を実装する
  - Service Workerでchrome.alarms APIを使用して定期実行を設定する
  - 設定された間隔でSnapshotManagerのsaveSnapshot関数を呼び出す
  - 最大保持数を超えた古いスナップショットを自動削除する
  - 設定変更時にアラームを再設定する
  - _Requirements: 6.4, 6.5_

## Task 10: ダークテーマ統一とサイドパネルUI簡素化

- [x] 10.1 ダークテーマカラースキームを統一する
  - アクティブタブを黒系の色で少し明るくハイライト表示する
  - 白や青などの不統一な色を排除し、ダークカラーパレットで統一する
  - アクティブタブと非アクティブタブのコントラストを適切に調整する
  - すべてのUI要素（タブ、ビュー、ボタン、モーダル等）に統一配色を適用する
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [x] 10.2 (P) サイドパネルヘッダーを削除する
  - パネル上部の「Vivaldi-TT」ヘッダーを削除する
  - タブツリーの表示領域を最大化する
  - _Requirements: 13.1, 13.3_

## Task 11: タブグループの統合表示

- [x] 11.1 タブグループをツリービュー内に表示する
  - タブグループを通常のタブと同じツリービュー内に表示する
  - グループノードを展開可能な折りたたみ可能要素として実装する
  - グループの展開/折りたたみ状態を永続化する
  - _Requirements: 2.1, 2.3_

- [x] 11.2 タブグループのドラッグ&ドロップ操作を実装する
  - タブグループを通常のタブと同様にドラッグ可能にする
  - グループをドロップした際にグループ配下のタブも一緒に移動する
  - グループの階層関係を維持しながら位置変更を可能にする
  - _Requirements: 2.2_

## Task 12: E2Eテストの追加と既存テストの修正

- [x] 12.1 (P) ドラッグ&ドロップ改善のE2Eテストを追加する
  - 隙間へのドロップでインジケーターが正しく表示されることをテストする
  - マウスX座標変更でdepthが変化することをテストする
  - ドラッグ中に他のタブが移動しないことをテストする
  - ドラッグ中に横スクロールが発生しないことをテストする
  - _Requirements: 7.1, 7.2, 7.3, 8.3, 8.4, 8.5, 14.1, 14.2, 14.3, 16.1, 16.2, 16.3, 16.4_

- [x] 12.2 (P) 複数選択機能のE2Eテストを追加する
  - Shift+クリックで範囲選択ができることをテストする
  - Ctrl+クリックで追加選択/選択解除ができることをテストする
  - 複数選択時のコンテキストメニューオプションをテストする
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 12.3 (P) ピン留めタブセクションのE2Eテストを追加する
  - ピン留めタブが上部セクションに横並びで表示されることをテストする
  - ピン留めタブクリックでタブがアクティブ化することをテストする
  - ピン留めタブと通常タブの間に区切り線が表示されることをテストする
  - _Requirements: 12.1, 12.2, 12.3, 12.4_

- [x] 12.4 (P) 設定画面のE2Eテストを追加する
  - 設定画面が新規タブで開くことをテストする
  - スナップショット自動保存設定が保存・反映されることをテストする
  - _Requirements: 5.1, 5.2, 5.3, 6.1, 6.2, 6.3, 6.5_

- [x] 12.5 既存E2Eテストの確認と修正を行う
  - UI変更（ヘッダー削除、ビュー切り替えUI変更等）による影響を確認する
  - タブ表示形式の変更（タイトル・ファビコン表示）によるセレクタ修正を行う
  - 新しいドラッグ&ドロップ動作に合わせてテストシナリオを更新する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.5, 13.1, 13.3_
