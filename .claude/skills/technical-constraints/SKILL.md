---
name: technical-constraints
description: 技術的に実現不可能な機能の調査結果
---

# 技術的制約

このドキュメントは、過去に調査した結果、技術的に実現不可能と判明した機能についての記録である。新機能を検討する際に参照し、同じ調査を繰り返さないようにすること。

## サイドパネル外クリックの検出は不可能

**結論**: ブラウザ拡張機能のサイドパネルにおいて、「ページ内クリック」を検出することは技術的に不可能である。

**技術的理由**:
- サイドパネルとページコンテンツは完全に分離されたウィンドウコンテキストを持つ
- サイドパネルは独自の `window` オブジェクトを持ち、ページ内のイベントは伝播しない
- サイドパネルからページ内のイベントを監視する手段が存在しない

**検討した代替案と却下理由**:
1. **window.blur**: ページ内クリックではサイドパネルのblurイベントは発火しない
2. **chrome.tabs.onActivated**: 同じタブ内のクリックでは発火しない（タブ切り替えではない）
3. **content script を全ページに注入**: コストが機能の価値に見合わない
   - メモリ使用量の増加（全タブでスクリプト実行）
   - 過剰な権限要求（`<all_urls>`）によるセキュリティ・審査の問題
   - CSPとの競合、ページスクリプトとの干渉リスク
   - 単一機能のために全ページへの注入は過剰

**採用した設計**: サイドパネル内の空白クリックでのみ選択解除
- サイドパネル内のタブノード以外の領域（ViewSwitcher下、ツリービュー下の空白など）をクリックすると選択解除
- 実装: `SidePanelRoot.tsx` の onClick で `!target.closest('[data-tab-id]')` をチェック

**関連ファイル**: `src/sidepanel/components/SidePanelRoot.tsx`

---

## クロスウィンドウドラッグ&ドロップは実装不可能

**結論**: ブラウザ拡張機能において、ドラッグ&ドロップでウィンドウ間のタブ移動を実現することは技術的に不可能である。

**調査結果**:

1. **OSレベルのマウスキャプチャ**
   - ブラウザでドラッグ操作が開始されると、OSがマウスイベントをキャプチャする
   - ドラッグ中は別ウィンドウの`mouseenter`, `mouseover`, `mousemove`などのマウスイベントが一切発火しない
   - `pointerenter`, `pointermove`なども同様に発火しない
   - `setPointerCapture()`は`dragstart`後に呼び出しても機能しない

2. **HTML5 Drag and Drop APIの制限**
   - `dragenter`, `dragover`イベントは内部的には発火するが、Chrome拡張のサイドパネル間では検知できない
   - `dataTransfer`を使用した方法もサイドパネル間では機能しない

3. **`preventDefault()`の無効性**
   - `dragstart`イベントで`preventDefault()`を呼んでも、マウスボタンを押したまま移動するとOSレベルのドラッグが開始される
   - これはブラウザとOSの相互作用によるもので、JavaScript側で制御できない

4. **VSCode/Electronの事例**
   - VSCodeもウィンドウ間タブD&Dを完全には実装できていない
   - Electronアプリでこれを実現するには、Win32 API（Windows）やCocoa/AppKit（macOS）などのネイティブコードが必要
   - Chrome拡張機能はネイティブコードを実行できないため、この方法は使用不可能

**代替実装**:
- コンテキストメニューから「別のウィンドウに移動」を選択してタブを移動
- コンテキストメニューから「新しいウィンドウに移動」を選択して新規ウィンドウを作成

**参考資料**:
- Electron Issue: "Dragging tabs between windows" - ネイティブコード必須と結論
- MDN Web Docs: Drag and Drop API - イベントキャプチャの制限について記載
