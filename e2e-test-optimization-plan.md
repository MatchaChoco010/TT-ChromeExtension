# E2Eテスト最適化計画

## 目標

すべてのE2Eテストを1.2秒以内に完了させる

## 完了条件

全テストを並列実行し、hover-to-expandテスト（`drag-drop-hover.spec.ts`）以外の全テストが1.2秒以内に完了すること。
処理内容が非常に複雑な場合のみ1.5秒まで許容するが、本当に真に複雑な処理であることを慎重に確認すること。
たかだか複数回のクリックや入力、表示の切り替えなどで1.5秒以上かかるのは許容されない。

この条件を満たすまで調査・修正を繰り返す。

### 禁止事項

- 完了条件を満たす前に調査を止めてはならない
- 「複雑な処理だから妥当な時間だ」と勝手に判断してはならない
- ユーザーは全ての遅いテストを確認済みであり、このマシンのスペックを考慮すれば1.2秒以上かかるテストは存在しないと判断している
- 私が独自に「このテストは時間がかかっても仕方ない」と判断する余地はない

- e2eテストなのでユーザーの操作をシミュレートすることを回避してはいけない。
  - 例えばクリックの実行の代わりにclickイベントをdispatchして済ませるなどは許容されないし、これ例なのでこれに類する回避策も全て禁止される。

## 作業内容

テスト時間を短くするための根本原因調査と修正を行う。

### 調査方法

遅いテストは各関数呼び出しのステップごとにセグメントの実行時間を計測するログを入れて、どの処理が重たいのかを特定する。

調査と修正はファイル1つずつ実行する。
複数アフィるに修正してから後でまとめて動作時間を確認してはいけない。
ファイル1つずつ確実に修正を確認してから次に進むこと。

修正に当たっては、軽量化したことが確認できるまでは上記セグメント実行時間計測のログは消さずに、実行時間のログが各修正によってどこが変わったかを追跡し確認する。

### 計測時の必須ルール

- **テスト実行時間の計測は必ず全テスト並列実行で行うこと**
- 単独実行（`--grep`等）での計測は禁止
- ログ確認のための単独実行が必要な場合でも、最終的な時間検証は必ず並列実行で行うこと
- 並列実行時はリソース競合やCPU負荷が発生するため、単独実行とは異なる実行時間になる。この違いを無視してはならない

- テストの実行時は`npm run test:e2e 2>&1 | tee e2e-test.log`を使って全てのテストを並列に行ったうえでログをログファイルに残してから解析をすること


### 調査の手がかり（例示）

以下はチェックして終わりではなく、あくまで手がかり:
- リトライ使用（禁止）
- setTimeout使用（禁止、polling-utilsを使用すべき）
- マウス操作ステップの冗長性

根本原因を特定し、完了条件を満たすまで調査・修正を継続する。

### 常に読み込むドキュメント
定期的にステアリングドキュメントとe2e-test-optimization-plan.mdを読み直すことをタスクに追加する。
コンテキストがcompactされたあとであなたはe2e-test-optimization-plan.mdの内容を完全に忘れないため。
このタスクは全てのタスクが終わるまで常にin_progressとする。

## 作業完了後

- 調査用に追加したログ・検証コードを削除
- 最終計測結果のサマリーを作成

---
