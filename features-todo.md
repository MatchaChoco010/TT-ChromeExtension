# TODOリスト

- [ ] 全てのタスクを検証する
各タスク実行前にステアリングドキュメントとこのドキュメントを絶対に再度読み込み直す必要があります。
この指示には常に従いなさい。
このタスクは各タスクの全ての完了を確認するチェックボックスです。
全てのタスクが完了しテストが通ったらチェックをつけなさい。

- [ ] コンテキストメニューで最後のタブを移動したときの挙動が正しくない。
ウィンドウの最後のタブを新しいウィンドウに移動したときに、そのウィンドウが閉じられていません。

- [ ] 複数タブ選択した状態でのコンテキストメニューからのタブの複製が動作していない

- [ ] タブを休止した時の動作が不安定。
休止したタブがツリービューから見えなくなったりする。
休止したタブがかならずツリービューの同じ位置で休止されてツリービューに残っていることを確認するべき。

- [ ] 別の操作などをしたときにコンテキストメニューが閉じず開かれっぱなし。
コンテキストメニューの外をクリックしたときにコンテキストメニューが閉じる処理が正しく動作していない。
ツリービュー以外の領域であってもコンテキストメニューの外の領域をクリックしたときはいつでもコンテキストメニューが閉じられるべき。

- [ ] 手動で開かれたタブの位置が「現在タブの隣」の場合の挙動が正しくない
e2eテストを追加し、「現在タブの隣」の場合でちゃんと現在のタブの隣になるように修正する

- [ ] 警告閾値以上の数のタブを同時にコンテキストメニューのタブを閉じるを行っても警告が現れない。
タブの数ではなくdepthの数を誤って確認していないか確認する。
これもちゃんと正しくタブ数でチェックするe2eテストを作り、そのテストが落ちていたら実装の修正を行う。

- [ ] 警告閾値を0にするとタブを閉じるときに警告が出なくなるべき。
上記のシナリオもe2eテストのテストケースに加えて実装を追加するべき。

- [ ] ピン留めタブと通常タブのアクティブ状態のハイライトの排他が正しくない。
ピン留めタブがアクティブの場合、通常タブの以前アクティブだったタブのハイライトは消えるべき。

- [ ] 内部タブのファビコンが反映されない。拡張機能ページとかのファビコンが正しく表示されない。
拡張機能のエラーで次のようなエラーが出ていることに注意。
Not allowed to load local resource: chrome://favicon/size/16@2x/chrome://vivaldi-webui/startpage?section=calendar
Not allowed to load local resource: chrome://favicon/size/16@2x/chrome://extensions/
必要な権限が足りない場合権限を追加することを検討する。

- [ ] 複製されたタブの位置が元のタブの直後の状態で、タブツリーが閉じている孫タブを持つ最後の子タブを複製すると、複製位置が子タブの兄弟要素ではなく親タブの直後になってしまっている。

- [ ] ウィンドウを閉じて開き直したときにタブツリーの状態やビューの状態が保存されない。
ウィンドウを閉じて開き直すと、ウィンドウを閉じる前に作っていたタブツリーの階層関係が無くなってしまう。
ウィンドウを閉じて開き直すと、別のビューに移動していたタブが元のビューに戻ってしまう。
すでにこのシナリオに対するテストケースが存在しておりかつテストが通っている場合、テストの実装が間違っています。
正しくウィンドウを閉じて開き直してテストしてますか？
確認してテストを修正してテストが正しく落ちるようにしてから、その後実装を修正してテストを通るようにしなさい。

- [ ] ウィンドウを閉じて開き直した際にファビコンが復元されない
ウィンドウを閉じて開き直すと、ファビコンが復元されない。
永続化する機能が間違っている or 永続化から復元する機能が間違っている or 永続化から復元した後にタブが休止状態のため空のファビコンで上書きされている 可能性がある。
e2eテストが通っているのは、そもそも--disable-background-networkingでネットワーク環境のURLにアクセスできないためblankなファビコンしか手に入っていない可能性がある。
e2eテストについてローカルサーバーを使っている。
このローカルサーバーにファビコンを返すURLを追加し、そのうえでe2eテストが通るかどうかを確認する必要がある。
ローカルサーバーの?のURLパラメータの内容のハッシュ値を元にfavicon画像を返すようにして、同じURLでは同じfavicon画像が変えるけど、異なるURLでは異なるfavicon画像が返るようにする。
そのうえで、複数のURLで異なるファビコンのURLを開いたうえで、復元時にそのファビコンの内容が復元されているかを確認するe2eテストを書きなさい。
復元されたファビコンの画像の内容がテストで期待されるローカルサーバーが返す画像の内容と一致するかなどをチェックすることになるでしょう。
